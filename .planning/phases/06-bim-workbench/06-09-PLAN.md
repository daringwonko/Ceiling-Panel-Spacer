---
phase: 06-bim-workbench
plan: 09
type: execute
wave: 3
depends_on: ['06-04']
files_modified: [
  'src/components/BIMWorkbench/BIM3DObject.ts',
  'src/components/BIMWorkbench/BIM3DCanvas.tsx',
  'src/components/BIMWorkbench/WorkingPlaneSystem.ts',
  'src/components/BIMWorkbench/BIMObjectFactory.ts',
  'src/components/BIMWorkbench/SelectionVisualizer.ts',
  'src/components/BIMWorkbench/types/3d.ts'
]
autonomous: true
must_haves:
  truths:
    - BIM3DObject base class extends Three.js Object3D with BIM metadata
    - BIM3DCanvas renders 3D scene with orbit controls and working plane
    - Working plane system supports Top/Front/Side and custom planes
    - Object factory creates typed BIM objects with default properties
    - Selection visualization shows highlight, box, and transform gizmo
  artifacts:
    - path: 'src/components/BIMWorkbench/BIM3DObject.ts'
      provides: 'Base class for all 3D BIM objects'
      exports: ['BIM3DObject', 'BIMObjectMetadata']
    - path: 'src/components/BIMWorkbench/BIM3DCanvas.tsx'
      provides: '3D canvas component with Three.js integration'
      exports: ['BIM3DCanvas']
    - path: 'src/components/BIMWorkbench/WorkingPlaneSystem.ts'
      provides: 'Working plane management and visualization'
      exports: ['WorkingPlaneSystem', 'PlaneOrientation']
    - path: 'src/components/BIMWorkbench/BIMObjectFactory.ts'
      provides: 'Factory for creating BIM objects by type'
      exports: ['BIMObjectFactory']
    - path: 'src/components/BIMWorkbench/SelectionVisualizer.ts'
      provides: 'Selection highlighting and transform controls'
      exports: ['SelectionVisualizer']
  key_links:
    - from: 'BIM3DCanvas'
      to: 'BIM3DObject'
      via: 'scene.add()'
      pattern: 'BIM3DObject added to Three.js scene'
    - from: 'BIMObjectFactory'
      to: 'BIM3DObject'
      via: 'create() returns BIM3DObject'
      pattern: 'Factory creates and configures BIM3DObject instances'
    - from: 'WorkingPlaneSystem'
      to: 'BIM3DCanvas'
      via: 'plane helper added to scene'
      pattern: 'Working plane visual integrated into canvas'
---

<objective>
Create the foundation for 3D BIM object creation and management using Three.js.

Purpose: Establish the base architecture for 3D BIM object rendering, manipulation, and interaction within the BIM workbench.
Output: Core 3D system with base object class, canvas component, working plane system, object factory, and selection visualization.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/ThreeDEditor/ThreeDEditor.tsx
@src/components/ThreeDEditor/ThreeDCanvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BIM3DObject base class</name>
  <files>src/components/BIMWorkbench/BIM3DObject.ts, src/components/BIMWorkbench/types/3d.ts</files>
  <action>Create BIM3DObject class extending Three.js Object3D:

1. Define BIMObjectMetadata interface in types/3d.ts:
   - ifcType: string (e.g., 'IfcWall', 'IfcDoor')
   - material: string | Material reference
   - level: string (floor/level identifier)
   - id: string (unique identifier)
   - properties: Record&lt;string, any&gt; (custom BIM properties)

2. Create BIM3DObject class:
   ```typescript
   class BIM3DObject extends THREE.Object3D {
     metadata: BIMObjectMetadata;
     private _selected: boolean = false;
     private _originalMaterial: THREE.Material | null = null;
     
     constructor(metadata: BIMObjectMetadata);
     
     // Selection
     select(): void;
     deselect(): void;
     isSelected(): boolean;
     
     // Highlighting
     highlight(color?: THREE.Color): void;
     unhighlight(): void;
     
     // Serialization
     toJSON(): object;
     static fromJSON(data: object): BIM3DObject;
     
     // Update metadata
     updateMetadata(updates: Partial&lt;BIMObjectMetadata&gt;): void;
   }
   ```

3. Implement selection highlighting using emissive material or outline effect
4. Ensure proper cleanup on dispose()</action>
  <verify>TypeScript compiles without errors, class has all required methods</verify>
  <done>BIM3DObject class exists with IFC metadata, selection highlighting, and serialization</done>
</task>

<task type="auto">
  <name>Task 2: Create BIM3DCanvas component</name>
  <files>src/components/BIMWorkbench/BIM3DCanvas.tsx</files>
  <action>Create BIM3DCanvas React component using @react-three/fiber:

1. Component structure:
   ```typescript
   interface BIM3DCanvasProps {
     objects: BIM3DObject[];
     selectedIds: string[];
     workingPlane: WorkingPlane;
     gridSize?: number;
     gridDivisions?: number;
     onObjectSelect?: (id: string, multi: boolean) => void;
     onObjectDeselect?: (id: string) => void;
     onCanvasClick?: (point: THREE.Vector3) => void;
   }
   ```

2. Set up Canvas with:
   - Camera: PerspectiveCamera with sensible defaults
   - Lights: Ambient + Directional for good visibility
   - Background: #1a1a1a (dark theme)

3. Add OrbitControls from @react-three/drei:
   - Enable pan, zoom, rotate
   - Set max/min distance limits
   - Configurable target

4. Implement GridHelper:
   - Size based on working plane extent
   - Configurable divisions
   - Color: subtle gray (#333333)

5. Handle object selection:
   - Raycasting on click
   - Support Ctrl/Cmd multi-select
   - Call onObjectSelect/onObjectDeselect callbacks

6. Forward BIM3DObject instances to scene

Use @react-three/fiber for React-Three.js integration.</action>
  <verify>Component renders without errors, orbit controls work, objects display</verify>
  <done>BIM3DCanvas renders 3D scene with controls, grid, and object selection</done>
</task>

<task type="auto">
  <name>Task 3: Implement working plane system</name>
  <files>src/components/BIMWorkbench/WorkingPlaneSystem.ts, src/components/BIMWorkbench/types/3d.ts</files>
  <action>Create working plane management system:

1. Define types in types/3d.ts:
   ```typescript
   type PlaneOrientation = 'top' | 'front' | 'side' | 'custom';
   
   interface WorkingPlane {
     orientation: PlaneOrientation;
     normal: THREE.Vector3;
     constant: number; // Plane equation: ax + by + cz + d = 0
     origin: THREE.Vector3;
     visible: boolean;
     size: number;
   }
   ```

2. Create WorkingPlaneSystem class:
   ```typescript
   class WorkingPlaneSystem {
     private _plane: WorkingPlane;
     private _helper: THREE.PlaneHelper | null;
     
     constructor();
     
     // Preset planes
     setTopPlane(origin?: THREE.Vector3): void;      // XY plane, Z = 0
     setFrontPlane(origin?: THREE.Vector3): void;    // XZ plane, Y = 0  
     setSidePlane(origin?: THREE.Vector3): void;     // YZ plane, X = 0
     setCustomPlane(normal: THREE.Vector3, origin: THREE.Vector3): void;
     
     // Get current plane
     getPlane(): THREE.Plane;
     getWorkingPlane(): WorkingPlane;
     
     // Visualization
     createHelper(scene: THREE.Scene): void;
     removeHelper(): void;
     updateHelper(): void;
     
     // Projection
     projectPoint(point: THREE.Vector3): THREE.Vector3;
     projectOntoPlane(point: THREE.Vector3): THREE.Vector3;
     
     // Intersection
     rayIntersect(raycaster: THREE.Raycaster): THREE.Vector3 | null;
   }
   ```

3. Implement plane helper visualization using Three.js PlaneHelper
4. Add methods to project points onto working plane for object placement</action>
  <verify>All plane orientations work, projection methods return correct values</verify>
  <done>WorkingPlaneSystem supports all orientations with projection and visualization</done>
</task>

<task type="auto">
  <name>Task 4: Create BIM object factory</name>
  <files>src/components/BIMWorkbench/BIMObjectFactory.ts, src/components/BIMWorkbench/types/3d.ts</files>
  <action>Create factory for generating BIM objects:

1. Define BIM object types in types/3d.ts:
   ```typescript
   type BIMObjectType = 
     | 'wall' 
     | 'door' 
     | 'window' 
     | 'floor' 
     | 'ceiling' 
     | 'column'
     | 'beam'
     | 'custom';
   
   interface BIMObjectCreateOptions {
     type: BIMObjectType;
     position?: THREE.Vector3;
     rotation?: THREE.Euler;
     scale?: THREE.Vector3;
     level?: string;
     material?: string;
     properties?: Record&lt;string, any&gt;;
   }
   ```

2. Create BIMObjectFactory class:
   ```typescript
   class BIMObjectFactory {
     private _workingPlane: WorkingPlaneSystem;
     private _idCounter: number = 0;
     
     constructor(workingPlane: WorkingPlaneSystem);
     
     // Main creation method
     create(options: BIMObjectCreateOptions): BIM3DObject;
     
     // Type-specific helpers
     createWall(width: number, height: number, thickness: number, options?: Partial&lt;BIMObjectCreateOptions&gt;): BIM3DObject;
     createDoor(width: number, height: number, options?: Partial&lt;BIMObjectCreateOptions&gt;): BIM3DObject;
     createWindow(width: number, height: number, options?: Partial&lt;BIMObjectCreateOptions&gt;): BIM3DObject;
     createFloor(width: number, depth: number, options?: Partial&lt;BIMObjectCreateOptions&gt;): BIM3DObject;
     
     private _createGeometry(type: BIMObjectType, options: BIMObjectCreateOptions): THREE.BufferGeometry;
     private _createMaterial(materialRef?: string): THREE.Material;
     private _generateId(type: BIMObjectType): string;
   }
   ```

3. Implement geometry creation for each type:
   - Wall: BoxGeometry positioned by center
   - Door: BoxGeometry with different proportions
   - Window: BoxGeometry with frame
   - Floor: BoxGeometry thin plane

4. Position objects on working plane by default
5. Generate unique IDs with format: `{type}_{timestamp}_{counter}`</action>
  <verify>Factory creates objects with correct geometry, positioned on working plane</verify>
  <done>BIMObjectFactory creates all basic types with proper IFC metadata and positioning</done>
</task>

<task type="auto">
  <name>Task 5: Add selection visualization</name>
  <files>src/components/BIMWorkbench/SelectionVisualizer.ts</files>
  <action>Create selection visualization system:

1. Create SelectionVisualizer class:
   ```typescript
   interface SelectionVisuals {
     highlight: boolean;
     boundingBox: boolean;
     transformGizmo: 'translate' | 'rotate' | 'scale' | null;
   }
   
   class SelectionVisualizer {
     private _scene: THREE.Scene;
     private _selectedObjects: Map&lt;string, BIM3DObject&gt;;
     private _boundingBoxes: Map&lt;string, THREE.BoxHelper&gt;;
     private _transformControl: TransformControls | null;
     private _camera: THREE.Camera;
     private _renderer: THREE.WebGLRenderer;
     
     constructor(scene: THREE.Scene, camera: THREE.Camera, renderer: THREE.WebGLRenderer);
     
     // Selection management
     selectObject(object: BIM3DObject): void;
     deselectObject(objectId: string): void;
     clearSelection(): void;
     getSelectedObjects(): BIM3DObject[];
     
     // Visuals
     showHighlight(object: BIM3DObject): void;
     hideHighlight(object: BIM3DObject): void;
     showBoundingBox(object: BIM3DObject): void;
     hideBoundingBox(objectId: string): void;
     
     // Transform controls
     enableTransform(mode: 'translate' | 'rotate' | 'scale'): void;
     disableTransform(): void;
     
     // Events
     onTransformStart?: () => void;
     onTransformChange?: (object: BIM3DObject) => void;
     onTransformEnd?: (object: BIM3DObject) => void;
     
     // Update
     update(): void;
     dispose(): void;
   }
   ```

2. Implement highlight using:
   - Emissive material override on selected objects
   - Optional: OutlinePass for post-processing outline

3. Implement bounding box visualization:
   - Three.js BoxHelper around selected objects
   - Update bbox on object transform

4. Implement transform controls:
   - Use @react-three/drei TransformControls or three-transform-controls
   - Support translate, rotate, scale modes
   - Snap options for precision

5. Handle multiple selection (show combined bbox, individual highlights)

Use @react-three/drei for transform controls integration.</action>
  <verify>Selection shows highlight, bounding box appears, transform controls work</verify>
  <done>SelectionVisualizer provides complete selection feedback and manipulation</done>
</task>

</tasks>

<verification>
- [ ] BIM3DObject extends Object3D with metadata, selection, serialization
- [ ] BIM3DCanvas renders with fiber, has orbit controls, grid, object selection
- [ ] WorkingPlaneSystem supports top/front/side/custom with projection
- [ ] BIMObjectFactory creates all basic types on working plane
- [ ] SelectionVisualizer shows highlight, bbox, transform gizmo
- [ ] All TypeScript types compile without errors
- [ ] No console errors during component usage
</verification>

<success_criteria>
1. BIM3DObject base class functional with IFC metadata
2. BIM3DCanvas displays 3D scene with controls and selection
3. Working plane system manages planes and projections
4. Factory creates typed objects positioned correctly
5. Selection visualization complete with transform controls
6. System ready for specific BIM object implementations
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-09-SUMMARY.md`
</output>
