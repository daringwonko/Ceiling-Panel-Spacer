---
phase: 06-bim-workbench
plan: 13
type: execute
wave: 3
depends_on: ["06-12"]
files_modified: [
  "src/features/bim/models/Material.ts",
  "src/features/bim/services/MaterialLibrary.ts",
  "src/features/bim/components/MaterialPanel.tsx",
  "src/features/bim/models/Layer.ts",
  "src/features/bim/services/LayerManager.ts",
  "src/features/bim/components/LayerPanel.tsx",
  "src/features/bim/hooks/useMaterials.ts",
  "src/features/bim/hooks/useLayers.ts",
  "src/features/bim/utils/threeMaterialGenerator.ts",
  "src/features/bim/components/MaterialPreview.tsx",
  "src/features/bim/components/LayerTree.tsx",
  "src/features/bim/components/MaterialPropertyEditor.tsx",
  "src/features/bim/constants/predefinedMaterials.ts"
]
autonomous: true
must_haves:
  truths:
    - "Users can view and select from predefined material library"
    - "Materials have visual properties (color, roughness, metalness, transparency)"
    - "Materials render correctly in Three.js viewport"
    - "Users can assign materials to BIM objects"
    - "Layer panel displays all layers with visibility/lock controls"
    - "Objects can be organized into layers"
    - "Layer visibility toggles affect all objects in that layer"
  artifacts:
    - path: "src/features/bim/models/Material.ts"
      provides: "Material data model and types"
      exports: ["Material", "MaterialProperties"]
    - path: "src/features/bim/services/MaterialLibrary.ts"
      provides: "Material management service"
      exports: ["MaterialLibrary"]
    - path: "src/features/bim/components/MaterialPanel.tsx"
      provides: "Material selection UI"
      exports: ["MaterialPanel"]
    - path: "src/features/bim/models/Layer.ts"
      provides: "Layer data model"
      exports: ["Layer", "LayerState"]
    - path: "src/features/bim/services/LayerManager.ts"
      provides: "Layer management service"
      exports: ["LayerManager"]
    - path: "src/features/bim/components/LayerPanel.tsx"
      provides: "Layer management UI"
      exports: ["LayerPanel"]
  key_links:
    - from: "MaterialLibrary"
      to: "Three.js materials"
      via: "threeMaterialGenerator"
      pattern: "generateThreeMaterial()"
    - from: "MaterialPanel"
      to: "MaterialLibrary"
      via: "useMaterials hook"
      pattern: "useMaterials()"
    - from: "LayerPanel"
      to: "LayerManager"
      via: "useLayers hook"
      pattern: "useLayers()"
    - from: "BIM objects"
      to: "Material"
      via: "material assignment"
      pattern: "object.materialId"
---

<objective>
Implement comprehensive material and layer management system for organizing and styling BIM objects in the 3D workbench.

Purpose: Enable users to apply realistic materials to BIM objects (concrete, wood, steel, glass) and organize objects into layers for better scene management.

Output: Complete material system with predefined library, material panel UI, layer management with hierarchy support, and layer panel UI with visibility/lock controls.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior BIM Workbench plans for context
@.planning/phases/06-bim-workbench/06-12-SUMMARY.md

# BIM model architecture
@src/features/bim/models/BIMObject.ts
@src/features/bim/services/BIMObjectManager.ts

# Three.js integration reference
@src/features/bim/components/BIMViewport.tsx

# UI patterns from workbench
@src/features/bim/components/ObjectPropertiesPanel.tsx
@src/features/bim/components/ObjectListPanel.tsx

# State management
@src/features/bim/stores/bimStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Material System Foundation</name>
  <files>
    src/features/bim/models/Material.ts
    src/features/bim/constants/predefinedMaterials.ts
    src/features/bim/utils/threeMaterialGenerator.ts
    src/features/bim/services/MaterialLibrary.ts
  </files>
  <action>
    Create comprehensive material system:

    1. Material model (src/features/bim/models/Material.ts):
       - Interface Material with id, name, category, properties
       - MaterialProperties: color (hex), roughness (0-1), metalness (0-1), opacity (0-1), emissive (hex), texture map (optional)
       - MaterialCategory enum: concrete, wood, metal, glass, ceramic, fabric, plastic, custom
       - Validation methods for material properties

    2. Predefined materials constant (src/features/bim/constants/predefinedMaterials.ts):
       - Concrete: gray, rough, non-metallic
       - Wood (Oak): brown, medium roughness, non-metallic
       - Steel: light gray, low roughness, high metalness
       - Glass: light blue, low roughness, transparent (opacity 0.3)
       - Brick: red-brown, rough, non-metallic
       - Aluminum: silver, low roughness, high metalness
       - Marble: white with veining texture support
       - Gypsum: off-white, matte finish
       - Carpet: brown, very rough, non-metallic
       - At least 10 predefined materials

    3. Three.js material generator (src/features/bim/utils/threeMaterialGenerator.ts):
       - Function generateThreeMaterial(material: Material): THREE.Material
       - Support MeshStandardMaterial for PBR rendering
       - Handle transparency with transparent and opacity
       - Handle emissive materials for lighting effects
       - Cache generated materials to avoid recreation
       - Support texture loading (async with placeholder)

    4. Material library service (src/features/bim/services/MaterialLibrary.ts):
       - Load predefined materials on initialization
       - CRUD operations for custom materials
       - Persistence to localStorage
       - Search/filter by category or name
       - Event emitter for material changes
       - Get material by ID, get all materials, get by category
       - Duplicate existing material for editing
       - Export/import material library as JSON
  </action>
  <verify>
    - Unit tests pass for Material model validation
    - All predefined materials create valid Three.js materials
    - MaterialLibrary CRUD operations work correctly
    - localStorage persistence verified
    - Code compiles without errors
  </verify>
  <done>
    Material system foundation complete with 10+ predefined materials, Three.js generation support, and persistent material library service
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MaterialPanel Component</name>
  <files>
    src/features/bim/components/MaterialPanel.tsx
    src/features/bim/components/MaterialPreview.tsx
    src/features/bim/components/MaterialPropertyEditor.tsx
    src/features/bim/hooks/useMaterials.ts
  </files>
  <action>
    Build material selection and editing UI:

    1. useMaterials hook (src/features/bim/hooks/useMaterials.ts):
       - Wrap MaterialLibrary service with React state
       - Provide materials list, loading state, error state
       - Actions: selectMaterial, createMaterial, updateMaterial, deleteMaterial, duplicateMaterial
       - Filter by category
       - Search by name
       - Subscribe to material library changes

    2. MaterialPreview component (src/features/bim/components/MaterialPreview.tsx):
       - Small Three.js canvas showing material sphere preview
       - Props: material (Material), size (number)
       - Render sphere with material applied
       - Add lighting for accurate material display
       - Auto-rotate for 360-degree view
       - Show loading state while generating material

    3. MaterialPropertyEditor component (src/features/bim/components/MaterialPropertyEditor.tsx):
       - Form for editing material properties
       - Color picker for base color and emissive
       - Sliders for roughness, metalness, opacity (0-1)
       - Texture map upload (optional)
       - Live preview of changes
       - Validation feedback
       - Save/Cancel buttons
       - "Reset to defaults" option

    4. MaterialPanel component (src/features/bim/components/MaterialPanel.tsx):
       - Collapsible panel for workbench sidebar
       - Search bar for filtering materials
       - Category filter tabs (All, Concrete, Wood, Metal, Glass, Custom)
       - Grid/list view of materials with thumbnails
       - Material cards showing preview + name + category
       - Click to select material for assignment
       - Right-click context menu: Edit, Duplicate, Delete
       - "Add Custom Material" button opening editor
       - Selected material highlight
       - Material count display
       - Empty state for no materials
  </action>
  <verify>
    - MaterialPanel renders correctly in workbench sidebar
    - Material previews display accurate material representation
    - Property editor updates preview in real-time
    - CRUD operations work through UI
    - Search and filter function correctly
    - Selected material state managed properly
  </verify>
  <done>
    MaterialPanel component complete with material selection, preview, search/filter, and property editing capabilities
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Layer System Foundation</name>
  <files>
    src/features/bim/models/Layer.ts
    src/features/bim/services/LayerManager.ts
    src/features/bim/hooks/useLayers.ts
  </files>
  <action>
    Implement layer management system:

    1. Layer model (src/features/bim/models/Layer.ts):
       - Interface Layer with id, name, color (hex for UI), visible (boolean), locked (boolean), parentId (optional for hierarchy)
       - LayerState type combining layer properties
       - LayerHierarchy helper for tree operations
       - Validation: unique names, valid colors
       - Default layers: "0" (default), "Structure", "Architecture", "MEP", "Furniture"

    2. LayerManager service (src/features/bim/services/LayerManager.ts):
       - Initialize with default layers
       - CRUD operations for layers
       - Hierarchy support (parent-child relationships)
       - Visibility toggle (affects children recursively)
       - Lock toggle (prevents selection/editing)
       - Set active layer for new objects
       - Move objects between layers (via object reference)
       - Get objects in layer (integration with BIMObjectManager)
       - Layer order management (z-index concept)
       - Event emitter for layer changes
       - Persistence to localStorage
       - Ensure at least one visible layer exists
       - Prevent deletion of non-empty layers (with override)
       - Get layer by ID, get all layers, get visible layers
       - Rename layer with duplicate name validation

    3. useLayers hook (src/features/bim/hooks/useLayers.ts):
       - React state wrapper for LayerManager
       - Provide layers list (flattened and hierarchical), active layer, loading state
       - Actions: createLayer, updateLayer, deleteLayer, setVisibility, setLocked, setActiveLayer, moveToLayer
       - Get layer objects count
       - Subscribe to layer manager changes
       - Filter/search layers by name
  </action>
  <verify>
    - Layer model validation works correctly
    - LayerManager CRUD operations pass unit tests
    - Hierarchy operations (parent-child) work correctly
    - Visibility/lock toggles function properly
    - localStorage persistence verified
    - Active layer management works
  </verify>
  <done>
    Layer system foundation complete with hierarchy support, visibility/lock controls, and active layer management
  </done>
</task>

<task type="auto">
  <name>Task 4: Create LayerPanel Component</name>
  <files>
    src/features/bim/components/LayerPanel.tsx
    src/features/bim/components/LayerTree.tsx
  </files>
  <action>
    Build layer management UI with tree view:

    1. LayerTree component (src/features/bim/components/LayerTree.tsx):
       - Recursive tree structure for layer hierarchy
       - Props: layers, onToggleVisibility, onToggleLock, onSelect, onRename, onDelete, selectedLayerId
       - Each layer row shows:
         * Expand/collapse arrow (if has children)
         * Eye icon (visibility toggle, filled=visible, strikethrough=hidden)
         * Lock icon (lock toggle, locked=closed lock, unlocked=open lock)
         * Color indicator (small colored square)
         * Layer name (editable on double-click)
         * Object count badge
       - Drag-and-drop for reordering (optional MVP: use buttons)
       - Context menu: Rename, Delete, Add Child Layer
       - Active layer highlight
       - Hover effects for interaction feedback

    2. LayerPanel component (src/features/bim/components/LayerPanel.tsx):
       - Collapsible panel for workbench sidebar
       - Header with "Layers" title and action buttons
       - "Add Layer" button (creates new layer at root)
       - "Add Child Layer" button (contextual, adds to selected)
       - LayerTree component for layer list
       - Search/filter layers by name
       - Layer properties section (when layer selected):
         * Name input
         * Color picker
         * Visibility toggle
         * Lock toggle
       - "Delete Layer" button (with confirmation for non-empty)
       - "Set as Active" button
       - Empty state when no layers
       - Quick actions: Show All, Hide All, Lock All, Unlock All
       - Layer statistics (total layers, visible, locked, objects)
  </action>
  <verify>
    - LayerPanel renders correctly in workbench sidebar
    - Layer tree displays hierarchy properly
    - Visibility/lock toggles update state and UI
    - Active layer selection works
    - Add/delete/rename operations function correctly
    - Object counts display accurately
    - Search/filter works for layer names
  </verify>
  <done>
    LayerPanel component complete with tree view, visibility/lock controls, hierarchy management, and layer editing
  </done>
</task>

<task type="auto">
  <name>Task 5: Integrate Materials and Layers with BIM Objects</name>
  <files>
    src/features/bim/services/BIMObjectManager.ts
    src/features/bim/components/ObjectPropertiesPanel.tsx
    src/features/bim/stores/bimStore.ts
  </files>
  <action>
    Wire material and layer systems to BIM objects:

    1. Extend BIMObject model:
       - Add materialId property (nullable, defaults to null)
       - Add layerId property (defaults to "0" default layer)
       - Update BIMObject interface
       - Ensure serialization/deserialization includes new properties

    2. Update BIMObjectManager:
       - Method assignMaterial(objectId, materialId)
       - Method assignToLayer(objectId, layerId)
       - Method getObjectsByLayer(layerId)
       - Method getObjectsByMaterial(materialId)
       - When layer visibility changes, update object visibility
       - When layer locked, prevent object selection
       - Integration with LayerManager events
       - Batch operations: assign material to multiple objects

    3. Enhance ObjectPropertiesPanel:
       - Add "Material" section with:
         * Current material display (name + preview)
         * "Change Material" button opening MaterialPanel
         * "Remove Material" button
         * Quick material buttons for common materials
       - Add "Layer" section with:
         * Current layer dropdown
         * Layer color indicator
         * "Move to Layer" option
       - Update on selection change

    4. Update bimStore:
       - Add selectedMaterial state
       - Add selectedLayer state
       - Actions: setSelectedMaterial, assignMaterialToSelection
       - Integration between selection, materials, and layers
       - Ensure state consistency across operations

    5. Update BIMViewport for material rendering:
       - When object materialId changes, regenerate Three.js material
       - Listen for material library changes and update affected objects
       - Apply layer visibility to object.visible property
       - Skip rendering if layer hidden
       - Handle material loading states (show default while loading)

    6. Add toolbar integration:
       - Quick material buttons in main toolbar
       - Active layer dropdown in status bar
       - Show current material and layer in status area
  </action>
  <verify>
    - Material assignment updates object appearance in viewport
    - Layer visibility toggles hide/show objects correctly
    - Layer lock prevents object selection
    - ObjectPropertiesPanel shows correct material and layer
    - Changes persist across save/load
    - Batch material assignment works for multiple objects
  </verify>
  <done>
    Material and layer systems fully integrated with BIM objects, properties panel updated, and viewport rendering correctly
  </done>
</task>

</tasks>

<verification>
1. **Material System Verification:**
   - All predefined materials load correctly
   - Custom materials can be created, edited, deleted
   - Material previews render accurately
   - Three.js materials generate without errors
   - Material persistence works across reloads

2. **Layer System Verification:**
   - Default layers created on first load
   - Layer hierarchy displays correctly
   - Visibility toggles affect all objects in layer
   - Lock prevents selection and editing
   - Active layer changes affect new object placement
   - Layer persistence works across reloads

3. **Integration Verification:**
   - Material assignment updates viewport immediately
   - Layer visibility changes reflect in real-time
   - Object properties panel reflects current assignments
   - Batch operations work correctly
   - No console errors during operations

4. **UI Verification:**
   - MaterialPanel displays correctly in sidebar
   - LayerPanel tree view functions properly
   - Search and filter work in both panels
   - Responsive layout adapts to panel width
</verification>

<success_criteria>
- Users can select from 10+ predefined materials or create custom materials
- Material properties (color, roughness, metalness, opacity) are editable
- Materials render correctly with PBR shading in Three.js viewport
- Users can assign materials to BIM objects via properties panel
- Layer panel displays hierarchical layer structure
- Layer visibility toggle (eye icon) hides/shows all objects in layer
- Layer lock toggle (lock icon) prevents selection of layer objects
- Users can create, rename, and delete layers
- Objects can be moved between layers
- Active layer is respected when creating new objects
- Material and layer state persists across application reloads
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-13-SUMMARY.md` with:
- Material system architecture summary
- Layer hierarchy implementation details
- Integration patterns used
- Material library contents
- Default layer structure
- Known limitations or future enhancements
</output>
