---
phase: "06-bim-workbench"
plan: "06-21"
name: "Testing & Deployment"
type: "execute"
wave: 6
autonomous: true
depends_on: ["06-20"]
files_modified: [
  "frontend/vitest.config.ts",
  "frontend/src/test/setup.ts",
  "frontend/src/stores/__tests__/useBIMStore.test.ts",
  "frontend/src/components/__tests__/BIMLayout.test.tsx",
  "frontend/src/tools/__tests__/lineTool.test.ts",
  "frontend/e2e/bim-workbench.spec.ts",
  "frontend/playwright.config.ts",
  "frontend/src/test/mocks/bimObjects.ts",
  "frontend/.github/workflows/test.yml",
  "frontend/DEPLOYMENT.md",
  "frontend/README_BIM.md"
]
must_haves: {
  truths: [
    "Test suite achieves 80%+ code coverage",
    "All 100+ BIM tools have unit tests",
    "E2E tests cover critical user workflows",
    "Performance tests verify 60fps with 1000+ objects",
    "Documentation is complete for users and developers"
  ],
  artifacts: [
    ".planning/phases/06-bim-workbench/06-21-SUMMARY.md"
  ]
}
---

# Plan 06-21: Testing & Deployment

## Objective

Implement comprehensive testing, documentation, and prepare for deployment.

**What this plan will deliver:**
- 80%+ test coverage across the codebase
- Unit tests for all tools and components
- Integration tests for workflows
- E2E tests for critical paths
- Performance benchmarks
- Complete documentation
- Deployment pipeline

## Context

Success criteria from CONTEXT.md:
- 80%+ test coverage target
- Unit, Integration, E2E, and Visual regression tests
- Vitest + React Testing Library + Playwright

Existing foundation:
- BIM workbench is functionally complete
- All 100+ tools implemented
- State management in place

## Tasks

### Task 1: Set Up Testing Infrastructure
**Type:** auto
**Files:** `frontend/vitest.config.ts`, `frontend/src/test/setup.ts`, `frontend/src/test/mocks/bimObjects.ts`

Configure testing framework:

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./src/test/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts'
      ],
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 75,
        statements: 80
      }
    }
  }
})

// src/test/setup.ts
import '@testing-library/jest-dom'
import { cleanup } from '@testing-library/react'

// Cleanup after each test
afterEach(() => {
  cleanup()
})

// Mock Three.js
vi.mock('three', () => ({
  Object3D: class Object3D {
    position = { set: vi.fn() }
    rotation = { set: vi.fn() }
    scale = { set: vi.fn() }
    add = vi.fn()
    remove = vi.fn()
  },
  Vector3: class Vector3 {
    constructor(x, y, z) {}
  },
  // ... other mocks
}))

// Mock Zustand stores
vi.mock('../stores/useBIMStore', () => ({
  useBIMStore: {
    getState: vi.fn(),
    setState: vi.fn()
  }
}))
```

Create test fixtures:
```typescript
// src/test/mocks/bimObjects.ts
export const mockWall: BIMObject = {
  id: 'wall-1',
  type: 'wall',
  name: 'Test Wall',
  geometry: { type: 'box', width: 5000, height: 3000, depth: 200 },
  material: 'concrete',
  properties: { width: 5000, height: 3000, thickness: 200 },
  position: [0, 0, 0],
  rotation: [0, 0, 0],
  scale: [1, 1, 1],
  isSelected: false,
  level: 'level-1',
  layer: 'layer-0'
}

export const mockProject: BIMProject = {
  id: 'proj-1',
  name: 'Test Project',
  description: 'Test project for unit tests',
  objects: [mockWall],
  metadata: {
    created: new Date().toISOString(),
    modified: new Date().toISOString(),
    author: 'Test',
    version: '1.0.0'
  }
}
```

### Task 2: Write Unit Tests for State Management
**Type:** auto
**Files:** `frontend/src/stores/__tests__/useBIMStore.test.ts`

Test the BIM store:

```typescript
// useBIMStore.test.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { useBIMStore } from '../useBIMStore'
import { mockWall, mockProject } from '../../test/mocks/bimObjects'

describe('useBIMStore', () => {
  beforeEach(() => {
    useBIMStore.setState({
      project: null,
      objects: [],
      selectedObjectIds: [],
      commands: [],
      currentCommandIndex: -1
    })
  })

  it('should create a project', () => {
    const { createProject } = useBIMStore.getState()
    createProject('Test Project')
    
    const state = useBIMStore.getState()
    expect(state.project).not.toBeNull()
    expect(state.project.name).toBe('Test Project')
  })

  it('should add an object', () => {
    const { addObject } = useBIMStore.getState()
    addObject(mockWall)
    
    const state = useBIMStore.getState()
    expect(state.objects).toHaveLength(1)
    expect(state.objects[0].id).toBe('wall-1')
  })

  it('should select an object', () => {
    const { addObject, selectObject } = useBIMStore.getState()
    addObject(mockWall)
    selectObject('wall-1')
    
    const state = useBIMStore.getState()
    expect(state.selectedObjectIds).toContain('wall-1')
  })

  it('should support undo/redo', () => {
    const { addObject, undo, redo } = useBIMStore.getState()
    
    addObject(mockWall)
    expect(useBIMStore.getState().objects).toHaveLength(1)
    
    undo()
    expect(useBIMStore.getState().objects).toHaveLength(0)
    
    redo()
    expect(useBIMStore.getState().objects).toHaveLength(1)
  })

  it('should update object properties', () => {
    const { addObject, updateObject } = useBIMStore.getState()
    addObject(mockWall)
    
    updateObject('wall-1', { name: 'Updated Wall' })
    
    const state = useBIMStore.getState()
    expect(state.objects[0].name).toBe('Updated Wall')
  })
})
```

### Task 3: Write Component Tests
**Type:** auto
**Files:** `frontend/src/components/__tests__/BIMLayout.test.tsx`, `frontend/src/components/__tests__/DraftingCanvas.test.tsx`

Test React components:

```typescript
// BIMLayout.test.tsx
import { describe, it, expect, vi } from 'vitest'
import { render, screen, fireEvent } from '@testing-library/react'
import BIMLayout from '../Layout/BIMLayout'

vi.mock('../../stores/useBIMStore', () => ({
  useBIMStore: () => ({
    objects: [],
    selectedObjectIds: [],
    undo: vi.fn(),
    redo: vi.fn(),
    saveProject: vi.fn()
  })
}))

describe('BIMLayout', () => {
  it('renders the layout with sidebar', () => {
    render(<BIMLayout />)
    expect(screen.getByText('Savage Cabinetry')).toBeInTheDocument()
    expect(screen.getByText('BIM Workbench')).toBeInTheDocument()
  })

  it('shows tool categories', () => {
    render(<BIMLayout />)
    expect(screen.getByText('2D Drafting')).toBeInTheDocument()
    expect(screen.getByText('3D Modeling')).toBeInTheDocument()
  })

  it('toggles sidebar when button clicked', () => {
    render(<BIMLayout />)
    const toggleButton = screen.getByLabelText('Toggle sidebar')
    fireEvent.click(toggleButton)
    // Verify sidebar collapsed
  })
})
```

### Task 4: Write Tool Tests
**Type:** auto
**Files:** `frontend/src/tools/__tests__/lineTool.test.ts`, `frontend/src/tools/__tests__/wallTool.test.ts`

Test tool logic:

```typescript
// lineTool.test.ts
import { describe, it, expect } from 'vitest'
import { LineTool } from '../lineTool'
import { Point2D } from '../../types/geometry'

describe('LineTool', () => {
  it('should create a line from two points', () => {
    const tool = new LineTool()
    const start: Point2D = { x: 0, y: 0 }
    const end: Point2D = { x: 100, y: 0 }
    
    tool.onClick(start)
    const line = tool.onClick(end)
    
    expect(line).not.toBeNull()
    expect(line.type).toBe('line')
    expect(line.geometry.start).toEqual(start)
    expect(line.geometry.end).toEqual(end)
  })

  it('should calculate line length correctly', () => {
    const tool = new LineTool()
    const start: Point2D = { x: 0, y: 0 }
    const end: Point2D = { x: 100, y: 100 }
    
    tool.onClick(start)
    const line = tool.onClick(end)
    
    const length = Math.sqrt(
      Math.pow(end.x - start.x, 2) + 
      Math.pow(end.y - start.y, 2)
    )
    expect(line.properties.length).toBeCloseTo(length)
  })

  it('should support ortho mode', () => {
    const tool = new LineTool({ orthoMode: true })
    const start: Point2D = { x: 0, y: 0 }
    const end: Point2D = { x: 50, y: 100 } // Diagonal input
    
    tool.onClick(start)
    const line = tool.onClick(end)
    
    // Should snap to horizontal or vertical
    const dx = Math.abs(line.geometry.end.x - line.geometry.start.x)
    const dy = Math.abs(line.geometry.end.y - line.geometry.start.y)
    expect(dx === 0 || dy === 0).toBe(true)
  })
})
```

### Task 5: Write E2E Tests
**Type:** auto
**Files:** `frontend/e2e/bim-workbench.spec.ts`, `frontend/playwright.config.ts`

Configure Playwright:

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry'
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] }
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] }
    }
  ]
})
```

Write E2E tests:

```typescript
// bim-workbench.spec.ts
import { test, expect } from '@playwright/test'

test.describe('BIM Workbench', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/bim')
  })

  test('user can create a new project', async ({ page }) => {
    await page.click('text=New Project')
    await page.fill('[placeholder="Project name"]', 'Test Project')
    await page.click('text=Create')
    
    await expect(page.locator('text=Test Project')).toBeVisible()
  })

  test('user can draw a line', async ({ page }) => {
    // Select line tool
    await page.click('text=Line')
    
    // Draw on canvas
    const canvas = page.locator('[data-testid="drafting-canvas"]')
    await canvas.click({ position: { x: 100, y: 100 } })
    await canvas.click({ position: { x: 200, y: 100 } })
    
    // Verify line created
    await expect(page.locator('text=Line')).toHaveCount(1)
  })

  test('user can create a wall', async ({ page }) => {
    // Switch to 3D modeling
    await page.click('text=3D Modeling')
    await page.click('text=Wall')
    
    // Draw wall
    const canvas = page.locator('[data-testid="bim-3d-canvas"]')
    await canvas.click({ position: { x: 100, y: 100 } })
    await canvas.click({ position: { x: 300, y: 100 } })
    
    // Verify wall in object list
    await expect(page.locator('text=Wall')).toBeVisible()
  })

  test('user can undo and redo', async ({ page }) => {
    // Create an object
    await page.click('text=Line')
    const canvas = page.locator('[data-testid="drafting-canvas"]')
    await canvas.click({ position: { x: 100, y: 100 } })
    await canvas.click({ position: { x: 200, y: 100 } })
    
    // Undo
    await page.keyboard.press('Control+z')
    await expect(page.locator('text=Line')).toHaveCount(0)
    
    // Redo
    await page.keyboard.press('Control+y')
    await expect(page.locator('text=Line')).toHaveCount(1)
  })

  test('user can export to IFC', async ({ page }) => {
    // Create a wall first
    await page.click('text=3D Modeling')
    await page.click('text=Wall')
    const canvas = page.locator('[data-testid="bim-3d-canvas"]')
    await canvas.click({ position: { x: 100, y: 100 } })
    await canvas.click({ position: { x: 300, y: 100 } })
    
    // Export
    await page.click('text=Export')
    await page.click('text=IFC Export')
    
    // Verify download started
    const download = await page.waitForEvent('download')
    expect(download.suggestedFilename()).toContain('.ifc')
  })
})
```

### Task 6: Performance Testing
**Type:** auto
**Files:** `frontend/src/test/performance/canvas.perf.ts`

Add performance tests:

```typescript
// canvas.perf.ts
import { describe, it, expect } from 'vitest'
import { DraftingCanvas } from '../../components/DraftingCanvas'

describe('Performance', () => {
  it('should render 1000 2D objects at 60fps', async () => {
    const objects = generateTestObjects(1000)
    const canvas = new DraftingCanvas()
    
    const startTime = performance.now()
    canvas.render(objects)
    const endTime = performance.now()
    
    const frameTime = endTime - startTime
    const fps = 1000 / frameTime
    
    expect(fps).toBeGreaterThanOrEqual(60)
  })

  it('should render 100 3D BIM objects at 60fps', async () => {
    const objects = generateBIMObjects(100)
    const scene = new BIM3DScene()
    
    const startTime = performance.now()
    scene.render(objects)
    const endTime = performance.now()
    
    const frameTime = endTime - startTime
    const fps = 1000 / frameTime
    
    expect(fps).toBeGreaterThanOrEqual(60)
  })
})
```

### Task 7: Create Documentation
**Type:** auto
**Files:** `frontend/README_BIM.md`, `frontend/DEPLOYMENT.md`

Create user documentation:

```markdown
# BIM Workbench User Guide

## Getting Started

### Creating a New Project
1. Click "New Project" in the sidebar
2. Enter project name and description
3. Click "Create"

### 2D Drafting

#### Drawing Lines
1. Select "Line" tool from 2D Drafting category
2. Click start point on canvas
3. Click end point
4. Hold Shift for orthogonal lines

#### Drawing Walls
1. Switch to "3D Modeling" category
2. Select "Wall" tool
3. Click start point
4. Click end point
5. Set height in properties panel

### 3D Modeling

#### Creating Objects
All 3D objects are created on the current working plane.

#### Working Planes
- Top (XY): Ground plane
- Front (XZ): Vertical plane
- Side (YZ): Side elevation

### Keyboard Shortcuts

| Key | Action |
|-----|--------|
| Ctrl+Z | Undo |
| Ctrl+Y | Redo |
| Ctrl+S | Save |
| L | Line tool |
| R | Rectangle tool |
| W | Wall tool |
| Delete | Delete selected |
| Escape | Cancel current tool |

### Export

#### IFC Export
Industry Foundation Classes format for BIM interoperability.

#### DXF Export
AutoCAD-compatible 2D drawings.

#### SVG Export
Vector graphics for documentation.
```

Create deployment guide:

```markdown
# Deployment Guide

## Prerequisites
- Node.js 18+
- Python 3.9+
- npm or yarn

## Development Setup
```bash
cd frontend
npm install
npm run dev
```

## Build for Production
```bash
cd frontend
npm run build
```

## Run Tests
```bash
# Unit tests
npm run test

# E2E tests
npm run test:e2e

# Coverage
npm run test:coverage
```

## CI/CD Pipeline
GitHub Actions workflow runs tests on every PR.

## Deployment
Vercel deployment configured for automatic deploys from main branch.
```

### Task 8: Set Up CI/CD
**Type:** auto
**Files:** `.github/workflows/test.yml`

Create GitHub Actions workflow:

```yaml
name: Test and Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run unit tests
      run: |
        cd frontend
        npm run test:coverage
        
    - name: Run type check
      run: |
        cd frontend
        npm run type-check
        
    - name: Build
      run: |
        cd frontend
        npm run build
        
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./frontend/coverage/lcov.info
```

## Verification

### Verification Steps
1. Run `npm run test:coverage` - verify 80%+ coverage
2. Run `npm run test:e2e` - verify all E2E tests pass
3. Run performance tests - verify 60fps targets
4. Check documentation - verify completeness
5. Run build - verify no errors

### Test Checklist
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] All E2E tests pass
- [ ] Coverage report shows 80%+
- [ ] Performance tests meet targets
- [ ] Documentation is complete
- [ ] Build succeeds
- [ ] Type checking passes

## Success Criteria

1. **Test Coverage**: 80%+ code coverage achieved
2. **Unit Tests**: All tools and components tested
3. **Integration Tests**: All workflows tested
4. **E2E Tests**: Critical paths covered
5. **Performance**: 60fps with 1000+ 2D objects, 100+ 3D objects
6. **Documentation**: Complete user and developer guides
7. **CI/CD**: Automated testing on PRs
8. **Build**: Production build succeeds

## Output

After completing this plan, update `.planning/phases/06-bim-workbench/06-21-SUMMARY.md` with:
- Test coverage achieved
- Tests written by category
- Performance benchmarks
- Documentation status
- Deployment configuration
