---
phase: 06-bim-workbench
plan: 06
type: execute
wave: 2
depends_on: ['06-05']
files_modified:
  - bim_workbench/tools/line_tool.py
  - bim_workbench/tools/rectangle_tool.py
  - bim_workbench/tools/circle_tool.py
  - bim_workbench/tools/arc_tool.py
  - bim_workbench/core/drafting_tools.py
  - bim_workbench/ui/tool_manager.py
  - bim_workbench/core/cursor_manager.py
  - tests/test_drafting_tools.py
autonomous: true
must_haves:
  truths:
    - User can draw lines by clicking start and end points
    - User can draw rectangles by clicking two opposite corners
    - User can draw circles by clicking center and dragging for radius
    - User can draw arcs with three-point input (center, start, end)
    - Ortho mode works when Shift is held (horizontal/vertical constraints)
    - Square mode works when Shift is held during rectangle drawing
    - Visual feedback shows preview while drawing
    - Tools can be activated from sidebar
    - Cursor changes based on active tool
    - All objects are stored as BIMObjects with proper types
  artifacts:
    - path: 'bim_workbench/tools/line_tool.py'
      provides: 'Line drawing tool with ortho mode'
      exports: ['LineTool', 'create_line']
    - path: 'bim_workbench/tools/rectangle_tool.py'
      provides: 'Rectangle drawing tool with square mode'
      exports: ['RectangleTool', 'create_rectangle']
    - path: 'bim_workbench/tools/circle_tool.py'
      provides: 'Circle drawing tool with radius preview'
      exports: ['CircleTool', 'create_circle']
    - path: 'bim_workbench/tools/arc_tool.py'
      provides: 'Arc drawing tool with three-point input'
      exports: ['ArcTool', 'create_arc']
    - path: 'bim_workbench/ui/tool_manager.py'
      provides: 'Tool activation and management'
      exports: ['ToolManager', 'activate_tool']
  key_links:
    - from: 'bim_workbench/ui/tool_manager.py'
      to: 'bim_workbench/tools/*_tool.py'
      via: 'Tool activation/deactivation'
      pattern: 'tool.activate()|tool.deactivate()'
    - from: 'bim_workbench/tools/*_tool.py'
      to: 'BIMObject'
      via: 'create BIM object on completion'
      pattern: 'BIMObject(type=...)'
---

<objective>
Implement the core 2D drafting tools for the BIM Workbench: Line, Rectangle, Circle, and Arc. These tools provide the foundation for creating geometric elements in the 2D drafting environment, with full visual feedback during drawing and proper BIM object creation upon completion.

Purpose: These drafting tools are the primary interface for users to create geometry in the BIM Workbench. They must support professional CAD workflows including ortho constraints, visual previews, and intuitive multi-point input.

Output: Four fully functional drafting tools (Line, Rectangle, Circle, Arc) integrated with the workbench UI, supporting visual feedback and proper BIM object storage.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-bim-workbench/06-05-SUMMARY.md
@.planning/BIM_Workbench.md

From BIM_Workbench.md:
- Line: Creates a straight line between two points
- Rectangle: Creates a rectangle from two opposite corner points
- Circle: Creates a circle from center point and radius
- Arc: Creates a circular arc from center, radius, start angle, and aperture

Tool patterns established in prior plans:
- Tools inherit from base Tool class
- Event handling: on_mouse_press, on_mouse_move, on_mouse_release, on_key_press
- Visual feedback via temporary graphics overlay
- BIM object creation through BIMObject factory
- State machine for multi-point input sequences
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Line Tool with Ortho Mode</name>
  <files>bim_workbench/tools/line_tool.py</files>
  <action>
    Implement LineTool class inheriting from Tool base class:
    
    1. Two-point input sequence:
       - First click: set start point, begin drawing mode
       - Mouse move: show preview line from start to current position
       - Second click: set end point, complete line
    
    2. Ortho mode (hold Shift):
       - Constrain line to horizontal or vertical (whichever is closer)
       - Visual indicator when ortho is active
       - Maintain ortho constraint throughout drawing
    
    3. Visual feedback:
       - Preview line in different color (e.g., dashed blue)
       - Highlight start point marker
       - Show coordinates tooltip during drawing
    
    4. BIM object creation:
       - Create BIMObject with type='line'
       - Store: start_point (x, y), end_point (x, y), length
       - Add to current drawing's object list
    
    5. State management:
       - idle: waiting for first click
       - drawing: waiting for second click
       - Reset to idle on Escape key or right-click cancel
    
    Provide: LineTool class, create_line() helper function
  </action>
  <verify>
    - Run tool tests: python -m pytest tests/test_line_tool.py -v
    - Verify ortho mode with Shift key simulation
    - Confirm BIMObject created with correct type and data
  </verify>
  <done>
    LineTool exists with two-point input, ortho mode (Shift), visual preview, and BIM object creation. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Rectangle Tool with Square Mode</name>
  <files>bim_workbench/tools/rectangle_tool.py</files>
  <action>
    Implement RectangleTool class inheriting from Tool base class:
    
    1. Two-point input sequence:
       - First click: set first corner (anchor point)
       - Mouse move: show preview rectangle from anchor to current position
       - Second click: set opposite corner, complete rectangle
    
    2. Square mode (hold Shift):
       - Constrain to square (equal width and height)
       - Use minimum dimension to determine square size
       - Visual feedback showing square constraint
    
    3. Visual feedback:
       - Preview rectangle with semi-transparent fill
       - Show width and height dimensions dynamically
       - Corner markers at anchor point
       - Highlight square mode indicator
    
    4. BIM object creation:
       - Create BIMObject with type='rectangle'
       - Store: corner1 (x, y), corner2 (x, y), width, height, area
       - Normalize corners (min/max) for consistent storage
       - Add to current drawing's object list
    
    5. Edge cases:
       - Handle zero-size rectangle (ignore or minimum size)
       - Cancel on Escape or right-click
       - Update preview on every mouse move
    
    Provide: RectangleTool class, create_rectangle() helper function
  </action>
  <verify>
    - Run rectangle tests: python -m pytest tests/test_rectangle_tool.py -v
    - Verify square mode with Shift key constraint
    - Check BIMObject has correct dimensions and normalized corners
  </verify>
  <done>
    RectangleTool exists with two-point input, square mode (Shift), dimension preview, and proper BIM object creation. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Circle Tool with Radius Preview</name>
  <files>bim_workbench/tools/circle_tool.py</files>
  <action>
    Implement CircleTool class inheriting from Tool base class:
    
    1. Center-radius input sequence:
       - First click: set center point
       - Mouse move: show preview circle with radius from center to cursor
       - Second click: set radius point, complete circle
       - Alternative: Type numeric radius value and press Enter
    
    2. Visual feedback:
       - Preview circle with center point marker
       - Radius line from center to cursor
       - Show current radius value (units)
       - Diameter indicator (optional)
    
    3. Numeric input support:
       - While drawing, accept numeric keyboard input
       - Show typed value in status area
       - Press Enter to confirm numeric radius
       - Escape to cancel numeric input, return to mouse mode
    
  4. BIM object creation:
       - Create BIMObject with type='circle'
       - Store: center (x, y), radius, diameter, circumference, area
       - Add to current drawing's object list
    
    5. Constraints:
       - Minimum radius threshold (e.g., 1 unit)
       - Cancel on right-click at any point
       - Clear preview on Escape
    
    Provide: CircleTool class, create_circle() helper function
  </action>
  <verify>
    - Run circle tests: python -m pytest tests/test_circle_tool.py -v
    - Test numeric radius input
    - Verify BIMObject contains correct circle parameters
  </verify>
  <done>
    CircleTool exists with center-radius input, numeric radius support, visual preview, and proper BIM object creation. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Arc Tool with Three-Point Input</name>
  <files>bim_workbench/tools/arc_tool.py</files>
  <action>
    Implement ArcTool class inheriting from Tool base class:
    
    1. Three-point input sequence:
       - First click: set center point
       - Second click: set start point (defines radius and start angle)
       - Mouse move: show preview arc from start angle to cursor
       - Third click: set end point (defines aperture/end angle)
    
    2. Counter-clockwise default:
       - Arc drawn CCW from start to end angle
       - Visual indicator showing arc direction
       - Option to reverse direction (e.g., hold Ctrl)
    
    3. Visual feedback:
       - Show center point marker
       - Show radius line to start point (fixed after second click)
       - Preview arc sector with angle indication
       - Show start angle, end angle, and aperture values
       - Fill sector preview (semi-transparent)
    
 4. BIM object creation:
       - Create BIMObject with type='arc'
       - Store: center (x, y), radius, start_angle, end_angle, aperture
       - Calculate arc length and store
       - Add to current drawing's object list
    
    5. State machine:
       - state 0 (idle): waiting for center
       - state 1 (center_set): waiting for start point
       - state 2 (start_set): waiting for end point, showing preview
       - Reset to previous state on Escape (or idle if at state 0)
    
    Provide: ArcTool class, create_arc() helper function
  </action>
  <verify>
    - Run arc tests: python -m pytest tests/test_arc_tool.py -v
    - Test CCW direction is default
    - Verify BIMObject has correct angles and aperture
    - Check state machine transitions
  </verify>
  <done>
    ArcTool exists with three-point input (center, start, end), CCW default, visual preview with sector, and proper BIM object creation. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 5: Integrate Tools with UI and Tool Manager</name>
  <files>bim_workbench/ui/tool_manager.py, bim_workbench/core/cursor_manager.py</files>
  <action>
    Integrate all drafting tools with the workbench UI:
    
    1. Tool Manager updates (tool_manager.py):
       - Register all four tools: LineTool, RectangleTool, CircleTool, ArcTool
       - Add tool selection methods: select_line_tool(), select_rectangle_tool(), etc.
       - Maintain active_tool reference
       - Route events to active tool (mouse, keyboard)
       - Handle tool deactivation (cleanup preview, reset state)
    
    2. Sidebar integration:
       - Add tool buttons to drafting tools panel
       - Icons for each tool (line, rectangle, circle, arc)
       - Highlight active tool button
       - Keyboard shortcuts (L for line, R for rectangle, C for circle, A for arc)
    
    3. Cursor management (cursor_manager.py):
       - Define cursor shapes per tool:
         * Line: crosshair
         * Rectangle: crosshair with corner
         * Circle: crosshair with circle
         * Arc: crosshair with arc
       - Switch cursor on tool activation
       - Restore default cursor on tool deactivation
    
    4. Status bar integration:
       - Show tool instructions in status bar
       - Line: "Click start point, then end point (Shift for ortho)"
       - Rectangle: "Click first corner, then opposite corner (Shift for square)"
       - Circle: "Click center, then radius point (or type value)"
       - Arc: "Click center, start point, then end point"
       - Update instructions based on current input state
    
    5. Tool activation flow:
       - User clicks tool button or presses shortcut
       - Deactivate current tool (if any)
       - Activate selected tool (tool.activate())
       - Update cursor, status bar, highlight button
       - Tool begins waiting for input
    
    Provide: Updated ToolManager, CursorManager with drafting tool support
  </action>
  <verify>
    - Run integration tests: python -m pytest tests/test_tool_integration.py -v
    - Test tool switching via buttons and shortcuts
    - Verify cursor changes per tool
    - Confirm status bar shows correct instructions
  </verify>
  <done>
    All tools integrated with ToolManager, sidebar buttons work, cursor changes per tool, status bar shows instructions, keyboard shortcuts functional. Integration tests pass.
  </done>
</task>

</tasks>

<verification>
1. **Tool Functionality Verification:**
   - Line tool draws accurate lines, ortho mode works with Shift
   - Rectangle tool draws accurate rectangles, square mode works with Shift
   - Circle tool draws accurate circles, numeric input works
   - Arc tool draws accurate arcs, CCW direction correct

2. **Visual Feedback Verification:**
   - Preview visible during all drawing operations
   - Preview clears on tool completion or cancel
   - Dimension/parameter display updates in real-time
   - Tool-specific visual indicators present

3. **UI Integration Verification:**
   - Sidebar buttons activate correct tools
   - Keyboard shortcuts work (L, R, C, A)
   - Cursor changes appropriately per tool
   - Status bar shows relevant instructions
   - Active tool highlighted in sidebar

4. **BIM Object Verification:**
   - All tools create BIMObjects with correct type
   - Geometric data stored accurately
   - Objects appear in drawing's object list
   - Object properties accessible

5. **State Management Verification:**
   - Tools handle cancel (Escape) correctly
   - Tools handle right-click cancel correctly
   - State resets properly between operations
   - No memory leaks from preview graphics
</verification>

<success_criteria>
- [ ] LineTool implemented with two-point input and ortho mode
- [ ] RectangleTool implemented with two-point input and square mode
- [ ] CircleTool implemented with center-radius input and numeric support
- [ ] ArcTool implemented with three-point input and CCW default
- [ ] All tools show visual preview during drawing
- [ ] Tools accessible via sidebar buttons with icons
- [ ] Keyboard shortcuts functional (L, R, C, A)
- [ ] Cursor changes per tool type
- [ ] Status bar displays tool instructions
- [ ] All tools create proper BIMObjects with correct types
- [ ] Tool state management handles cancel and completion correctly
- [ ] Integration tests pass for all tools and UI components
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-06-SUMMARY.md` documenting:
- LineTool with ortho mode implementation details
- RectangleTool with square mode implementation details
- CircleTool with numeric radius input
- ArcTool with three-point CCW input
- ToolManager integration and UI updates
- Test coverage for all drafting tools
- Any deviations from planned implementation
</output>
