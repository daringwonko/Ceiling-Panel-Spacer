---
phase: 06-bim-workbench
plan: 05
type: execute
wave: 2
depends_on: [06-01, 06-02, 06-03]
files_modified:
  - src/components/BIMWorkbench/DraftingCanvas.tsx
  - src/components/BIMWorkbench/GridSystem.tsx
  - src/components/BIMWorkbench/CoordinateDisplay.tsx
  - src/components/BIMWorkbench/CanvasControls.tsx
  - src/hooks/useCanvasNavigation.ts
  - src/hooks/useSelectionRectangle.ts
  - src/hooks/useGridSnap.ts
  - src/types/drafting.ts
  - src/styles/drafting-canvas.css
autonomous: true
must_haves:
  truths:
    - User sees SVG canvas with configurable grid overlay
    - User can pan canvas with middle mouse drag
    - User can zoom with mouse wheel
    - Grid visibility can be toggled on/off
    - Mouse position displays world coordinates in real-time
    - Selection rectangle works with click and drag
  artifacts:
    - path: src/components/BIMWorkbench/DraftingCanvas.tsx
      provides: Main SVG canvas component with viewBox
      exports: [DraftingCanvas]
    - path: src/components/BIMWorkbench/GridSystem.tsx
      provides: Configurable grid rendering
      exports: [GridSystem]
    - path: src/components/BIMWorkbench/CoordinateDisplay.tsx
      provides: Mouse position tracking and display
      exports: [CoordinateDisplay]
    - path: src/components/BIMWorkbench/CanvasControls.tsx
      provides: Zoom/fit controls UI
      exports: [CanvasControls]
    - path: src/hooks/useCanvasNavigation.ts
      provides: Pan, zoom, fit-to-view logic
      exports: [useCanvasNavigation]
    - path: src/hooks/useGridSnap.ts
      provides: Grid snapping calculations
      exports: [useGridSnap]
    - path: src/types/drafting.ts
      provides: Canvas state, grid config, point types
      exports: [CanvasState, GridConfig, Point2D, ViewBox]
  key_links:
    - from: DraftingCanvas
      to: GridSystem
      via: GridConfig prop
      pattern: "<GridSystem config={gridConfig} />"
    - from: DraftingCanvas
      to: useCanvasNavigation
      via: Custom hook
      pattern: "const { pan, zoom, viewBox } = useCanvasNavigation()"
    - from: CanvasControls
      to: useCanvasNavigation
      via: Shared hook instance
      pattern: "Controls call pan/zoom/fit methods"
    - from: DraftingCanvas
      to: CoordinateDisplay
      via: Mouse event handlers
      pattern: "onMouseMove updates coordinate display"
---

<objective>
Create a fully functional SVG-based 2D drafting canvas with configurable grid system, pan/zoom navigation, and selection capabilities for BIM workbench operations.

Purpose: Provide the foundational 2D drawing surface for all drafting operations (lines, shapes, annotations) with professional-grade navigation and precision tools.
Output: Complete canvas component with grid overlay, coordinate tracking, and selection rectangle functionality.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-bim-workbench/BIM_Workbench.md

# Core drawing tools to be supported on this canvas:
# - Line, Polyline, Rectangle, Circle, Arc
# - Fillet, Ellipse, Polygon
# - B-spline, Bézier, Point
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Type Definitions and Canvas State</name>
  <files>src/types/drafting.ts</files>
  <action>
Create TypeScript type definitions for the 2D drafting system:

1. Define Point2D type: { x: number; y: number }
2. Define ViewBox type: { minX, minY, width, height }
3. Define CanvasState type with:
   - viewBox: ViewBox
   - zoom: number
   - isPanning: boolean
   - panStart: Point2D | null
4. Define GridConfig type with:
   - visible: boolean
   - majorSize: number (default 100mm)
   - minorSize: number (default 10mm)
   - majorColor: string
   - minorColor: string
   - snapEnabled: boolean
5. Define SelectionRect type with:
   - start: Point2D
   - end: Point2D
   - active: boolean

Export all types. Use explicit number types for mm units.
  </action>
  <verify>Run TypeScript compiler: tsc --noEmit src/types/drafting.ts</verify>
  <done>All type definitions compile without errors, exports are properly defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement useCanvasNavigation Hook</name>
  <files>src/hooks/useCanvasNavigation.ts</files>
  <action>
Create custom hook for canvas navigation operations:

1. Initialize state:
   - viewBox: { minX: -500, minY: -500, width: 1000, height: 1000 }
   - zoom: 1.0
   - isPanning: false
   - panStart: null

2. Implement pan methods:
   - startPan(screenX, screenY): Record start position
   - pan(dx, dy): Adjust viewBox minX/minY by delta
   - endPan(): Reset panning state

3. Implement zoom methods:
   - zoomIn(centerX?, centerY?): Multiply zoom by 1.2
   - zoomOut(centerX?, centerY?): Divide zoom by 1.2
   - zoomTo(factor, centerX?, centerY?): Set zoom directly
   - wheelZoom(delta, mouseX, mouseY): Handle wheel events with mouse-centered zoom

4. Implement fit methods:
   - fitToView(bounds: { minX, minY, maxX, maxY }): Calculate viewBox to fit content
   - zoomToSelection(selectionBounds): Zoom to specific bounds
   - resetView(): Return to default viewBox

5. Convert screen to world coordinates:
   - screenToWorld(screenX, screenY): Apply inverse transform
   - worldToScreen(worldX, worldY): Apply forward transform

Return all methods and state. Handle zoom around mouse position correctly.
  </action>
  <verify>Create test: verify zoom operations maintain center point, screenToWorld roundtrip accuracy</verify>
  <done>Hook provides all navigation methods, zoom calculations are accurate, coordinate transforms work</done>
</task>

<task type="auto">
  <name>Task 3: Implement useGridSnap Hook</name>
  <files>src/hooks/useGridSnap.ts</files>
  <action>
Create hook for grid snapping functionality:

1. Accept GridConfig and canvas scale as parameters

2. Implement snap methods:
   - snapToGrid(point: Point2D): Snap x,y to nearest grid intersection
   - snapToMinor(point: Point2D): Snap to minor grid lines
   - snapToMajor(point: Point2D): Snap to major grid lines
   - isNearSnapPoint(point: Point2D, threshold: number): Boolean check

3. Grid calculation:
   - Calculate grid spacing in screen pixels based on zoom
   - Don't render minor lines if spacing < 5px (performance)
   - Calculate visible grid range from viewBox

4. Snap logic:
   - Round coordinate to nearest grid multiple
   - Apply snap only if snapEnabled is true
   - Support different snap modes (minor/major)

5. Return snap function and grid visibility check

Use memoization for expensive calculations. Support fractional grid sizes.
  </action>
  <verify>Test snapToGrid with various inputs, verify correct rounding behavior</verify>
  <done>Hook snaps coordinates correctly, handles zoom scaling, respects snapEnabled flag</done>
</task>

<task type="auto">
  <name>Task 4: Create GridSystem Component</name>
  <files>src/components/BIMWorkbench/GridSystem.tsx</files>
  <action>
Create SVG grid overlay component:

1. Props interface:
   - config: GridConfig
   - viewBox: ViewBox
   - zoom: number

2. Calculate visible grid range:
   - Determine which grid lines intersect current viewBox
   - Generate line coordinates for minor and major grids
   - Optimize: limit to ~100 lines for performance

3. Render SVG group:
   - Major grid lines: stroke=config.majorColor, strokeWidth=1
   - Minor grid lines: stroke=config.minorColor, strokeWidth=0.5
   - Use pattern or individual lines based on performance testing
   - Clip to viewBox to avoid rendering off-screen lines

4. Grid visibility:
   - Don't render if config.visible is false
   - Smooth fade transition when toggling

5. Support dynamic grid sizing:
   - Auto-adjust major/minor based on zoom level
   - At high zoom (>5x), show more detailed grid
   - At low zoom (<0.5x), show only major lines

Use React.memo for performance. Optimize line generation with useMemo.
  </action>
  <verify>Render component with test viewBox, visually inspect grid lines align with coordinates</verify>
  <done>Grid renders correctly with major/minor lines, visibility toggle works, performance acceptable</done>
</task>

<task type="auto">
  <name>Task 5: Create CoordinateDisplay Component</name>
  <files>src/components/BIMWorkbench/CoordinateDisplay.tsx</files>
  <action>
Create mouse coordinate display component:

1. Props interface:
   - mousePosition: Point2D (screen coordinates)
   - worldPosition: Point2D (transformed coordinates)
   - isDistanceMode: boolean
   - distanceStart?: Point2D

2. Display format:
   - X: [value] mm
   - Y: [value] mm
   - Format to 1 decimal place
   - Right-align numeric values

3. Distance mode:
   - When isDistanceMode is true and distanceStart is set:
   - Calculate dx = current.x - start.x
   - Calculate dy = current.y - start.y
   - Show total distance: sqrt(dx² + dy²)
   - Show delta X and delta Y separately

4. Styling:
   - Fixed position (bottom-left of canvas)
   - Semi-transparent background
   - Monospace font for alignment
   - Compact layout

5. Update on mouse move:
   - Use requestAnimationFrame for smooth updates
   - Debounce if performance issues arise

Return JSX with coordinate readout. Support dark/light mode.
  </action>
  <verify>Test component with mock coordinates, verify formatting and distance calculation</verify>
  <done>Coordinate display shows X/Y in mm, distance mode calculates correctly, styling matches design</done>
</task>

<task type="auto">
  <name>Task 6: Create CanvasControls Component</name>
  <files>src/components/BIMWorkbench/CanvasControls.tsx</files>
  <action>
Create canvas control toolbar component:

1. Props interface:
   - onZoomIn: () => void
   - onZoomOut: () => void
   - onFitToView: () => void
   - onResetView: () => void
   - onToggleGrid: () => void
   - onToggleSnap: () => void
   - gridVisible: boolean
   - snapEnabled: boolean
   - zoom: number

2. Control buttons (vertical toolbar):
   - Zoom In (+ icon)
   - Zoom Out (- icon)
   - Fit to View (expand icon)
   - Reset View (home icon)
   - Separator line
   - Toggle Grid (grid icon, active state)
   - Toggle Snap (magnet icon, active state)

3. Display:
   - Current zoom percentage (e.g., "100%")
   - Fixed position (top-right of canvas)

4. Tooltips:
   - Show on hover for each button
   - Keyboard shortcuts if applicable

5. Styling:
   - Compact button size (32x32px)
   - Active state for toggled buttons
   - Hover effects
   - Dark theme matching workbench

Use Lucide icons. Buttons have aria-labels for accessibility.
  </action>
  <verify>Test each button triggers correct callback, verify active states display correctly</verify>
  <done>All control buttons work, zoom percentage displays, active states visible, tooltips present</done>
</task>

<task type="auto">
  <name>Task 7: Create useSelectionRectangle Hook</name>
  <files>src/hooks/useSelectionRectangle.ts</files>
  <action>
Create hook for click-drag selection rectangle:

1. State:
   - selectionRect: SelectionRect | null
   - isSelecting: boolean

2. Methods:
   - startSelection(screenX, screenY): Begin selection at point
   - updateSelection(screenX, screenY): Update end point while dragging
   - endSelection(): Finalize selection, return bounds
   - cancelSelection(): Abort selection

3. Selection logic:
   - Only activate on left mouse button
   - Require minimum drag distance (5px) to start
   - Calculate rectangle from start to current position
   - Support both directions (start can be any corner)

4. Return values:
   - selectionRect: Current rectangle bounds
   - isSelecting: Whether active
   - startSelection, updateSelection, endSelection methods
   - getSelectedBounds(): Normalized rectangle (min/max)

5. Cleanup:
   - Clear selection on mouse up
   - Handle mouse leave gracefully

Support modifier keys (Ctrl, Shift) for future multi-select.
  </action>
  <verify>Test selection start/update/end cycle, verify bounds calculation handles all directions</verify>
  <done>Selection rectangle tracks correctly, minimum drag threshold respected, bounds normalized</done>
</task>

<task type="auto">
  <name>Task 8: Create DraftingCanvas Component</name>
  <files>src/components/BIMWorkbench/DraftingCanvas.tsx, src/styles/drafting-canvas.css</files>
  <action>
Create main SVG drafting canvas component integrating all features:

1. Props interface:
   - width?: number (default: 100%)
   - height?: number (default: 100%)
   - gridConfig?: Partial<GridConfig>
   - onSelectionChange?: (bounds: Bounds | null) => void

2. Initialize hooks:
   - useCanvasNavigation for pan/zoom
   - useSelectionRectangle for selection
   - GridConfig state with defaults

3. Event handlers:
   - onMouseDown:
     - Middle button: Start pan
     - Left button: Start selection (if not on control)
   - onMouseMove:
     - Update pan if active
     - Update selection if active
     - Update coordinate display
   - onMouseUp:
     - End pan or selection
   - onWheel:
     - Prevent default
     - Call wheelZoom with mouse position
   - onContextMenu: Prevent default (right-click menu)

4. SVG structure:
   - Root <svg> with dynamic viewBox from navigation hook
   - <defs> for patterns/gradients
   - <GridSystem> layer (behind)
   - <g id="drawing-layer"> (for future shapes)
   - <SelectionRectangle> overlay (when active)
   - <CoordinateDisplay> overlay

5. Coordinate tracking:
   - Track mouse position in screen and world coordinates
   - Pass world coordinates to CoordinateDisplay

6. CSS styling:
   - Canvas fills container
   - Cursor: grab (default), grabbing (panning), crosshair (selecting)
   - Prevent text selection during drag
   - Dark background (#1a1a1a)

7. Export component with forwardRef for external control.

Handle all edge cases: mouse leaving window, rapid clicks, etc.
  </action>
  <verify>Test full interaction: pan, zoom, selection, grid toggle, coordinate tracking</verify>
  <done>Canvas responds to all interactions, grid displays correctly, selection rectangle works, coordinates accurate</done>
</task>

<task type="auto">
  <name>Task 9: Export and Document Canvas Components</name>
  <files>src/components/BIMWorkbench/index.ts</files>
  <action>
Update BIM Workbench exports to include canvas components:

1. Add exports to src/components/BIMWorkbench/index.ts:
   - export { DraftingCanvas } from './DraftingCanvas'
   - export { GridSystem } from './GridSystem'
   - export { CoordinateDisplay } from './CoordinateDisplay'
   - export { CanvasControls } from './CanvasControls'
   - export type { CanvasState, GridConfig, Point2D, ViewBox, SelectionRect } from '../../types/drafting'

2. Add hook exports to src/hooks/index.ts:
   - export { useCanvasNavigation } from './useCanvasNavigation'
   - export { useGridSnap } from './useGridSnap'
   - export { useSelectionRectangle } from './useSelectionRectangle'

3. Verify imports work:
   - Create a quick integration check importing all exports
   - Ensure no circular dependencies

4. Add JSDoc comments to main exports describing usage.

Ensure all types are properly re-exported for external use.
  </action>
  <verify>Import test passes, all exports are accessible, no TypeScript errors</verify>
  <done>All components and hooks exported, imports work correctly, documentation added</done>
</task>

</tasks>

<verification>
1. **Functional Verification:**
   - Middle-click drag pans the canvas smoothly
   - Mouse wheel zooms centered on cursor position
   - Grid lines display with major/minor distinction
   - Grid visibility toggle works instantly
   - Snap toggle enables/disables grid snapping
   - Coordinate display updates in real-time
   - Click-drag creates selection rectangle
   - Fit to view and reset view buttons work

2. **Visual Verification:**
   - Grid lines render crisply at all zoom levels
   - Selection rectangle has proper visual feedback
   - Controls are accessible and styled consistently
   - Canvas fills container responsively

3. **Performance Verification:**
   - Pan/zoom maintains 60fps
   - Grid rendering optimized (no off-screen lines)
   - No memory leaks on unmount

4. **Type Safety:**
   - All components have proper prop types
   - No TypeScript errors in strict mode
   - Hooks return typed values
</verification>

<success_criteria>
- DraftingCanvas renders SVG with configurable viewBox
- Pan, zoom, and fit-to-view work with smooth interaction
- GridSystem displays configurable major/minor grid lines
- Grid visibility can be toggled on/off
- CoordinateDisplay shows mouse position in world coordinates (mm)
- SelectionRectangle allows click-drag selection with visual feedback
- CanvasControls provide zoom buttons, fit view, and grid/snap toggles
- All hooks (useCanvasNavigation, useGridSnap, useSelectionRectangle) are reusable
- Canvas integrates cleanly with BIM Workbench shell
- Type definitions exported for external use
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-05-SUMMARY.md`

Document:
- Canvas navigation implementation details
- Grid system configuration options
- Selection rectangle behavior
- Hook APIs and return values
- Any performance optimizations applied
- Known limitations or future enhancements
</output>
