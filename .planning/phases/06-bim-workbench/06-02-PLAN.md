---
phase: 06-bim-workbench
plan: 02
type: execute
wave: 1
depends_on:
  - 06-01
files_modified:
  - frontend/src/stores/useBIMStore.ts
autonomous: true
must_haves:
  truths:
    - All store errors are fixed and TypeScript compiles without errors
    - Undo/redo command pattern works correctly with history tracking
    - Project can be exported to and imported from JSON format
    - Auto-save functionality saves project state periodically
    - Box selection, invert selection, and select by layer/type work correctly
    - All store actions are type-safe and callable from components
  artifacts:
    - path: frontend/src/stores/useBIMStore.ts
      provides: Complete state store with fixed errors and enhanced features
      min_lines: 750
    - path: frontend/src/stores/useBIMStore.ts
      contains: "export const useBIMStore = create<BIMStore>((set, get) =>"
    - path: frontend/src/stores/useBIMStore.ts
      contains: "exportProject.*JSON"
    - path: frontend/src/stores/useBIMStore.ts
      contains: "importProject.*JSON"
    - path: frontend/src/stores/useBIMStore.ts
      contains: "boxSelect"
    - path: frontend/src/stores/useBIMStore.ts
      contains: "invertSelection"
    - path: frontend/src/stores/useBIMStore.ts
      contains: "selectByLayer"
    - path: frontend/src/stores/useBIMStore.ts
      contains: "selectByType"
  key_links:
    - from: BIMStore interface
      to: store implementation
      via: TypeScript type safety
      pattern: "All interface methods are implemented in create()"
    - from: Command pattern
      to: undo/redo functionality
      via: executeCommand with history tracking
      pattern: "commands array and currentCommandIndex state"
    - from: project state
      to: auto-save
      via: localStorage persistence
      pattern: "setInterval with project state serialization"
---

## Objective

Enhance the existing useBIMStore.ts with additional state management features needed for full BIM functionality, fixing all existing errors and adding advanced capabilities.

**Purpose:** Provide a robust, error-free state management foundation for the BIM Workbench with advanced features like command history, serialization, and enhanced selection tools.

**Output:** A fully functional, TypeScript-compliant state store with all actions working correctly and new capabilities for project serialization and advanced selection.

## Execution Context

@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md

## Context

@/home/tomas/Ceiling Panel Spacer/frontend/src/stores/useBIMStore.ts

### Current Store Issues

The existing useBIMStore.ts has several critical issues that prevent proper functionality:

1. **Missing `get` function**: The store uses `get()` for accessing state in async actions and selectors, but the `get` parameter is not destructured from the `create` callback (line 188: `create<BIMStore>((set) => ({` should be `create<BIMStore>((set, get) => ({`))

2. **Functions defined outside store**: `toggleSidebar`, `setSidebarWidth`, `togglePropertiesPanel`, `setPropertiesPanelObject`, and all selector functions (`getActiveProject`, `getSelectedObjects`, etc.) are defined after the store closure (lines 537-609), making them inaccessible to the store's internal state

3. **Syntax errors**: The `updateObject2D` function has an extra closing parenthesis (line 376), and `redo()` references undefined `get()`

4. **Incomplete command pattern**: The command execution system has history but lacks proper command description and batching support

## Tasks

<task type="auto">
  <name>Task 1: Fix Existing Store Errors</name>
  <files>frontend/src/stores/useBIMStore.ts</files>
  <action>
    Fix all critical errors in the existing useBIMStore.ts:
    
    1. Add `get` parameter to the create callback:
       - Change line 188 from `create<BIMStore>((set) => ({`
       - To: `create<BIMStore>((set, get) => ({`
    
    2. Move all functions currently defined after line 609 into the store object:
       - Move `toggleSidebar` (lines 537-544)
       - Move `setSidebarWidth` (lines 546-553)
       - Move `togglePropertiesPanel` (lines 555-562)
       - Move `setPropertiesPanelObject` (lines 564-566)
       - Move all selector functions (lines 572-608) into the store actions object
       - Ensure they all have proper type annotations in the BIMStore interface
    
    3. Fix syntax error in `updateObject2D`:
       - Line 376 has extra closing parenthesis `}))`
       - Change to `})`
    
    4. Verify `saveProject` uses `get()` correctly after the parameter is available
    
    5. Verify `undo()` and `redo()` properly use `get()` to access current state
    
    6. Add missing interface declarations for moved functions:
       - Add `toggleSidebar: () => void`
       - Add `setSidebarWidth: (width: number) => void`
       - Add `togglePropertiesPanel: () => void`
       - Add `setPropertiesPanelObject: (object: BIMObject | null) => void`
       - Add `getActiveProject: () => BIMProject | undefined`
       - Add `getSelectedObjects: () => BIMObject[]`
       - Add `getActiveObject: () => BIMObject | null`
       - Add `getObjectsByType: (type: BIMObject['type']) => BIMObject[]`
       - Add `getObjectsByLayer: (layerId: string) => BIMObject[]`
       - Add `getCanUndo: () => boolean`
       - Add `getCanRedo: () => boolean`
    
    After fixes, run TypeScript check to ensure no compilation errors.
  </action>
  <verify>cd frontend && npx tsc --noEmit src/stores/useBIMStore.ts</verify>
  <done>TypeScript compiles without errors, all functions are inside the store object, and `get` is properly available throughout the store</done>
</task>

<task type="auto">
  <name>Task 2: Add Command Pattern Enhancements</name>
  <files>frontend/src/stores/useBIMStore.ts</files>
  <action>
    Enhance the command pattern system with better execution, batching, and descriptions:
    
    1. Update CommandHistory interface to include description:
       ```typescript
       export interface CommandHistory {
         id: string
         action: string
         description: string  // NEW: Human-readable description for UI
         object: BIMObject | null
         previousState: any
         newState: any
         timestamp: string
         batchId?: string     // NEW: For grouping batched commands
       }
       ```
    
    2. Add command batch tracking state:
       ```typescript
       // In BIMStore interface
       commandBatch: {
         isBatching: boolean
         batchId: string | null
         commands: CommandHistory[]
       }
       
       // In store state
       commandBatch: {
         isBatching: false,
         batchId: null,
         commands: [],
       }
       ```
    
    3. Implement command batching actions:
       ```typescript
       startCommandBatch: () => void
       endCommandBatch: () => void
       ```
       - startCommandBatch: Generates batchId, sets isBatching to true
       - endCommandBatch: Creates single command from batched commands, clears batch state
    
    4. Update `executeCommand` to support batching:
       - If batching is active, add command to batch.commands
       - If not batching, execute immediately as before
       - Always include description parameter
    
    5. Add command metadata actions:
       ```typescript
       getCommandHistory: () => CommandHistory[]
       clearCommandHistory: () => void
       getLastCommandDescription: () => string | null
       ```
    
    6. Fix undo/redo to properly handle command descriptions:
       - Ensure undo reverts to previousState correctly
       - Ensure redo applies newState correctly
       - Handle edge cases (empty history, at beginning/end)
       
    7. Add proper command state management:
       - When executing new command, truncate future history if not at end
       - Ensure currentCommandIndex always points to valid position
  </action>
  <verify>
    cd frontend && npx tsc --noEmit src/stores/useBIMStore.ts && 
    grep -q "description: string" src/stores/useBIMStore.ts &&
    grep -q "commandBatch" src/stores/useBIMStore.ts &&
    grep -q "startCommandBatch" src/stores/useBIMStore.ts &&
    grep -q "endCommandBatch" src/stores/useBIMStore.ts &&
    grep -q "getCommandHistory" src/stores/useBIMStore.ts
  </verify>
  <done>Command pattern supports batching with batchId, includes descriptions, has proper undo/redo state management, and all new actions compile correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add Project Serialization</name>
  <files>frontend/src/stores/useBIMStore.ts</files>
  <action>
    Implement project export/import functionality and auto-save:
    
    1. Create exportProject action:
       ```typescript
       exportProject: () => string  // Returns JSON string
       ```
       - Serializes: project, objects, layers, view settings, tool settings
       - Include metadata: export timestamp, version, application info
       - Format as pretty-printed JSON with 2-space indentation
       - Structure:
         ```typescript
         {
           version: '2.1.0',
           exportedAt: ISO timestamp,
           application: 'Savage BIM Workbench',
           data: {
             project: BIMProject,
             objects: BIMObject[],
             layers: BIMLayer[],
             view: ViewSettings,
             toolSettings: BIMStore['toolSettings'],
             canvas2D: BIMStore['canvas2D'],
           }
         }
         ```
    
    2. Create importProject action:
       ```typescript
       importProject: (jsonData: string) => void
       ```
       - Parse JSON and validate structure
       - Validate version compatibility (warn if major version mismatch)
       - Restore all state: project, objects, layers, view, toolSettings
       - Clear command history on import
       - Handle errors with try/catch and log to console
       - Validate required fields exist before importing
    
    3. Create downloadProject action:
       ```typescript
       downloadProject: (filename?: string) => void
       ```
       - Generate JSON via exportProject
       - Create Blob with application/json MIME type
       - Create temporary download link and trigger click
       - Default filename: `{project.name}-v{version}-{date}.bim.json`
    
    4. Create loadProjectFromFile action:
       ```typescript
       loadProjectFromFile: (file: File) => Promise<void>
       ```
       - Read File using FileReader API
       - Parse content and call importProject
       - Handle read errors and JSON parse errors
       - Return Promise for async/await compatibility
    
    5. Implement auto-save functionality:
       ```typescript
       autoSave: {
         enabled: boolean
         interval: number  // milliseconds
         lastSaved: string | null
       }
       
       // Actions
       toggleAutoSave: () => void
       setAutoSaveInterval: (interval: number) => void
       saveToLocalStorage: () => void
       loadFromLocalStorage: () => boolean  // Returns true if loaded
       ```
       
       - Auto-save to localStorage with key 'savage-bim-autosave'
       - Serialize same data as exportProject
       - Use setInterval in store initialization if autoSave.enabled
       - Load from localStorage on store initialization if data exists
       - Update lastSaved timestamp on each save
    
    6. Add serialization-related interfaces to BIMStore:
       - All new actions listed above
       - autoSave state structure
    
    7. Add validation helper:
       ```typescript
       validateProjectData: (data: any) => { valid: boolean; errors: string[] }
       ```
       - Check required fields exist
       - Validate data types
       - Return validation result with any error messages
  </action>
  <verify>
    cd frontend && npx tsc --noEmit src/stores/useBIMStore.ts &&
    grep -q "exportProject" src/stores/useBIMStore.ts &&
    grep -q "importProject" src/stores/useBIMStore.ts &&
    grep -q "downloadProject" src/stores/useBIMStore.ts &&
    grep -q "loadProjectFromFile" src/stores/useBIMStore.ts &&
    grep -q "autoSave" src/stores/useBIMStore.ts &&
    grep -q "localStorage" src/stores/useBIMStore.ts
  </verify>
  <done>Project can be exported to JSON, imported from JSON, downloaded as file, loaded from file, and auto-saved to localStorage with proper validation</done>
</task>

<task type="auto">
  <name>Task 4: Add Selection Enhancements</name>
  <files>frontend/src/stores/useBIMStore.ts</files>
  <action>
    Implement advanced selection capabilities for the BIM Workbench:
    
    1. Add box selection support:
       ```typescript
       // Add to BIMStore interface
       boxSelect: (bounds: { minX: number; minY: number; maxX: number; maxY: number }, mode?: 'replace' | 'add' | 'remove') => void
       ```
       - Calculate 2D bounding boxes for all objects
       - Select objects whose bounds intersect with selection box
       - Support three modes:
         - 'replace': Clear current selection, select intersecting (default)
         - 'add': Add intersecting to current selection
         - 'remove': Remove intersecting from current selection
       - Work with both canvas2D and 3D scene objects
       - Use object position and approximate size for intersection test
    
    2. Add invert selection:
       ```typescript
       invertSelection: () => void
       ```
       - Select all currently unselected objects
       - Deselect all currently selected objects
       - Efficiently swap selection state
    
    3. Add select by layer:
       ```typescript
       selectByLayer: (layerId: string, mode?: 'replace' | 'add') => void
       ```
       - Find all objects with matching layer ID
       - Select them according to mode ('replace' or 'add')
       - If layer doesn't exist, log warning and do nothing
    
    4. Add select by type:
       ```typescript
       selectByType: (type: BIMObject['type'], mode?: 'replace' | 'add') => void
       ```
       - Find all objects with matching type
       - Support all BIMObject types: 'wall' | 'beam' | 'column' | 'slab' | 'door' | 'window' | 'stairs' | 'roof' | 'panel' | 'site' | 'building' | 'level' | 'point' | 'line' | 'polyline' | 'rectangle' | 'circle' | 'arc'
       - Select them according to mode
    
    5. Add select all:
       ```typescript
       selectAll: () => void
       ```
       - Select all objects in the scene
    
    6. Add deselect by criteria:
       ```typescript
       deselectByLayer: (layerId: string) => void
       deselectByType: (type: BIMObject['type']) => void
       ```
       - Remove objects matching criteria from current selection
    
    7. Add selection set management:
       ```typescript
       // Add to state
       selectionSets: { id: string; name: string; objectIds: string[] }[]
       
       // Add to interface
       saveSelectionSet: (name: string) => void
       loadSelectionSet: (setId: string) => void
       deleteSelectionSet: (setId: string) => void
       renameSelectionSet: (setId: string, newName: string) => void
       getSelectionSets: () => { id: string; name: string; count: number }[]
       ```
       - Allow saving current selection as named set
       - Restore saved selection sets
       - Manage selection set lifecycle
    
    8. Add selection validation helper:
       ```typescript
       getSelectionBounds: () => { minX: number; minY: number; maxX: number; maxY: number; minZ: number; maxZ: number } | null
       ```
       - Calculate bounding box of all selected objects
       - Return null if no selection
       - Useful for zoom-to-selection and other operations
    
    9. Add isSelected helper:
       ```typescript
       isObjectSelected: (objectId: string) => boolean
       ```
       - Check if specific object is in current selection
  </action>
  <verify>
    cd frontend && npx tsc --noEmit src/stores/useBIMStore.ts &&
    grep -q "boxSelect" src/stores/useBIMStore.ts &&
    grep -q "invertSelection" src/stores/useBIMStore.ts &&
    grep -q "selectByLayer" src/stores/useBIMStore.ts &&
    grep -q "selectByType" src/stores/useBIMStore.ts &&
    grep -q "selectAll" src/stores/useBIMStore.ts &&
    grep -q "selectionSets" src/stores/useBIMStore.ts &&
    grep -q "getSelectionBounds" src/stores/useBIMStore.ts
  </verify>
  <done>All selection enhancements are implemented: box selection, invert, select by layer/type, select all, selection sets, and selection bounds calculation</done>
</task>

<task type="auto">
  <name>Task 5: Add Final Type Safety and Integration</name>
  <files>frontend/src/stores/useBIMStore.ts</files>
  <action>
    Ensure complete type safety and add final integration touches:
    
    1. Add comprehensive type exports:
       - Ensure all interfaces are exported: BIMObject, BIMProject, BIMLayer, SnapPoint, CommandHistory, ViewSettings
       - Add new interface exports: SelectionSet, ExportData, AutoSaveState
    
    2. Add utility type for selection mode:
       ```typescript
       export type SelectionMode = 'replace' | 'add' | 'remove'
       ```
    
    3. Update BIMObject interface to include bounds for intersection tests:
       ```typescript
       // Add optional computed property
       bounds?: {
         minX: number; minY: number; minZ: number
         maxX: number; maxY: number; maxZ: number
       }
       ```
    
    4. Add constants for auto-save:
       ```typescript
       const AUTOSAVE_KEY = 'savage-bim-autosave'
       const DEFAULT_AUTOSAVE_INTERVAL = 30000  // 30 seconds
       const MAX_COMMAND_HISTORY = 100  // Limit history to prevent memory issues
       ```
    
    5. Add cleanup on import/new project:
       - Clear command history
       - Reset selection
       - Clear clipboard
       - Reset view to default if needed
    
    6. Add computed getters that use get():
       ```typescript
       // These should use get() to access current state
       getSelectedObjects: () => BIMObject[]
       getActiveObject: () => BIMObject | null
       getCanUndo: () => boolean
       getCanRedo: () => boolean
       getSelectionCount: () => number
       getObjectCount: () => number
       getLayerCount: () => number
       ```
    
    7. Ensure all state mutations use proper Zustand patterns:
       - Always use set() or get() from the create callback
       - Never mutate state directly
       - Use spread operator for object updates
       - Use map/filter for array updates
    
    8. Add error handling for edge cases:
       - Handle null project in export
       - Handle invalid JSON in import
       - Handle missing objects in selection operations
       - Handle empty arrays gracefully
    
    9. Run final TypeScript check and fix any remaining errors
    
    10. Verify store is importable and usable:
        - Check that `import { useBIMStore } from './useBIMStore'` works
        - Verify all actions are accessible
  </action>
  <verify>
    cd frontend && npx tsc --noEmit src/stores/useBIMStore.ts &&
    grep -q "export type" src/stores/useBIMStore.ts &&
    grep -q "SelectionMode" src/stores/useBIMStore.ts &&
    grep -q "AUTOSAVE_KEY" src/stores/useBIMStore.ts &&
    grep -q "MAX_COMMAND_HISTORY" src/stores/useBIMStore.ts &&
    grep -q "getSelectionCount" src/stores/useBIMStore.ts &&
    grep -q "getObjectCount" src/stores/useBIMStore.ts &&
    wc -l src/stores/useBIMStore.ts | awk '{print $1}' | xargs -I {} test {} -ge 750 && echo "File has 750+ lines"
  </verify>
  <done>All types are properly exported, constants are defined, computed getters work correctly, final TypeScript check passes, and store has 750+ lines with all features</done>
</task>

## Verification

### Overall Phase Checks

After completing all tasks:

1. **TypeScript Compilation**:
   ```bash
   cd frontend && npx tsc --noEmit src/stores/useBIMStore.ts
   ```
   - Must complete with zero errors

2. **Feature Verification**:
   - All original store functions work (createProject, addObject, etc.)
   - New functions are accessible (boxSelect, exportProject, etc.)
   - Undo/redo maintains proper state
   - Auto-save persists to localStorage

3. **Import/Export Test**:
   - Export project creates valid JSON
   - Import project restores all state
   - File download works in browser
   - File upload parses correctly

4. **Selection Test**:
   - Box selection selects intersecting objects
   - Invert selection swaps selection state
   - Select by layer/type filters correctly
   - Selection sets save and restore

## Success Criteria

### Measurable Completion

1. **Error-Free Compilation**:
   - TypeScript compiles useBIMStore.ts with zero errors
   - No ESLint warnings related to the store

2. **All Functions Accessible**:
   - `get()` is available throughout the store
   - All UI actions (toggleSidebar, etc.) work correctly
   - All selector functions return correct data

3. **Command Pattern Complete**:
   - Commands have descriptions
   - Batching works (startCommandBatch/endCommandBatch)
   - Undo/redo properly traverses history
   - History is limited to prevent memory issues

4. **Serialization Working**:
   - exportProject() returns valid JSON string
   - importProject() restores complete state
   - downloadProject() triggers file download
   - loadProjectFromFile() parses uploaded files
   - Auto-save persists to localStorage every 30 seconds

5. **Selection Features Complete**:
   - boxSelect() with all three modes works
   - invertSelection() swaps selection
   - selectByLayer() and selectByType() filter correctly
   - Selection sets save and restore
   - Selection bounds calculate correctly

6. **Code Quality**:
   - Store file has 750+ lines (was 610, added ~150+ for new features)
   - All interfaces are exported
   - Consistent error handling throughout
   - Proper TypeScript types on all functions

## Output

After completion, create: `.planning/phases/06-bim-workbench/06-02-SUMMARY.md`

Include in summary:
- All errors fixed
- Command pattern enhancements added
- Project serialization features implemented
- Selection enhancements added
- Final line count
- Any deviations from plan
