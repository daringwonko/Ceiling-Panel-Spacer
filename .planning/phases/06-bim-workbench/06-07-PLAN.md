---
phase: 06-bim-workbench
plan: 07
type: execute
wave: 2
depends_on: ["06-06"]
files_modified: [
  "bim_workbench/drafting/polyline_tool.py",
  "bim_workbench/drafting/polygon_tool.py",
  "bim_workbench/drafting/ellipse_tool.py",
  "bim_workbench/drafting/bspline_tool.py",
  "bim_workbench/drafting/bezier_tool.py",
  "bim_workbench/drafting/point_tool.py",
  "bim_workbench/drafting/__init__.py"
]
autonomous: true

must_haves:
  truths:
    - "Polyline tool creates connected line segments with preview"
    - "Polygon tool creates regular polygons from center and radius"
    - "Ellipse tool fits ellipses in defined rectangles"
    - "B-spline tool creates smooth curves through control points"
    - "Bézier tool creates cubic curves with control handles"
    - "Point tool places crosshair markers on single click"
  artifacts:
    - path: "bim_workbench/drafting/polyline_tool.py"
      provides: "Polyline drafting tool"
      exports: ["PolylineTool"]
    - path: "bim_workbench/drafting/polygon_tool.py"
      provides: "Polygon drafting tool"
      exports: ["PolygonTool"]
    - path: "bim_workbench/drafting/ellipse_tool.py"
      provides: "Ellipse drafting tool"
      exports: ["EllipseTool"]
    - path: "bim_workbench/drafting/bspline_tool.py"
      provides: "B-spline curve tool"
      exports: ["BSplineTool"]
    - path: "bim_workbench/drafting/bezier_tool.py"
      provides: "Bézier curve tool"
      exports: ["BezierTool"]
    - path: "bim_workbench/drafting/point_tool.py"
      provides: "Point marker tool"
      exports: ["PointTool"]
  key_links:
    - from: "bim_workbench/drafting/__init__.py"
      to: "all tool modules"
      via: "import and register"
      pattern: "from \\.polyline_tool import"
---

<objective>
Implement advanced 2D drafting tools to extend the BIM Workbench drawing capabilities. These six tools provide comprehensive geometric primitive creation for technical drawings: Polyline for complex connected shapes, Polygon for regular polygons, Ellipse for curved boundaries, B-spline and Bézier for free-form curves, and Point for precise markers.

Purpose: Enable complete 2D drafting workflow with advanced geometric primitives beyond basic rectangles and circles.
Output: Six fully functional drafting tools with interactive previews and precise geometry creation.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior wave established base drafting infrastructure
@.planning/phases/06-bim-workbench/06-06-SUMMARY.md

# Base tool class and patterns from Wave 1
@bim_workbench/drafting/base_draft_tool.py
@bim_workbench/drafting/line_tool.py

# Tool system architecture
@bim_workbench/tools/tool_manager.py
@bim_workbench/tools/base_tool.py

# Drawing utilities
@bim_workbench/utils/geometry.py
@bim_workbench/utils/draw_utils.py

# Reference implementation patterns
@bim_workbench/drafting/rectangle_tool.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Polyline Tool</name>
  <files>bim_workbench/drafting/polyline_tool.py, bim_workbench/drafting/__init__.py</files>
  <action>
Create PolylineTool class extending BaseDraftTool.

Implementation:
1. Create PolylineTool class with:
   - Tool name: "polyline"
   - Display name: "Polyline"
   - Icon: polyline icon path

2. State management:
   - vertices: List of 2D points
   - current_vertex: Temporary point during drag
   - is_closed: Boolean for closed polyline

3. Input handling:
   - Left-click: Add vertex at click position
   - Double-click: Finish polyline
   - Enter key: Finish polyline
   - Right-click: Remove last vertex or cancel
   - C key: Toggle close polyline (connect last to first)

4. Preview rendering:
   - Draw lines between all added vertices
   - Draw rubber-band line from last vertex to mouse cursor
   - Show small square markers at each vertex
   - If is_closed, show dashed line from last to first vertex

5. Geometry creation:
   - On finish, create PolylineEntity with vertices list
   - Support open and closed polylines
   - Store in drawing as single entity

6. Update __init__.py to export PolylineTool

7. Register tool in ToolManager via tool_registration.py
  </action>
  <verify>
Run tests: python -m pytest tests/test_drafting/ -v -k polyline
Check: python -c "from bim_workbench.drafting import PolylineTool; t = PolylineTool(); print('PolylineTool created')"
Verify: Tool appears in tool palette and can be selected
  </verify>
  <done>
PolylineTool class exists with vertex management, preview rendering shows connected segments, left-click adds vertices, double-click finishes, and polyline entity is created on completion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Polygon Tool</name>
  <files>bim_workbench/drafting/polygon_tool.py, bim_workbench/drafting/__init__.py</files>
  <action>
Create PolygonTool class for regular polygon creation.

Implementation:
1. Create PolygonTool class with:
   - Tool name: "polygon"
   - Display name: "Polygon"
   - Default number of sides: 6

2. State management:
   - center: 2D point for polygon center
   - radius: Distance from center to vertices
   - num_sides: Integer (3-100, default 6)
   - inscribed: Boolean (True=radius to vertex, False=radius to edge midpoint)

3. Input handling:
   - First click: Set center point
   - Drag: Define radius (distance from center)
   - Second click: Confirm radius and create polygon
   - Number keys (3-9): Set number of sides during drag
   - Tab key: Toggle inscribed/circumscribed mode
   - I/C keys: Set inscribed/circumscribed mode

4. Preview rendering:
   - Show center point marker
   - Show radius line from center to cursor
   - Show polygon outline with current radius
   - Display number of sides and mode (inscribed/circumscribed) in status
   - Show circle outline for radius reference

5. Geometry calculation:
   - For inscribed: radius = given radius
   - For circumscribed: radius = given_radius / cos(π/num_sides)
   - Calculate vertices: center + radius * (cos(θ), sin(θ)) for θ in 0 to 2π
   - Angle increment: 2π / num_sides

6. Geometry creation:
   - Create PolygonEntity with calculated vertices
   - Store center, radius, num_sides as properties

7. Update __init__.py to export PolygonTool

8. Register tool in ToolManager
  </action>
  <verify>
Run tests: python -m pytest tests/test_drafting/ -v -k polygon
Check: python -c "from bim_workbench.drafting import PolygonTool; t = PolygonTool(); print('PolygonTool created')"
Verify: Can create hexagons, pentagons, octagons with correct geometry
  </verify>
  <done>
PolygonTool creates regular polygons from center and radius, supports inscribed/circumscribed modes, allows changing number of sides interactively, and generates correct vertex positions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Ellipse Tool</name>
  <files>bim_workbench/drafting/ellipse_tool.py, bim_workbench/drafting/__init__.py</files>
  <action>
Create EllipseTool class for ellipse creation by axis definition.

Implementation:
1. Create EllipseTool class with:
   - Tool name: "ellipse"
   - Display name: "Ellipse"

2. State management:
   - State enum: FIRST_AXIS_START, FIRST_AXIS_END, SECOND_AXIS
   - first_axis_start: 2D point
   - first_axis_end: 2D point (defines major axis)
   - second_axis_length: Distance for minor axis
   - center: Calculated center point
   - rotation: Angle of first axis

3. Input handling:
   - First click: Set first axis start point
   - Drag: Define first axis length and orientation
   - Second click: Confirm first axis
   - Drag (third phase): Define second axis length
   - Third click: Confirm and create ellipse
   - Hold Shift: Constrain first axis to 45° increments
   - Escape: Cancel current operation

4. Preview rendering:
   - Phase 1: Show line from start point to cursor (first axis)
   - Phase 2: Show completed first axis, perpendicular line for second axis
   - Phase 3: Show complete ellipse preview with both axes
   - Show axis lines as dashed
   - Show center point marker

5. Geometry calculation:
   - center = (first_axis_start + first_axis_end) / 2
   - major_radius = |first_axis_end - first_axis_start| / 2
   - minor_radius = second_axis_length / 2
   - rotation = atan2(first_axis_end.y - first_axis_start.y, first_axis_end.x - first_axis_start.x)
   - Generate ellipse points using parametric equation

6. Geometry creation:
   - Create EllipseEntity with center, major_radius, minor_radius, rotation
   - Store both axis endpoints for reference

7. Update __init__.py to export EllipseTool

8. Register tool in ToolManager
  </action>
  <verify>
Run tests: python -m pytest tests/test_drafting/ -v -k ellipse
Check: python -c "from bim_workbench.drafting import EllipseTool; t = EllipseTool(); print('EllipseTool created')"
Verify: Can create ellipses with various axis ratios and orientations
  </verify>
  <done>
EllipseTool creates ellipses via three-click workflow (first axis start/end, second axis length), shows accurate preview, supports axis constraints, and generates correct parametric ellipse geometry.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create B-spline Tool</name>
  <files>bim_workbench/drafting/bspline_tool.py, bim_workbench/drafting/__init__.py</files>
  <action>
Create BSplineTool class for B-spline curve creation.

Implementation:
1. Create BSplineTool class with:
   - Tool name: "bspline"
   - Display name: "B-spline"

2. State management:
   - control_points: List of 2D control points
   - degree: Integer (2=cubic, 3=quadratic, default 3)
   - knots: Knot vector for B-spline
   - is_clamped: Boolean for clamped ends

3. Input handling:
   - Left-click: Add control point
   - Double-click: Finish curve
   - Enter key: Finish curve
   - Right-click: Remove last control point
   - Number keys (2,3): Set degree (2=quadratic, 3=cubic)
   - Escape: Cancel
   - Minimum 3 points required to finish

4. B-spline calculation:
   - Implement Cox-de Boor recursion for basis functions
   - Generate uniform knot vector: [0,0,0,1,2,...,n,n,n] for degree 3
   - Calculate curve points: C(t) = Σ N_i,p(t) * P_i
   - Sample t from 0 to 1 with appropriate step size
   - Support degree 2 (quadratic) and 3 (cubic)

5. Preview rendering:
   - Show control polygon (lines connecting control points)
   - Show small circles at each control point
   - Draw B-spline curve through calculated points
   - Highlight first/last control points
   - Show degree indicator in status bar

6. Geometry creation:
   - Create BSplineEntity with control_points, degree, knots
   - Store curve samples for rendering

7. Update __init__.py to export BSplineTool

8. Register tool in ToolManager

9. Add scipy import handling (optional dependency):
   - Try: from scipy.interpolate import BSpline
   - Fallback: Pure Python implementation
  </action>
  <verify>
Run tests: python -m pytest tests/test_drafting/ -v -k bspline
Check: python -c "from bim_workbench.drafting import BSplineTool; t = BSplineTool(); print('BSplineTool created')"
Verify: Can create smooth curves through multiple control points, degree changes affect curve shape
  </verify>
  <done>
BSplineTool creates smooth B-spline curves from control points, implements Cox-de Boor algorithm, supports quadratic and cubic degrees, shows control polygon and curve preview, and generates accurate spline geometry.
  </done>
</task>

<task type="auto">
  <name>Task 5: Create Bézier Curve Tool</name>
  <files>bim_workbench/drafting/bezier_tool.py, bim_workbench/drafting/__init__.py</files>
  <action>
Create BezierTool class for cubic Bézier curve creation.

Implementation:
1. Create BezierTool class with:
   - Tool name: "bezier"
   - Display name: "Bézier Curve"

2. State management:
   - State enum: START_POINT, CONTROL1, CONTROL2, END_POINT
   - start_point: 2D point
   - control1: First control point
   - control2: Second control point
   - end_point: End point
   - Current state tracking

3. Input handling:
   - First click: Set start point
   - Second click: Set first control point
   - Third click: Set second control point
   - Fourth click: Set end point and create curve
   - Escape: Cancel current step or reset
   - Backspace: Go back one step

4. Bézier curve calculation (cubic):
   - B(t) = (1-t)³P₀ + 3(1-t)²tP₁ + 3(1-t)t²P₂ + t³P₃
   - P₀ = start_point, P₃ = end_point
   - P₁, P₂ = control points
   - Sample t from 0 to 1 with step 0.01 (100 points)
   - Ensure smooth curve with sufficient samples

5. Preview rendering:
   - Show start point (square marker)
   - Show control points (circle markers)
   - Show end point (square marker)
   - Draw control handles (dashed lines from start to control1, control2 to end)
   - Draw current Bézier curve based on placed points
   - In CONTROL2 state: Show curve preview with current mouse as end point

6. Geometry creation:
   - Create BezierCurveEntity with start, control1, control2, end
   - Store curve samples for rendering

7. Update __init__.py to export BezierTool

8. Register tool in ToolManager

9. Add degree option for quadratic Bézier (optional):
   - Q key: Toggle between cubic and quadratic
   - Quadratic: Single control point, B(t) = (1-t)²P₀ + 2(1-t)tP₁ + t²P₂
  </action>
  <verify>
Run tests: python -m pytest tests/test_drafting/ -v -k bezier
Check: python -c "from bim_workbench.drafting import BezierTool; t = BezierTool(); print('BezierTool created')"
Verify: Can create cubic Bézier curves with visible control handles, curve follows control points correctly
  </verify>
  <done>
BezierTool creates cubic Bézier curves via four-click workflow (start, control1, control2, end), shows control handles and curve preview, implements correct Bézier interpolation formula, and generates smooth curve geometry.
  </done>
</task>

<task type="auto">
  <name>Task 6: Create Point Tool</name>
  <files>bim_workbench/drafting/point_tool.py, bim_workbench/drafting/__init__.py</files>
  <action>
Create PointTool class for simple point marker placement.

Implementation:
1. Create PointTool class with:
   - Tool name: "point"
   - Display name: "Point"
   - Immediate execution (single click)

2. State management:
   - Minimal state (tool is stateless per point)
   - marker_style: Crosshair, dot, plus, or circle
   - marker_size: Size in pixels (default 8)

3. Input handling:
   - Left-click: Place point at cursor position
   - Right-click: Cancel/exit tool (optional)
   - Number keys: Change marker size (1-9 scale factor)
   - S key: Cycle through marker styles
   - Tool remains active for multiple point placement

4. Point rendering styles:
   - Crosshair: Horizontal and vertical lines through point
   - Dot: Small filled circle
   - Plus: '+' shape at point
   - Circle: Small empty circle outline
   - Default: Crosshair

5. Style properties:
   - Size: Base size 8px, adjustable
   - Color: Use layer color or default
   - Line width: 1-2 pixels

6. Geometry creation:
   - Create PointEntity at click location
   - Store position, style, size
   - Add to drawing immediately on click
   - Tool remains active for next point

7. Snap integration:
   - Respect grid snap setting
   - Respect object snap (endpoint, midpoint, etc.)
   - Show snap indicator when active

8. Update __init__.py to export PointTool

9. Register tool in ToolManager
  </action>
  <verify>
Run tests: python -m pytest tests/test_drafting/ -v -k point
Check: python -c "from bim_workbench.drafting import PointTool; t = PointTool(); print('PointTool created')"
Verify: Can place multiple points with single clicks, marker styles render correctly, tool remains active after placement
  </verify>
  <done>
PointTool places point markers on single click, supports multiple marker styles (crosshair, dot, plus, circle), respects snap settings, tool stays active for rapid point placement, and generates PointEntity for each marker.
  </done>
</task>

</tasks>

<verification>
1. **Tool Availability:** All six tools appear in tool palette
   - Verify: Polyline, Polygon, Ellipse, B-spline, Bézier, Point visible

2. **Polyline Functionality:**
   - Add multiple vertices via click
   - Preview shows connected segments
   - Double-click finishes
   - Close option works (connects last to first)

3. **Polygon Functionality:**
   - Center-click + radius drag creates polygon
   - Number of sides adjustable
   - Inscribed/circumscribed modes work
   - Regular polygons generated correctly

4. **Ellipse Functionality:**
   - Three-click workflow works
   - Preview shows axes
   - Various axis ratios create correct ellipses
   - Rotation handled properly

5. **B-spline Functionality:**
   - Multiple control points create smooth curve
   - Control polygon visible
   - Degree affects curve shape
   - Curve passes near control points

6. **Bézier Functionality:**
   - Four-point workflow works
   - Control handles visible
   - Curve follows control points
   - Smooth curve generated

7. **Point Functionality:**
   - Single-click placement
   - Multiple points without reselecting tool
   - Marker styles render correctly

8. **Test Suite:** All tests pass
   - Run: python -m pytest tests/test_drafting/test_advanced_tools.py -v
</verification>

<success_criteria>
All success criteria must be met:

1. **Six Tools Created:**
   - PolylineTool, PolygonTool, EllipseTool, BSplineTool, BezierTool, PointTool exist
   - Each in separate file with proper exports

2. **Interactive Previews:**
   - All tools show real-time preview during creation
   - Preview updates on mouse move
   - Visual feedback clear and accurate

3. **Correct Geometry:**
   - Generated shapes match user input precisely
   - Mathematical calculations verified (polygon angles, ellipse axes, curve interpolation)

4. **Tool Integration:**
   - All tools registered in ToolManager
   - Accessible from UI tool palette
   - Consistent with base tool patterns

5. **Test Coverage:**
   - Unit tests for each tool
   - Geometry calculation tests
   - User interaction tests
   - All tests passing

6. **Documentation:**
   - Docstrings for all classes and methods
   - Usage examples in docstrings
   - Tool help text defined
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-07-SUMMARY.md` with:
- List of 6 tools created
- Key features of each tool
- Testing summary
- Any deviations from plan
</output>
