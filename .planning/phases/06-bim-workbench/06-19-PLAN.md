---
phase: "06-bim-workbench"
plan: "06-19"
name: "Project Export & Schedules"
type: "execute"
wave: 5
autonomous: true
depends_on: ["06-18"]
files_modified: [
  "frontend/src/utils/projectExport.ts",
  "frontend/src/utils/projectImport.ts",
  "frontend/src/components/Schedules/SchedulePanel.tsx",
  "frontend/src/components/Schedules/ScheduleTable.tsx",
  "frontend/src/hooks/useSchedules.ts",
  "frontend/src/services/quantityCalculator.ts",
  "frontend/src/types/schedules.ts",
  "backend/api/schedules.py",
  "backend/utils/quantity_takeoff.py"
]
must_haves: {
  truths: [
    "Users can export complete projects to JSON with all objects, materials, and views",
    "Users can import projects from JSON files",
    "Door, window, and custom schedules auto-generate from model data",
    "Quantity takeoff calculates areas, volumes, and material quantities",
    "Schedules export to CSV/Excel format"
  ],
  artifacts: [
    ".planning/phases/06-bim-workbench/06-19-SUMMARY.md"
  ]
}
---

# Plan 06-19: Project Export & Schedules

## Objective

Implement project-level export and quantity schedules for the BIM workbench.

**What this plan will deliver:**
- Complete project export/import to JSON format
- Auto-generated quantity schedules (doors, windows, materials)
- Quantity takeoff calculations (areas, volumes)
- Schedule export to CSV/Excel

## Context

From BIM_Workbench.md:
- Schedule tool creates quantity schedules
- Export project data

Existing foundation:
- useBIMStore has basic project structure
- BIM objects have properties that can be scheduled

## Tasks

### Task 1: Create Project Export System
**Type:** auto
**Files:** `frontend/src/utils/projectExport.ts`, `frontend/src/utils/projectImport.ts`

Create complete project serialization:

```typescript
// Project export format
interface ExportedProject {
  version: string;
  metadata: {
    name: string;
    description: string;
    created: string;
    exported: string;
    author: string;
  };
  units: {
    length: 'mm' | 'cm' | 'm';
    area: 'm2' | 'ft2';
    volume: 'm3' | 'ft3';
  };
  site?: SiteData;
  buildings: BuildingData[];
  levels: LevelData[];
  objects: BIMObjectData[];
  materials: MaterialData[];
  layers: LayerData[];
  views: ViewData[];
  sections: SectionPlaneData[];
}

// Export functions
export function exportProject(project: BIMProject): ExportedProject
export function downloadProject(project: BIMProject, filename?: string): void
export function importProject(data: ExportedProject): BIMProject
export function loadProjectFromFile(file: File): Promise<BIMProject>
```

Features:
- Export all project data to JSON
- Include geometry, properties, materials, layers
- Download as .json or .savagebim file
- Import with validation
- Version compatibility checking

### Task 2: Create Schedule System
**Type:** auto
**Files:** `frontend/src/types/schedules.ts`, `frontend/src/services/quantityCalculator.ts`

Define schedule types and calculation logic:

```typescript
// Schedule types
interface ScheduleDefinition {
  id: string;
  name: string;
  type: 'door' | 'window' | 'material' | 'custom';
  columns: ScheduleColumn[];
  filter?: (obj: BIMObject) => boolean;
}

interface ScheduleColumn {
  key: string;
  header: string;
  width: number;
  accessor: (obj: BIMObject) => any;
}

interface ScheduleRow {
  id: string;
  count: number;
  type: string;
  dimensions: string;
  material: string;
  // ... other properties
}

// Predefined schedules
const doorSchedule: ScheduleDefinition = {
  id: 'door-schedule',
  name: 'Door Schedule',
  type: 'door',
  columns: [
    { key: 'count', header: 'Count', width: 80, accessor: obj => 1 },
    { key: 'type', header: 'Type', width: 150, accessor: obj => obj.properties.type },
    { key: 'width', header: 'Width', width: 100, accessor: obj => `${obj.properties.width}mm` },
    { key: 'height', header: 'Height', width: 100, accessor: obj => `${obj.properties.height}mm` },
    { key: 'material', header: 'Material', width: 150, accessor: obj => obj.material },
  ],
  filter: obj => obj.type === 'door'
}
```

Quantity calculations:
```typescript
export function calculateAreas(objects: BIMObject[]): AreaCalculation[]
export function calculateVolumes(objects: BIMObject[]): VolumeCalculation[]
export function calculateMaterialQuantities(objects: BIMObject[]): MaterialQuantity[]
export function generateSchedule(definition: ScheduleDefinition, objects: BIMObject[]): ScheduleRow[]
```

### Task 3: Create Schedule Panel UI
**Type:** auto
**Files:** `frontend/src/components/Schedules/SchedulePanel.tsx`, `frontend/src/components/Schedules/ScheduleTable.tsx`

Create schedule management interface:

```tsx
// SchedulePanel.tsx
export function SchedulePanel() {
  const [schedules, setSchedules] = useState<ScheduleDefinition[]>([])
  const [activeSchedule, setActiveSchedule] = useState<ScheduleDefinition | null>(null)
  const objects = useBIMStore(state => state.objects)
  
  // Predefined schedules
  const predefinedSchedules = [doorSchedule, windowSchedule, materialSchedule]
  
  return (
    <div className="schedule-panel">
      <ScheduleList 
        schedules={[...predefinedSchedules, ...schedules]}
        activeSchedule={activeSchedule}
        onSelect={setActiveSchedule}
      />
      {activeSchedule && (
        <ScheduleTable 
          definition={activeSchedule}
          data={generateSchedule(activeSchedule, objects)}
        />
      )}
    </div>
  )
}

// ScheduleTable.tsx
export function ScheduleTable({ definition, data }: ScheduleTableProps) {
  return (
    <table className="schedule-table">
      <thead>
        <tr>
          {definition.columns.map(col => (
            <th key={col.key} style={{ width: col.width }}>{col.header}</th>
          ))}
        </tr>
      </thead>
      <tbody>
        {data.map((row, idx) => (
          <tr key={row.id}>
            {definition.columns.map(col => (
              <td key={col.key}>{row[col.key]}</td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
  )
}
```

Features:
- List of available schedules
- Generate schedule from current model
- Edit schedule columns
- Export to CSV
- Print-friendly view

### Task 4: Create Quantity Takeoff
**Type:** auto
**Files:** `frontend/src/services/quantityCalculator.ts`, `backend/utils/quantity_takeoff.py`

Implement quantity calculations:

```typescript
export interface QuantityResult {
  category: string;
  item: string;
  count: number;
  unit: string;
  total: number;
  unitCost?: number;
  totalCost?: number;
}

export function calculateWallAreas(walls: WallObject[]): QuantityResult[] {
  return walls.map(wall => ({
    category: 'Walls',
    item: wall.name,
    count: 1,
    unit: 'mÂ²',
    total: (wall.properties.length * wall.properties.height) / 1000000,
    unitCost: wall.properties.unitCost,
    totalCost: ((wall.properties.length * wall.properties.height) / 1000000) * wall.properties.unitCost
  }))
}

export function calculateConcreteVolumes(slabs: SlabObject[], walls: WallObject[]): QuantityResult[] {
  // Calculate concrete volumes
}

export function generateFullQuantityTakeoff(project: BIMProject): QuantityResult[] {
  // Combine all calculations
}
```

Python backend support:
```python
# backend/utils/quantity_takeoff.py
def calculate_areas(objects: List[BIMObject]) -> List[Dict]:
    """Calculate surface areas for all objects"""
    
def calculate_volumes(objects: List[BIMObject]) -> List[Dict]:
    """Calculate volumes for 3D objects"""
    
def generate_schedule(object_type: str, objects: List[BIMObject]) -> List[Dict]:
    """Generate schedule for specific object type"""
```

### Task 5: Add Export Features
**Type:** auto
**Files:** `frontend/src/components/Schedules/ExportButtons.tsx`, `frontend/src/utils/csvExport.ts`

Create export functionality:

```typescript
// Export to CSV
export function exportScheduleToCSV(schedule: ScheduleDefinition, data: ScheduleRow[]): string {
  const headers = schedule.columns.map(col => col.header).join(',')
  const rows = data.map(row => 
    schedule.columns.map(col => row[col.key]).join(',')
  )
  return [headers, ...rows].join('\n')
}

// Export to Excel (via backend)
export async function exportScheduleToExcel(schedule: ScheduleDefinition, data: ScheduleRow[]): Promise<Blob> {
  const response = await fetch('/api/bim/schedules/export/excel', {
    method: 'POST',
    body: JSON.stringify({ schedule, data })
  })
  return response.blob()
}

// Export full report
export function generateProjectReport(project: BIMProject): ProjectReport {
  return {
    summary: {
      totalObjects: project.objects.length,
      totalMaterials: project.materials.length,
      siteArea: calculateSiteArea(project.site),
      buildingArea: calculateBuildingArea(project.buildings)
    },
    schedules: {
      doors: generateSchedule(doorSchedule, project.objects),
      windows: generateSchedule(windowSchedule, project.objects),
      materials: generateMaterialSchedule(project.objects)
    },
    quantities: generateFullQuantityTakeoff(project)
  }
}
```

## Verification

### Verification Steps
1. Create test project with doors, windows, walls
2. Export project to JSON - verify all data included
3. Import project from JSON - verify all data restored
4. Generate door schedule - verify counts and dimensions correct
5. Generate window schedule - verify all windows included
6. Calculate wall areas - verify calculations accurate
7. Export schedule to CSV - verify file format correct
8. Generate full project report - verify all sections present

### Test Checklist
- [ ] Project export includes all objects
- [ ] Project import restores all data
- [ ] Door schedule counts are correct
- [ ] Window schedule shows all types
- [ ] Wall area calculations are accurate
- [ ] CSV export produces valid file
- [ ] Report generation includes all sections
- [ ] Error handling for invalid files

## Success Criteria

1. **Project Export**: Users can export complete projects to JSON
2. **Project Import**: Users can import projects from JSON files
3. **Door Schedule**: Auto-generated door schedule with counts, types, dimensions
4. **Window Schedule**: Auto-generated window schedule with all properties
5. **Material Schedule**: Schedule showing material quantities
6. **Quantity Takeoff**: Accurate area and volume calculations
7. **CSV Export**: Schedules export to CSV format
8. **Report Generation**: Full project reports with all data

## Output

After completing this plan, update `.planning/phases/06-bim-workbench/06-19-SUMMARY.md` with:
- Export/import features implemented
- Schedule types available
- Quantity calculations supported
- Export formats supported
- Any deviations or issues encountered
