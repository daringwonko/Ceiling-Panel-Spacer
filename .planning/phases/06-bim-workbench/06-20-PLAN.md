---
phase: 06-bim-workbench
plan: 20
type: execute
wave: 6
depends_on: ['06-19']
files_modified:
  - src/bim/components/UndoRedo/index.tsx
  - src/bim/components/UndoRedo/types.ts
  - src/bim/hooks/useUndoRedo.ts
  - src/bim/hooks/useKeyboardShortcuts.ts
  - src/bim/components/ShortcutsHelp/ShortcutsHelp.tsx
  - src/bim/components/ShortcutsHelp/index.tsx
  - src/bim/components/CommandPalette/CommandPalette.tsx
  - src/bim/components/CommandPalette/index.tsx
  - src/bim/utils/keyboard.ts
  - src/bim/utils/autoSave.ts
  - src/bim/services/AutoSaveService.ts
  - src/bim/types/commands.ts
  - src/bim/constants/shortcuts.ts
  - src/bim/workbench/KeyboardShortcuts.tsx
  - src/bim/workbench/CommandPalette.tsx
autonomous: true
must_haves:
  truths:
    - "Undo/redo works reliably for all commands with proper descriptions"
    - "Keyboard shortcuts work via hotkeys-js for all common operations"
    - "Tool shortcuts (L, R, C, etc.) activate corresponding tools immediately"
    - "Shortcuts help modal is searchable and categorized"
    - "Command palette opens with Ctrl+Shift+P and lists all commands"
    - "Auto-save runs every 2 minutes with crash recovery"
  artifacts:
    - path: "src/bim/hooks/useUndoRedo.ts"
      provides: "Enhanced undo/redo with stack management"
    - path: "src/bim/hooks/useKeyboardShortcuts.ts"
      provides: "Keyboard shortcut registration with hotkeys-js"
    - path: "src/bim/components/ShortcutsHelp/ShortcutsHelp.tsx"
      provides: "Searchable shortcuts reference modal"
    - path: "src/bim/components/CommandPalette/CommandPalette.tsx"
      provides: "Command search and execution palette"
    - path: "src/bim/services/AutoSaveService.ts"
      provides: "Automatic saving with recovery"
    - path: "src/bim/constants/shortcuts.ts"
      provides: "Centralized shortcut definitions"
  key_links:
    - from: "useKeyboardShortcuts"
      to: "hotkeys-js"
      via: "hotkeys() registration"
    - from: "CommandPalette"
      to: "useKeyboardShortcuts"
      via: "Ctrl+Shift+P binding"
    - from: "AutoSaveService"
      to: "localStorage"
      via: "saveState() / loadState()"
---

<objective>
Implement comprehensive keyboard shortcuts and enhance undo/redo system.

Purpose: Professional CAD tools require efficient keyboard-driven workflows. The undo/redo system is critical for user confidence and error recovery. This plan delivers a polished, professional-grade keyboard shortcut system.

Output: Complete keyboard shortcut system with hotkeys-js integration, enhanced undo/redo with command history UI, searchable shortcuts help, command palette, and auto-save functionality.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/bim/components/UndoRedo/index.tsx
@src/bim/hooks/useUndoRedo.ts

## Phase Context
- Phase 6 is the BIM Workbench implementation
- Wave 6 is the final polish and integration wave
- This is Plan 20 of 21, completing keyboard and undo system polish
- All core functionality is in place; this adds professional finishing touches

## Dependencies
All previous BIM plans (06-01 through 06-19) must be complete, including:
- All tools (line, rectangle, circle, arc, wall, door)
- Transform tools (move, scale, rotate)
- File operations (save, open, new)
- Selection system
- Existing basic undo/redo hook

## Technology
- hotkeys-js for keyboard shortcut handling
- React hooks for state management
- localStorage for auto-save/recovery
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Undo/Redo System</name>
  <files>
    src/bim/hooks/useUndoRedo.ts
    src/bim/components/UndoRedo/index.tsx
    src/bim/components/UndoRedo/types.ts
  </files>
  <action>
Enhance the existing undo/redo system with the following features:

1. Fix existing implementation:
   - Ensure undo/redo works reliably for all command types
   - Add proper TypeScript types for commands
   - Handle edge cases (empty stack, stack full)

2. Add command descriptions:
   - Each command should have a human-readable description (e.g., "Draw Line", "Move Element")
   - Store description with each history entry
   - Display descriptions in UI

3. Show undo stack in UI:
   - Create a dropdown or panel showing recent commands
   - Allow clicking to jump to specific point in history
   - Show stack position indicator

4. Limit stack size to 100 commands:
   - When stack exceeds 100, remove oldest entries
   - Maintain integrity of remaining stack
   - Provide visual indication when approaching limit

5. Group related commands:
   - Group consecutive operations of same type (e.g., multiple line segments)
   - Show group as single entry (e.g., "Draw 5 Lines")
   - Allow expanding group to see individual commands

Update types.ts with Command interface including description, timestamp, and group info. Update the hook to manage grouped commands and stack limits. Update the UI component to display the stack with descriptions and grouping.
  </action>
  <verify>
    - Unit tests pass: npm test -- useUndoRedo
    - Undo/redo works for all command types in manual testing
    - Stack limit of 100 enforced
    - UI shows command descriptions and groups
  </verify>
  <done>
    Enhanced undo/redo hook manages 100-command limit, groups consecutive commands, and displays descriptions. UI shows undo stack with ability to navigate history.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Core Keyboard Shortcuts</name>
  <files>
    src/bim/hooks/useKeyboardShortcuts.ts
    src/bim/constants/shortcuts.ts
    src/bim/utils/keyboard.ts
  </files>
  <action>
Install and configure hotkeys-js for keyboard shortcut handling:

1. Install hotkeys-js:
   ```bash
   npm install hotkeys-js
   ```

2. Create constants/shortcuts.ts with shortcut definitions:
   ```typescript
   export const CORE_SHORTCUTS = {
     UNDO: { key: 'ctrl+z', description: 'Undo last action' },
     REDO: { key: 'ctrl+y', description: 'Redo last action' },
     SAVE: { key: 'ctrl+s', description: 'Save project' },
     OPEN: { key: 'ctrl+o', description: 'Open project' },
     NEW: { key: 'ctrl+n', description: 'New project' },
     DELETE: { key: 'delete', description: 'Delete selected' },
     ESCAPE: { key: 'esc', description: 'Cancel current tool' },
     SPACE: { key: 'space', description: 'Repeat last tool' },
   };
   ```

3. Create hooks/useKeyboardShortcuts.ts:
   - Initialize hotkeys with scope management
   - Register core shortcuts
   - Handle Mac vs Windows modifiers (Cmd vs Ctrl)
   - Prevent default for browser shortcuts (Ctrl+S, Ctrl+O)
   - Return register/unregister functions

4. Create utils/keyboard.ts:
   - Helper to normalize key names
   - Platform detection (Mac/Windows/Linux)
   - Shortcut formatting for display

The hook should integrate with existing BIM context to call the appropriate actions (undo, redo, save, etc.).
  </action>
  <verify>
    - hotkeys-js installed and imported correctly
    - All core shortcuts (Ctrl+Z, Ctrl+Y, Ctrl+S, etc.) work
    - Browser defaults prevented for file operations
    - Platform-specific modifiers work correctly
  </verify>
  <done>
    useKeyboardShortcuts hook initializes hotkeys-js and registers all core shortcuts. Shortcuts trigger correct actions in the BIM workbench.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Tool Shortcuts</name>
  <files>
    src/bim/constants/shortcuts.ts
    src/bim/hooks/useKeyboardShortcuts.ts
    src/bim/context/BIMContext.tsx
  </files>
  <action>
Add tool activation shortcuts:

1. Extend constants/shortcuts.ts with tool shortcuts:
   ```typescript
   export const TOOL_SHORTCUTS = {
     LINE: { key: 'l', description: 'Line tool', toolId: 'line' },
     RECTANGLE: { key: 'r', description: 'Rectangle tool', toolId: 'rectangle' },
     CIRCLE: { key: 'c', description: 'Circle tool', toolId: 'circle' },
     ARC: { key: 'a', description: 'Arc tool', toolId: 'arc' },
     WALL: { key: 'w', description: 'Wall tool', toolId: 'wall' },
     DOOR: { key: 'd', description: 'Door tool', toolId: 'door' },
     MOVE: { key: 'm', description: 'Move tool', toolId: 'move' },
     SCALE: { key: 's', description: 'Scale tool', toolId: 'scale' },
   };
   ```

2. Update useKeyboardShortcuts.ts:
   - Register all tool shortcuts
   - Call setActiveTool() from BIM context when shortcut pressed
   - Track last used tool for spacebar repeat
   - Disable tool shortcuts when typing in input fields (input/textarea focus)

3. Add to BIMContext:
   - lastTool state to track last active tool
   - setLastTool action
   - Update lastTool whenever activeTool changes

4. Implement spacebar repeat:
   - When space pressed, activate lastTool
   - Show toast notification: "Repeated: Line Tool"
   - If no last tool, show "No tool to repeat"

Ensure shortcuts only work when canvas is focused, not when typing in property panels or dialogs.
  </action>
  <verify>
    - All tool shortcuts (L, R, C, A, W, D, M, S) activate correct tools
    - Spacebar repeats last used tool
    - Shortcuts disabled during text input
    - Tool activation shows visual feedback
  </verify>
  <done>
    All 8 tool shortcuts implemented and working. Spacebar repeats last tool. Context tracks last tool state.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Shortcuts Help Modal</name>
  <files>
    src/bim/components/ShortcutsHelp/ShortcutsHelp.tsx
    src/bim/components/ShortcutsHelp/index.tsx
    src/bim/components/ShortcutsHelp/ShortcutsHelp.module.css
  </files>
  <action>
Create a comprehensive shortcuts help modal:

1. Create components/ShortcutsHelp/ShortcutsHelp.tsx:
   - Modal component with overlay
   - Search input at top (filter shortcuts by key or description)
   - Categorized sections:
     * General (New, Open, Save, Undo, Redo)
     * Tools (Line, Rectangle, Circle, Arc, Wall, Door, Move, Scale)
     * Navigation (Pan, Zoom, etc.)
     * Selection (Select All, Deselect, Delete)
   - Each shortcut shows: key combination + description
   - Close button and Escape to close
   - Keyboard shortcut: ? or F1 to open

2. Implement search:
   - Real-time filtering as user types
   - Search across keys and descriptions
   - Highlight matching text
   - Show "No results" message when empty

3. Create categories data structure:
   ```typescript
   interface ShortcutCategory {
     name: string;
     shortcuts: Array<{
       key: string;
       description: string;
       context?: string;
     }>;
   }
   ```

4. Add printable cheat sheet:
   - "Print" button opens print dialog
   - Styled for single-page printing
   - Condensed layout with all shortcuts

5. Style with CSS module:
   - Clean, readable layout
   - Category headers distinct
   - Keyboard keys styled as badges
   - Responsive design

6. Export from index.tsx and integrate into BIM workbench toolbar (help button).
  </action>
  <verify>
    - Modal opens with ? or F1 key
    - Search filters shortcuts correctly
    - All categories display with correct shortcuts
    - Print button generates printable page
    - Modal closes with Escape or close button
  </verify>
  <done>
    ShortcutsHelp component displays all keyboard shortcuts in searchable, categorized modal. Print functionality works. Accessible via ? key.
  </done>
</task>

<task type="auto">
  <name>Task 5: Implement Command Palette</name>
  <files>
    src/bim/components/CommandPalette/CommandPalette.tsx
    src/bim/components/CommandPalette/index.tsx
    src/bim/components/CommandPalette/CommandPalette.module.css
    src/bim/types/commands.ts
  </files>
  <action>
Create a command palette similar to VS Code:

1. Create types/commands.ts:
   ```typescript
   export interface Command {
     id: string;
     name: string;
     description: string;
     shortcut?: string;
     category: 'file' | 'edit' | 'view' | 'tool' | 'help';
     icon?: string;
     action: () => void;
   }
   ```

2. Create components/CommandPalette/CommandPalette.tsx:
   - Overlay modal with search input at top
   - List of commands below search
   - Fuzzy search matching command names
   - Recently used commands section at top
   - Each command shows: icon, name, shortcut, category
   - Keyboard navigation: arrow keys + Enter to execute
   - Close on Escape or click outside
   - Maximum 10 results shown

3. Register command palette shortcut:
   - Ctrl+Shift+P to open
   - Also accessible via menu

4. Implement command registry:
   - All BIM commands registered (file ops, tools, view commands)
   - Commands reference existing actions from context
   - Recently used tracked in session

5. Add fuzzy search:
   - Match against command name and description
   - Score results by relevance
   - Highlight matched characters

6. Style with CSS module:
   - VS Code-inspired dark theme
   - Selected item highlighted
   - Keyboard shortcuts shown on right
   - Clean typography

7. Integrate into BIM workbench:
   - Add to App shell
   - Ensure shortcut works globally
   - Commands execute in correct context

Example commands to include: New Project, Open Project, Save, Save As, Undo, Redo, Cut, Copy, Paste, all tool activations, Zoom In, Zoom Out, Fit to Screen, Toggle Grid, Toggle Snapping, Show Shortcuts Help, etc.
  </action>
  <verify>
    - Ctrl+Shift+P opens command palette
    - Search filters commands with fuzzy matching
    - Arrow keys navigate, Enter executes
    - Recently used commands appear at top
    - All commands execute correctly
    - Palette closes after command execution
  </verify>
  <done>
    CommandPalette component provides searchable access to all BIM commands with keyboard navigation. Integrates with BIM context to execute actions.
  </done>
</task>

<task type="auto">
  <name>Task 6: Implement Auto-Save</name>
  <files>
    src/bim/services/AutoSaveService.ts
    src/bim/utils/autoSave.ts
    src/bim/components/AutoSaveIndicator/AutoSaveIndicator.tsx
    src/bim/hooks/useAutoSave.ts
  </files>
  <action>
Implement automatic saving with crash recovery:

1. Create services/AutoSaveService.ts:
   ```typescript
   export class AutoSaveService {
     private intervalId: number | null = null;
     private readonly INTERVAL_MS = 2 * 60 * 1000; // 2 minutes
     
     start(projectId: string, getState: () => ProjectState): void {
       // Save immediately then every 2 minutes
       this.save(projectId, getState());
       this.intervalId = window.setInterval(() => {
         this.save(projectId, getState());
       }, this.INTERVAL_MS);
     }
     
     stop(): void {
       if (this.intervalId) {
         clearInterval(this.intervalId);
         this.intervalId = null;
       }
     }
     
     private save(projectId: string, state: ProjectState): void {
       const autoSaveKey = `bim_autosave_${projectId}`;
       localStorage.setItem(autoSaveKey, JSON.stringify({
         state,
         timestamp: Date.now(),
         version: '1.0'
       }));
     }
     
     load(projectId: string): ProjectState | null {
       const autoSaveKey = `bim_autosave_${projectId}`;
       const data = localStorage.getItem(autoSaveKey);
       return data ? JSON.parse(data).state : null;
     }
     
     hasRecoveryData(projectId: string): boolean {
       return localStorage.getItem(`bim_autosave_${projectId}`) !== null;
     }
     
     clear(projectId: string): void {
       localStorage.removeItem(`bim_autosave_${projectId}`);
     }
   }
   ```

2. Create hooks/useAutoSave.ts:
   - Initialize AutoSaveService when project loaded
   - Stop on unmount
   - Provide recovery check on mount
   - Return: lastSaved timestamp, isDirty flag

3. Create components/AutoSaveIndicator/AutoSaveIndicator.tsx:
   - Small status indicator in toolbar
   - Shows: Saved checkmark, Saving spinner, or Unsaved dot
   - Hover shows last saved time
   - Click to force save

4. Implement recovery flow:
   - On app load, check for recovery data
   - If found, show modal: "Recover unsaved work from [timestamp]?"
   - Options: Recover, Discard, Ignore
   - If recovered, load state and clear auto-save

5. Add dirty state tracking:
   - Track if project has unsaved changes
   - Set dirty on any modification
   - Clear dirty on manual save
   - Show confirmation dialog on close if dirty

6. Handle storage limits:
   - Limit auto-save history to 5 projects
   - Remove oldest when limit reached
   - Show warning if storage full

7. Add keyboard shortcut:
   - Ctrl+S triggers immediate save and resets timer

Integrate into BIM workbench - service instantiated on project open, indicator shown in status bar.
  </action>
  <verify>
    - Auto-save runs every 2 minutes
    - Recovery modal appears when recovery data exists
    - Unsaved changes indicator updates correctly
    - Recovery loads correct state
    - Ctrl+S triggers immediate save
  </verify>
  <done>
    AutoSaveService saves project state every 2 minutes to localStorage. Recovery dialog appears on app load if recovery data exists. Unsaved changes indicator visible in UI.
  </done>
</task>

</tasks>

<verification>
1. **Undo/Redo Verification:**
   - Execute multiple commands (draw lines, move, delete)
   - Press Ctrl+Z repeatedly - each undo reverses one command with description
   - Press Ctrl+Y to redo
   - Open undo stack panel - shows all commands with timestamps
   - Verify stack limited to 100 entries

2. **Keyboard Shortcuts Verification:**
   - Test each core shortcut (Ctrl+Z, Ctrl+Y, Ctrl+S, Ctrl+O, Ctrl+N, Delete, Escape)
   - Test each tool shortcut (L, R, C, A, W, D, M, S)
   - Press spacebar - should repeat last tool
   - Verify browser defaults prevented for Ctrl+S/Ctrl+O

3. **Shortcuts Help Verification:**
   - Press ? key - shortcuts modal opens
   - Type in search box - filters shortcuts
   - Click Print - generates printable page
   - Press Escape - modal closes

4. **Command Palette Verification:**
   - Press Ctrl+Shift+P - palette opens
   - Type "line" - line command appears
   - Press Enter - line tool activates
   - Navigate with arrows - selection highlights

5. **Auto-Save Verification:**
   - Make changes, wait 2 minutes
   - Check localStorage - auto-save entry exists
   - Close and reopen app
   - Recovery dialog appears
   - Click Recover - changes restored

6. **Integration Verification:**
   - All shortcuts work in full BIM workbench
   - No conflicts between shortcuts
   - Undo/redo integrates with all commands
</verification>

<success_criteria>
1. **Undo/Redo System:**
   - Undo/redo works for 100% of commands
   - Stack properly limited to 100 commands
   - Command descriptions visible in UI
   - Grouped commands display correctly

2. **Keyboard Shortcuts:**
   - All 16+ shortcuts (core + tools) functional
   - hotkeys-js properly integrated
   - Platform modifiers (Ctrl/Cmd) work
   - Spacebar repeat functions

3. **Help System:**
   - Shortcuts modal searchable and categorized
   - Print functionality generates clean cheat sheet
   - Accessible via ? key

4. **Command Palette:**
   - Opens with Ctrl+Shift+P
   - Fuzzy search finds commands
   - Keyboard navigation works
   - All BIM commands accessible

5. **Auto-Save:**
   - Saves every 2 minutes automatically
   - Recovery dialog appears on crash
   - Unsaved changes indicator visible
   - Manual save (Ctrl+S) resets timer

6. **Quality:**
   - No console errors
   - TypeScript types complete
   - Unit tests for hooks and services
   - No shortcut conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-20-SUMMARY.md` with:

1. **Summary:** Keyboard shortcuts and undo/redo system complete
2. **Completed Work:**
   - Enhanced undo/redo with descriptions, grouping, 100-limit
   - hotkeys-js integration with 16+ shortcuts
   - Searchable shortcuts help modal
   - VS Code-style command palette
   - Auto-save service with recovery
3. **Key Files:**
   - src/bim/hooks/useKeyboardShortcuts.ts
   - src/bim/components/ShortcutsHelp/
   - src/bim/components/CommandPalette/
   - src/bim/services/AutoSaveService.ts
   - src/bim/constants/shortcuts.ts
4. **Shortcuts Reference:**
   - Table of all keyboard shortcuts
   - Categories: General, Tools, Navigation
5. **Next Steps:**
   - Plan 21: Final testing and documentation
</output>
