---
phase: 06-bim-workbench
plan: 14
type: execute
wave: 4
depends_on: ["06-08", "06-09"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "User can create aligned dimensions between two points"
    - "User can create horizontal and vertical dimensions"
    - "User can dimension circles and arcs with radius"
    - "User can measure angles between three points"
    - "User can add text labels to the drawing"
    - "User can create leader lines with arrows"
    - "Dimension text updates when objects move"
  artifacts:
    - path: "bim_wb_tools/dimension.py"
      provides: "Core dimension classes and tools"
      min_lines: 200
    - path: "bim_wb_tools/annotation.py"
      provides: "Text and leader tools"
      min_lines: 150
    - path: "bim_wb_tools/dimension_styles.py"
      provides: "Dimension style management"
      min_lines: 100
    - path: "resources/icons/dimension_aligned.svg"
      provides: "Aligned dimension tool icon"
    - path: "resources/icons/dimension_horizontal.svg"
      provides: "Horizontal dimension tool icon"
    - path: "resources/icons/dimension_vertical.svg"
      provides: "Vertical dimension tool icon"
    - path: "resources/icons/dimension_radius.svg"
      provides: "Radius dimension tool icon"
    - path: "resources/icons/dimension_angle.svg"
      provides: "Angle dimension tool icon"
    - path: "resources/icons/text_label.svg"
      provides: "Text tool icon"
    - path: "resources/icons/leader_line.svg"
      provides: "Leader tool icon"
  key_links:
    - from: "bim_wb_tools/dimension.py"
      to: "bim_wb_core/workbench.py"
      via: "toolbar registration"
      pattern: "Workbench.*appendToolbar"
    - from: "bim_wb_tools/annotation.py"
      to: "bim_wb_core/workbench.py"
      via: "toolbar registration"
      pattern: "Workbench.*appendToolbar"
    - from: "dimension objects"
      to: "FreeCAD document objects"
      via: "FeaturePython"
      pattern: "App::FeaturePython"
---

<objective>
Implement dimension tools and annotation system for the BIM Workbench.

Purpose: Enable precise measurement and documentation of ceiling layouts with professional dimensioning tools including linear, angular, and radial dimensions plus text annotations.
Output: Complete dimensioning and annotation system with 7 tool types and configurable styles.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Source Requirements:**
@bim/BIM_Workbench.md - Section: "Dimension & Annotation Tools"

**Tool Types Required:**
- Aligned Dimension - General purpose between two points
- Horizontal Dimension - Force horizontal measurement
- Vertical Dimension - Force vertical measurement  
- Radius Dimension - For circles and arcs
- Angle Dimension - Three-point angle measurement
- Text Label - Free text annotations
- Leader Line - Arrow leader with text

**Dimension Styles:**
- Text height
- Arrow size
- Decimal precision
- Font family

**Behavior:**
- Click-based tool workflow (FreeCAD standard)
- Dimensions update when referenced geometry changes
- Parametric association with model elements
</context>

<tasks>

<task type="auto">
  <name>Create Core Dimension Classes</name>
  <files>bim_wb_tools/dimension.py, bim_wb_tools/__init__.py</files>
  <action>
Create bim_wb_tools/dimension.py with base dimension framework:

1. Define AlignedDimension class (FreeCAD FeaturePython):
   - Properties: StartPoint, EndPoint, TextPosition, Text, OverrideText
   - onChanged handler to update dimension line when points move
   - execute method to recalculate dimension geometry

2. Define HorizontalDimension class:
   - Inherit from AlignedDimension
   - Override to force horizontal text orientation
   - Calculate horizontal distance only

3. Define VerticalDimension class:
   - Inherit from AlignedDimension
   - Override to force vertical text orientation
   - Calculate vertical distance only

4. Implement dimension line geometry:
   - Create line from point A to point B
   - Add extension lines (witness lines) perpendicular to dimension line
   - Add dimension text at specified position
   - Draw arrows at both ends (triangles)

5. Add ViewProviderDimension for visual representation:
   - Coin3D scene graph for OpenGL rendering
   - Line color, text color, arrow style
   - Text always faces camera

Update bim_wb_tools/__init__.py to export dimension classes.
  </action>
  <verify>
python3 -c "from bim_wb_tools.dimension import AlignedDimension, HorizontalDimension, VerticalDimension; print('Dimension classes loaded')"
  </verify>
  <done>AlignedDimension, HorizontalDimension, VerticalDimension classes exist with FeaturePython integration and ViewProvider for 3D visualization</done>
</task>

<task type="auto">
  <name>Create Radius and Angle Dimension Classes</name>
  <files>bim_wb_tools/dimension.py</files>
  <action>
Extend bim_wb_tools/dimension.py with radial and angular dimensions:

1. Define RadiusDimension class:
   - Properties: Center, Radius, TextPosition, ReferenceObject
   - Support for circles and arcs
   - Draw radius line from center to edge point
   - Leader line to text position
   - Text format: "R{value}" with configurable precision
   - Arrow at outer end pointing toward center
   - Handle arc angles: calculate text position along bisector

2. Define AngleDimension class:
   - Properties: Vertex, StartPoint, EndPoint, TextPosition, Radius
   - Draw angle arc between start and end vectors
   - Calculate angle in degrees from three points
   - Draw extension lines from vertex
   - Text format: "{value}°" with degree symbol
   - Handle reflex angles (>180°) with optional interior/exterior toggle
   - Arc indicator showing angle sweep

3. Add dimension calculation utilities:
   - calculate_distance(p1, p2) -> float
   - calculate_angle(vertex, start, end) -> float (degrees)
   - format_dimension(value, precision, unit="mm") -> str
   - is_circle_or_arc(obj) -> bool helper

4. Update ViewProviderDimension to handle:
   - Radius dimension graphics (single arrow)
   - Angle dimension graphics (arc, no arrows on arc ends)

5. Add update_linked_geometry() method:
   - Subscribe to reference object position changes
   - Recalculate dimension when geometry moves
  </action>
  <verify>
python3 -c "from bim_wb_tools.dimension import RadiusDimension, AngleDimension; print('Radial and angular dimensions loaded')"
  </verify>
  <done>RadiusDimension and AngleDimension classes exist with proper FeaturePython integration, angle calculation, and arc rendering support</done>
</task>

<task type="auto">
  <name>Create Dimension Tool Commands</name>
  <files>bim_wb_tools/dimension.py, bim_wb_core/workbench.py</files>
  <action>
Create dimension tool commands following FreeCAD command pattern:

1. Define AlignedDimensionCommand class:
   - GetResources() -> dict with menu text, tooltip, icon
   - Activated() method with 3-click workflow:
     * Click 1: Select first point (snapped to geometry)
     * Click 2: Select second point
     * Click 3: Place dimension line position
   - isActive() check for valid document

2. Define HorizontalDimensionCommand:
   - Same 3-click workflow
   - Creates HorizontalDimension object
   - Text always horizontal regardless of line angle

3. Define VerticalDimensionCommand:
   - Same 3-click workflow
   - Creates VerticalDimension object
   - Text always vertical

4. Define RadiusDimensionCommand:
   - 2-click workflow:
     * Click 1: Select circle or arc edge
     * Click 2: Place text position
   - Validate selection is circular geometry
   - Extract center and radius from selected object

5. Define AngleDimensionCommand:
   - 4-click workflow:
     * Click 1: Select vertex (angle center)
     * Click 2: Select start point
     * Click 3: Select end point
     * Click 4: Place text position
   - Calculate angle from three points
   - Draw arc between start and end at specified radius

6. Register commands in workbench:
   - Add to bim_wb_core/workbench.py toolbar
   - Group under "Dimensions" dropdown
   - Add keyboard shortcuts (optional)

7. Add mouse cursor feedback:
   - Change cursor during point selection
   - Preview dimension line while placing
   - Snap indicators for geometry
  </action>
  <verify>
grep -q "AlignedDimensionCommand" bim_wb_tools/dimension.py && grep -q "RadiusDimensionCommand" bim_wb_tools/dimension.py && echo "Dimension commands defined"
  </verify>
  <done>All 5 dimension tool commands exist with proper click workflows, selection validation, and workbench registration</done>
</task>

<task type="auto">
  <name>Create Annotation Classes (Text and Leader)</name>
  <files>bim_wb_tools/annotation.py, bim_wb_tools/__init__.py</files>
  <action>
Create bim_wb_tools/annotation.py for text annotations:

1. Define TextLabel class (FeaturePython):
   - Properties: 
     * Position (Vector) - placement point
     * Text (String) - label content, support multiline with \\n
     * FontSize (Float) - text height in mm
     * Rotation (Float) - text rotation angle in degrees
     * FontName (String) - font family name
     * Color (Color) - RGB text color
     * Justification (Enumeration) - Left, Center, Right
   - execute() method: update text position and rotation
   - onChanged() handler for property updates

2. Define ViewProviderTextLabel:
   - Coin3D text node (SoText2 for screen-aligned or SoText3 for 3D)
   - Font specification
   - Color and material
   - Scale based on FontSize property
   - Rotation transformation

3. Define LeaderLine class:
   - Properties:
     * StartPoint (Vector) - text attachment
     * EndPoint (Vector) - arrow location
     * MidPoint (Vector) - optional elbow/kink point
     * ArrowSize (Float)
     * LineColor (Color)
     * Text (String) - optional leader text
   - Geometry: Two-segment polyline (start -> mid -> end)
   - Arrow: Triangle at end point pointing outward

4. Define ViewProviderLeaderLine:
   - Draw line segments (SoLineSet)
   - Draw arrow head (SoCone or custom triangle)
   - Support for elbow point visualization
   - Text label at start point

5. Implement text formatting:
   - Line wrapping for long text
   - Special characters handling
   - Text background/border option

6. Update bim_wb_tools/__init__.py to export annotation classes.
  </action>
  <verify>
python3 -c "from bim_wb_tools.annotation import TextLabel, LeaderLine; print('Annotation classes loaded')"
  </verify>
  <done>TextLabel and LeaderLine classes exist with FeaturePython integration, multiline support, and ViewProvider for 3D text and line rendering</done>
</task>

<task type="auto">
  <name>Create Text and Leader Tool Commands</name>
  <files>bim_wb_tools/annotation.py, bim_wb_core/workbench.py</files>
  <action>
Create annotation tool commands:

1. Define TextLabelCommand:
   - GetResources() with icon and tooltip
   - Activated() workflow:
     * Click: Select text insertion point
     * Dialog: Show text input dialog with:
       - Multiline text field
       - Font size spinner (default: 3.5mm)
       - Rotation angle input
       - Font family dropdown (system fonts)
       - Color picker
       - Justification options
     * Create TextLabel object on OK
   - isActive() check

2. Define LeaderLineCommand:
   - Activated() workflow:
     * Click 1: Select start point (text side)
     * Click 2: Select elbow/kink point (optional, can skip)
     * Click 3: Select end point (arrow location)
     * Dialog: Optional text input, arrow size, color
   - Preview leader line during placement
   - Allow Ctrl+Click to skip elbow point (direct line)

3. Define EditTextCommand:
   - Double-click or menu item to edit existing text
   - Show same dialog as create but populated
   - Update object properties on OK

4. Register in workbench:
   - Add TextLabelCommand and LeaderLineCommand to toolbar
   - Group under "Annotation" dropdown or separate toolbar
   - Add to menu: BIM → Annotation

5. Add context menu integration:
   - Right-click on text -> Edit Text
   - Right-click on leader -> Edit Leader
   - Delete option

6. Implement property editing:
   - Property panel integration for selected annotations
   - Real-time updates when properties change
  </action>
  <verify>
grep -q "TextLabelCommand" bim_wb_tools/annotation.py && grep -q "LeaderLineCommand" bim_wb_tools/annotation.py && echo "Annotation commands defined"
  </verify>
  <done>TextLabelCommand and LeaderLineCommand exist with dialog-based input, property editing, and workbench toolbar integration</done>
</task>

<task type="auto">
  <name>Create Dimension Styles System</name>
  <files>bim_wb_tools/dimension_styles.py</files>
  <action>
Create bim_wb_tools/dimension_styles.py for style management:

1. Define DimensionStyle class:
   - Properties:
     * Name (String) - style identifier
     * TextHeight (Float) - default 3.5mm
     * ArrowSize (Float) - default 2.5mm
     * DecimalPlaces (Integer) - default 0 for mm, 2 for inches
     * FontName (String) - default "Arial" or system default
     * TextColor (Color) - default black
     * LineColor (Color) - default black
     * ExtensionLineOffset (Float) - gap from object, default 1mm
     * ExtensionLineExtension (Float) - past dimension line, default 2mm
     * TextPosition (Enumeration) - Above, Centered, Outside
     * ArrowStyle (Enumeration) - Closed, Open, Dot, Architectural tick

2. Implement StyleManager singleton:
   - Load/save styles to JSON file in user config
   - Get style by name
   - Get default style
   - Add, update, delete styles
   - Duplicate existing style
   - List all available styles

3. Create default styles:
   - "Standard" - General purpose, medium size
   - "Small" - For detailed views, 2.5mm text
   - "Large" - For presentation drawings, 5mm text
   - "Architectural" - Tick marks instead of arrows

4. Integrate with dimension objects:
   - Add Style property to all dimension classes
   - Apply style settings in execute() method
   - Override individual properties when Style is "Custom"

5. Create StyleDialog for GUI editing:
   - Preview panel showing dimension with current settings
   - Form fields for all properties
   - Save/Cancel/Apply buttons
   - Import/Export style buttons

6. Add workbench preferences:
   - BIM → Preferences → Dimension Styles
   - Set default style for new dimensions
   - Global scale factor for all dimensions
  </action>
  <verify>
python3 -c "from bim_wb_tools.dimension_styles import DimensionStyle, StyleManager; print('Dimension styles loaded')"
  </verify>
  <done>DimensionStyle class and StyleManager exist with JSON persistence, 4 default styles, and dialog-based editing</done>
</task>

<task type="auto">
  <name>Implement Dimension Update and Linking System</name>
  <files>bim_wb_tools/dimension.py, bim_wb_tools/annotation.py</files>
  <action>
Implement parametric update system for dimensions:

1. Add reference tracking to dimension classes:
   - ReferenceObject property (Link to geometric object)
   - ReferenceSubelement (String - edge, vertex name)
   - Store initial relative positions

2. Implement onDocumentRestored():
   - Re-establish object links after file load
   - Validate references still exist
   - Handle broken references gracefully

3. Create update mechanism:
   - Subscribe to object change notifications
   - When referenced object moves, recalculate dimension:
     * Extract new vertex/edge positions
     * Update StartPoint, EndPoint, Center, etc.
     * Call execute() to regenerate geometry
   - Use FreeCAD's observer pattern for efficiency

4. Add dimension constraint modes:
   - "Free" - Dimension line position is fixed
   - "Aligned" - Dimension line follows points (maintains offset)
   - "Force Horizontal/Vertical" - Project points to axis

5. Handle edge cases:
   - Deleted referenced object -> show as "?" or red dimension
   - Degenerate cases (zero length, coincident points)
   - Very small or very large dimensions

6. Add annotation linking:
   - Text labels can attach to objects (follow if object moves)
   - Leader lines update if attached point moves
   - Optional: Leader auto-avoidance (don't cross other geometry)

7. Implement dimension grouping:
   - Baseline dimensions (share common start point)
   - Chain dimensions (end-to-end)
   - Ordinate dimensions (from common datum)
   - Support for these patterns in tool commands

8. Add update notification:
   - Status bar message when dimensions update
   - Visual indicator (color change) if dimension is "stale"
  </action>
  <verify>
grep -q "onDocumentRestored" bim_wb_tools/dimension.py && grep -q "ReferenceObject" bim_wb_tools/dimension.py && echo "Update system implemented"
  </verify>
  <done>Dimension and annotation objects track referenced geometry, update automatically when objects move, and handle broken references gracefully</done>
</task>

<task type="auto">
  <name>Create Tool Icons and Finalize Toolbar Integration</name>
  <files>
resources/icons/dimension_aligned.svg,
resources/icons/dimension_horizontal.svg,
resources/icons/dimension_vertical.svg,
resources/icons/dimension_radius.svg,
resources/icons/dimension_angle.svg,
resources/icons/text_label.svg,
resources/icons/leader_line.svg,
bim_wb_core/workbench.py
  </files>
  <action>
Create tool icons and complete toolbar setup:

1. Create SVG icons (48x48px, monochrome compatible):
   - dimension_aligned.svg: Two points with angled dimension line between them
   - dimension_horizontal.svg: Two points with horizontal dimension line
   - dimension_vertical.svg: Two points with vertical dimension line
   - dimension_radius.svg: Circle with radius arrow and R text
   - dimension_angle.svg: Two lines meeting at vertex with arc indicator
   - text_label.svg: "T" with bounding box or text cursor
   - leader_line.svg: Polyline with arrow at end
   - Use FreeCAD icon style: simple, clear, 2-3 colors max

2. Update bim_wb_core/workbench.py:
   - Import all dimension and annotation commands
   - Add toolbar group "Dimensions":
     ```python
     dimTools = [
         "BIM_AlignedDimension",
         "BIM_HorizontalDimension",
         "BIM_VerticalDimension",
         "BIM_RadiusDimension",
         "BIM_AngleDimension",
         "Separator",
         "BIM_TextLabel",
         "BIM_LeaderLine"
     ]
     self.appendToolbar("Dimensions", dimTools)
     ```
   - Add menu items under BIM → Annotation:
     - Dimension submenu with all 5 tools
     - Text Label
     - Leader Line
     - Separator
     - Dimension Styles...

3. Add command aliases (shortcuts):
   - DAL - Aligned Dimension
   - DHO - Horizontal Dimension
   - DVE - Vertical Dimension
   - DRA - Radius Dimension
   - DAN - Angle Dimension
   - MTEXT - Text Label
   - LEADER - Leader Line

4. Create quick access panel (optional):
   - Floating toolbar with commonly used tools
   - Remember last used dimension type

5. Test toolbar integration:
   - Icons display correctly
   - Tooltips show on hover
   - Commands activate properly
   - Separators between dimension and annotation groups

6. Add status bar help:
   - Show current step in multi-click operations
   - Display hints: "Select first point", "Select second point", etc.

7. Create keyboard shortcuts:
   - Ctrl+D - Quick dimension (uses last type)
   - Ctrl+T - Quick text
   - Esc - Cancel current operation
  </action>
  <verify>
ls resources/icons/dimension_*.svg resources/icons/text_label.svg resources/icons/leader_line.svg 2>/dev/null | wc -l | grep -q "7" && grep -q "BIM_AlignedDimension" bim_wb_core/workbench.py && echo "All icons and toolbar integration complete"
  </verify>
  <done>All 7 tool icons created in resources/icons/, commands registered in workbench toolbar with proper organization, menu items added, and keyboard shortcuts defined</done>
</task>

</tasks>

<verification>
**Overall Phase Checks:**

1. **Code Structure Verification:**
   - All dimension classes inherit from FeaturePython
   - ViewProvider classes use Coin3D properly
   - Commands follow FreeCAD command pattern

2. **Tool Availability:**
   - 5 dimension tools appear in toolbar
   - 2 annotation tools appear in toolbar
   - Style editor accessible from menu

3. **Functionality Testing:**
   - Aligned dimension creates between two clicked points
   - Horizontal/Vertical dimensions maintain orientation
   - Radius dimension works on circles and arcs
   - Angle dimension calculates correctly
   - Text labels display multiline text properly
   - Leader lines have arrows and text

4. **Update Behavior:**
   - Moving geometry updates associated dimensions
   - Deleting referenced object shows visual indicator
   - Document save/load preserves dimensions

5. **Style System:**
   - Default styles load on startup
   - Style changes apply to all dimensions using that style
   - Custom styles can be created and saved

6. **Integration:**
   - Tools work with selection system
   - Snap points work during dimension placement
   - Property panel shows dimension properties
</verification>

<success_criteria>
**Measurable Completion:**

1. **Tool Count:** 7 tools implemented (5 dimension + 2 annotation)
2. **Dimension Types:** Aligned, Horizontal, Vertical, Radius, Angle all functional
3. **Annotation Types:** Text labels and leader lines functional
4. **Style System:** 4+ styles defined, configurable via dialog
5. **Update System:** Dimensions update when geometry moves (parametric)
6. **Icons:** 7 SVG icons created and displaying
7. **Integration:** All tools in toolbar with proper organization
8. **Test Coverage:** Basic tests for each dimension type

**Functional Acceptance:**
- User can dimension a simple rectangle with all 4 sides
- User can add text labels and leader lines
- User can change dimension styles
- Moving the rectangle updates all dimensions
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-14-SUMMARY.md`

**Summary Structure:**
- Tools created: Aligned, Horizontal, Vertical, Radius, Angle, Text, Leader
- Files created: dimension.py, annotation.py, dimension_styles.py, 7 SVG icons
- Key features: Parametric updates, style system, multi-click workflow
- Integration: Toolbar, menu, keyboard shortcuts
- Dependencies: Uses selection system from Plan 08, snapping from Plan 09
</output>
