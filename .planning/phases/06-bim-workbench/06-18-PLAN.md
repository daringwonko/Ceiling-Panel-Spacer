---
phase: 06-bim-workbench
plan: 18
type: execute
wave: 5
depends_on: ["06-16", "06-17"]
files_modified: []
autonomous: true
must_haves:
  truths:
    - "Users can export 2D views to DXF format"
    - "Users can export 2D views to SVG format"
    - "Users can export 3D views to SVG with projection"
    - "Export dialog allows format selection and options"
    - "Batch export can export multiple sheets/views"
  artifacts:
    - path: "src/components/Export/ExportDialog.tsx"
      provides: "Export dialog UI with format selection"
      exports: ["ExportDialog"]
    - path: "src/utils/dxfExport.ts"
      provides: "DXF export functionality"
      exports: ["exportToDXF"]
    - path: "src/utils/svgExport.ts"
      provides: "SVG export functionality"
      exports: ["exportToSVG", "export3DToSVG"]
    - path: "src/utils/batchExport.ts"
      provides: "Batch export functionality"
      exports: ["batchExport"]
    - path: "src/services/exportApi.ts"
      provides: "Backend API integration for exports"
      exports: ["generateDXF", "generateBatchExport"]
  key_links:
    - from: "src/components/Export/ExportDialog.tsx"
      to: "src/utils/dxfExport.ts"
      via: "export function call"
      pattern: "exportToDXF"
    - from: "src/components/Export/ExportDialog.tsx"
      to: "src/utils/svgExport.ts"
      via: "export function call"
      pattern: "exportToSVG|export3DToSVG"
    - from: "src/utils/dxfExport.ts"
      to: "src/services/exportApi.ts"
      via: "API call"
      pattern: "generateDXF"
---

<objective>
Implement comprehensive DXF and SVG export functionality for 2D drawings and 3D views in the BIM Workbench.

Purpose: Enable users to export their ceiling designs and BIM models to industry-standard formats (DXF for CAD software, SVG for web/display) with flexible export options including batch processing.
Output: Complete export system with dialog UI, 2D/3D export utilities, and batch export capabilities.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# DXF Export
- DXF is AutoCAD's native format for CAD drawings
- Backend uses ezdxf library for DXF generation
- Need to map 2D objects to DXF entities (LINE, CIRCLE, ARC, LWPOLYLINE)
- Layer organization is critical for CAD workflow

# SVG Export
- SVG is vector format suitable for web and print
- 2D export: Direct conversion from canvas to SVG
- 3D export: Requires projection and hidden line handling
- Must include viewBox for proper scaling

# Export Requirements
- Support multiple formats: DXF, SVG, IFC
- Export scope options: all objects, selection only, current view
- Configurable scale settings
- Batch export for multiple sheets/sections
- Zip download for batch exports
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 2D Export Utilities (SVG and DXF)</name>
  <files>
    src/utils/svgExport.ts
    src/utils/dxfExport.ts
    src/services/exportApi.ts
  </files>
  <action>
Create export utilities for 2D drawings:

1. **SVG Export (src/utils/svgExport.ts)**:
   - Implement `exportToSVG(canvasObjects, options)` function
   - Convert canvas objects to SVG elements:
     - Lines → `<line>` elements
     - Circles → `<circle>` elements  
     - Arcs → `<path>` elements with arc commands
     - Polylines/rectangles → `<polygon>` or `<path>` elements
   - Maintain styling (stroke, fill, stroke-width)
   - Add proper viewBox based on canvas bounds
   - Include metadata header with project info
   - Return SVG string or Blob

2. **DXF Export (src/utils/dxfExport.ts)**:
   - Implement `exportToDXF(canvasObjects, options)` function
   - Call backend API (`/api/export/dxf`) with object data
   - Map objects to DXF entity types:
     - Lines → LINE entity
     - Circles → CIRCLE entity
     - Arcs → ARC entity
     - Polylines → LWPOLYLINE entity
   - Define layer mapping (e.g., "PANELS", "GAPS", "DIMENSIONS")
   - Handle response and return DXF blob for download

3. **API Service (src/services/exportApi.ts)**:
   - Create `generateDXF(objects, layers, scale)` API function
   - POST to `/api/export/dxf` with:
     - objects: Array of serialized 2D objects
     - layers: Layer configuration
     - scale: Export scale factor
   - Handle response and return Blob
   - Add error handling for generation failures

**Implementation Notes:**
- Use existing backend ezdxf integration
- Ensure coordinate system consistency (mm units)
- Support scale transformation
- Include proper error handling with user-friendly messages
  </action>
  <verify>
- Unit tests pass for SVG conversion functions
- Unit tests pass for DXF API integration
- Sample exports produce valid SVG/XML and DXF formats
- Styling is preserved in SVG output
  </verify>
  <done>
- src/utils/svgExport.ts exports `exportToSVG` function that generates valid SVG
- src/utils/dxfExport.ts exports `exportToDXF` function that calls backend API
- src/services/exportApi.ts provides `generateDXF` for backend communication
- All functions handle errors gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement 3D View Export and Export Dialog</name>
  <files>
    src/utils/svgExport.ts
    src/components/Export/ExportDialog.tsx
    src/components/Export/ExportDialog.css
  </files>
  <action>
Create 3D export functionality and export dialog UI:

1. **3D SVG Export (src/utils/svgExport.ts)**:
   - Add `export3DToSVG(sceneObjects, camera, options)` function
   - Implement projection from 3D to 2D:
     - Use camera matrix for perspective or orthographic projection
     - Project vertices to screen coordinates
   - Handle section cuts:
     - Clip geometry at section plane
     - Show cut lines with different styling
   - Hidden line handling (optional/future):
     - Basic: No hidden line removal (wireframe)
     - Advanced: Implement hidden line algorithm (if time permits)
   - Convert projected geometry to SVG elements
   - Include scale indicator and view metadata

2. **Export Dialog (src/components/Export/ExportDialog.tsx)**:
   - Create modal dialog component with:
     - **Format selection**: Radio buttons for DXF, SVG, IFC
     - **Export scope**: Options for "All Objects", "Current Selection", "Current View"
     - **Scale setting**: Input with common presets (1:1, 1:50, 1:100)
     - **Preview**: Thumbnail or description of what will be exported
     - **Filename**: Input with default based on project name
   - State management:
     - Track selected format, scope, scale
     - Validate inputs before export
   - Export action:
     - Call appropriate export utility based on format
     - Trigger file download with generated Blob
     - Show loading state during generation
     - Handle errors with user feedback
   - Include close/cancel functionality
   - Style with ExportDialog.css for professional appearance

**Implementation Notes:**
- Dialog should be reusable and accessible
- Use React hooks for state management
- Support keyboard shortcuts (Enter to export, Escape to close)
- Follow existing UI component patterns from project
  </action>
  <verify>
- Export dialog renders correctly with all options
- Format selection changes available options appropriately
- 3D export generates SVG with projected geometry
- Export button triggers correct export function
- File download starts with proper filename and extension
  </verify>
  <done>
- `export3DToSVG` function projects 3D scene to SVG successfully
- ExportDialog component provides format selection, scope options, and scale input
- Dialog integrates with export utilities and triggers downloads
- UI is styled and user-friendly
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Batch Export Functionality</name>
  <files>
    src/utils/batchExport.ts
    src/services/exportApi.ts
    src/components/Export/BatchExportProgress.tsx
  </files>
  <action>
Create batch export system for multiple sheets and views:

1. **Batch Export Utility (src/utils/batchExport.ts)**:
   - Implement `batchExport(items, format, options)` function
   - Support export items:
     - All sheets (2D drawing sheets)
     - All sections (cut views)
     - All 3D views
     - Custom selection of views
   - For each item:
     - Generate export data (SVG or DXF)
     - Collect into array of export results
   - Create ZIP archive containing all exports:
     - Use JSZip library for client-side ZIP creation
     - Organize files in folders by type (Sheets/, Sections/, Views3D/)
     - Name files descriptively: "{ProjectName}_{SheetName}.{ext}"
   - Return ZIP blob for download
   - Track progress (number of items processed)

2. **API Service Extension (src/services/exportApi.ts)**:
   - Add `generateBatchExport(items, format)` API function
   - POST to `/api/export/batch` for server-side batch processing
   - Request body includes:
     - items: Array of item IDs/types to export
     - format: Export format (DXF, SVG)
     - options: Scale, layers, etc.
   - Handle response:
     - Streaming response for large batches
     - Or polling for completion
   - Return ZIP blob or download URL

3. **Batch Progress UI (src/components/Export/BatchExportProgress.tsx)**:
   - Create progress indicator component
   - Show:
     - Current item being processed
     - Progress bar (X of Y items)
     - Estimated time remaining
     - Cancel button
   - Handle completion:
     - Auto-trigger download
     - Show success message with summary
   - Handle errors:
     - Show which items failed
     - Option to retry failed items
   - Style to match ExportDialog

**Implementation Notes:**
- Batch export can be client-side (browser) or server-side
- For many items, prefer server-side to avoid browser memory issues
- Provide cancellation capability
- Include clear progress feedback
  </action>
  <verify>
- Batch export processes multiple items correctly
- ZIP file contains all exported files in organized structure
- Progress indicator updates during processing
- Download triggers automatically on completion
- Cancel button stops processing gracefully
  </verify>
  <done>
- `batchExport` function generates ZIP with all requested exports
- BatchExportProgress component shows processing status
- API service supports server-side batch generation
- Batch export works for sheets, sections, and 3D views
  </done>
</task>

</tasks>

<verification>
**Overall Plan Verification:**

1. **Export Formats:**
   - [ ] 2D SVG export produces valid SVG files
   - [ ] 2D DXF export produces valid DXF files (openable in AutoCAD)
   - [ ] 3D SVG export produces projected views

2. **Export Dialog:**
   - [ ] Dialog opens from menu/toolbar
   - [ ] Format selection works (DXF, SVG, IFC)
   - [ ] Scope selection works (all, selection, current view)
   - [ ] Scale setting applies to export
   - [ ] Export triggers file download

3. **Batch Export:**
   - [ ] Can select multiple sheets for export
   - [ ] Can select multiple sections for export
   - [ ] ZIP file downloads with all exports
   - [ ] Progress shown during processing

4. **Integration:**
   - [ ] Export functions integrate with existing canvas/3D viewer
   - [ ] Backend API accepts export requests
   - [ ] Error handling provides user feedback
</verification>

<success_criteria>
**Measurable Completion:**

1. **Functionality:**
   - Users can export 2D canvas to SVG with `exportToSVG()` function
   - Users can export 2D canvas to DXF with `exportToDXF()` function
   - Users can export 3D view to SVG with `export3DToSVG()` function
   - Export dialog provides format, scope, and scale selection
   - Batch export can export and ZIP multiple sheets/views

2. **File Artifacts:**
   - `src/utils/svgExport.ts` - SVG export utilities
   - `src/utils/dxfExport.ts` - DXF export utilities
   - `src/utils/batchExport.ts` - Batch export functionality
   - `src/services/exportApi.ts` - Backend API integration
   - `src/components/Export/ExportDialog.tsx` - Export dialog UI
   - `src/components/Export/BatchExportProgress.tsx` - Progress indicator

3. **Quality:**
   - Exported SVG files render correctly in browsers and editors
   - Exported DXF files open in AutoCAD without errors
   - 3D projections are geometrically correct
   - Batch exports complete without memory issues
   - All exports include proper metadata
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-18-SUMMARY.md` with:
- Files created/modified
- Export functions API
- Integration notes for 3D viewer and canvas
- Examples of exported file formats
</output>
