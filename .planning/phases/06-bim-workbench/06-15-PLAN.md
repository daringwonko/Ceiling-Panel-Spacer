---
phase: 06-bim-workbench
plan: 15
type: execute
wave: 4
depends_on: [06-09, 06-14]
files_modified: [
  "src/bim/section_plane.py",
  "src/bim/tools/section_plane_tool.py",
  "src/bim/section_clipper.py",
  "src/bim/ui/section_manager.py",
  "src/bim/ui/section_panel.py",
  "src/bim/types.py"
]
autonomous: true

must_haves:
  truths:
    - "User can create section planes with visual representation"
    - "Section planes clip 3D view to show cut geometry"
    - "Multiple named sections can be created (plan and elevation)"
    - "Sections can be managed (list, activate, edit, delete)"
    - "Cut surfaces show hatching patterns"
  artifacts:
    - path: "src/bim/section_plane.py"
      provides: "SectionPlane class with position, normal, size, and visual representation"
      exports: ["SectionPlane", "SectionType"]
    - path: "src/bim/tools/section_plane_tool.py"
      provides: "Interactive section plane creation tool"
      exports: ["SectionPlaneTool"]
    - path: "src/bim/section_clipper.py"
      provides: "3D geometry clipping and cut surface generation"
      exports: ["SectionClipper", "cut_geometry"]
    - path: "src/bim/ui/section_manager.py"
      provides: "Section management UI and controls"
      exports: ["SectionManager"]
    - path: "src/bim/ui/section_panel.py"
      provides: "Section list panel with activate/edit/delete"
      exports: ["SectionPanel"]
  key_links:
    - from: "src/bim/section_plane.py"
      to: "src/bim/section_clipper.py"
      via: "clipping operations"
      pattern: "clipper.apply_section"
    - from: "src/bim/tools/section_plane_tool.py"
      to: "src/bim/section_plane.py"
      via: "creates SectionPlane instances"
      pattern: "SectionPlane(position=..., normal=...)"
    - from: "src/bim/ui/section_panel.py"
      to: "src/bim/ui/section_manager.py"
      via: "list and control sections"
      pattern: "manager.list_sections()", "manager.activate_section()"
---

<objective>
Implement section planes for cutting through the 3D model to generate 2D views.

Purpose: Enable architects and contractors to generate accurate cross-sections and elevations from the 3D ceiling model for construction documentation and visualization.

Output: Complete section plane system with creation tools, clipping capability, and management interface for generating 2D cuts from 3D geometry.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/home/tomas/Ceiling Panel Spacer/BIM_Workbench.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Core SectionPlane Object and Visual Representation</name>
  <files>src/bim/types.py, src/bim/section_plane.py</files>
  <action>
    Define the SectionPlane dataclass and visual representation:
    
    1. In src/bim/types.py, add SectionType enum:
       - PLAN (horizontal cut, looking down)
       - ELEVATION (vertical cut, looking at wall)
       - SECTION (custom angled cut)
    
    2. Create src/bim/section_plane.py with SectionPlane class:
       - Properties: id, name, type (SectionType), position (Vector3), 
         normal (Vector3), width, height, is_active
       - Methods:
         * get_plane_equation() -> returns plane as (normal, d)
         * get_bounds() -> returns rectangle corners in 3D
         * get_view_direction() -> returns arrow direction
         * flip_direction() -> reverses normal
       
    3. Add visual representation generation:
       - Rectangle mesh for section plane boundary
       - Hatching pattern material (diagonal lines)
       - Direction arrows at corners
       - Bounding box when selected
       
    4. Support serialization:
       - to_dict() for saving
       - from_dict() for loading
       - unique ID generation
       
    5. Validation:
       - Normal must be normalized
       - Width/height must be positive
       - Name must be unique
  </action>
  <verify>SectionPlane class can be instantiated with all properties; visual representation renders in test scene</verify>
  <done>SectionPlane dataclass exists with all properties; visual mesh generation produces rectangle with hatching and arrows</done>
</task>

<task type="auto">
  <name>Task 2: Implement Section Clipping System</name>
  <files>src/bim/section_clipper.py</files>
  <action>
    Create clipping system for cutting 3D geometry at section planes:
    
    1. Create src/bim/section_clipper.py with SectionClipper class:
       - Store reference to active section plane
       - Maintain original geometry cache for restoration
       
    2. Implement clip_geometry(geometry, plane) -> clipped_geometry:
       - Use CSG (Constructive Solid Geometry) intersection
       - Or use stencil buffer for visual clipping
       - Keep geometry on positive side of plane normal
       
    3. Generate cut surfaces:
       - Detect intersection between geometry and plane
       - Create face cap at cut location
       - Apply hatching material to cut surfaces
       - Generate 2D polygon from intersection
       
    4. Handle multiple object types:
       - Mesh geometries
       - Parametric ceiling panels
       - Structural elements
       - Annotations (hide if behind plane)
       
    5. Performance optimization:
       - Only clip visible objects
       - Cache clipped geometry
       - Update on section plane change
       - Batch clipping operations
       
    6. Clipping controls:
       - activate(plane) - start clipping
       - deactivate() - restore original view
       - is_active() - check state
       - toggle() - switch on/off
  </action>
  <verify>Clipping renders only geometry on positive side of plane; cut surfaces display hatching</verify>
  <done>SectionClipper can clip scene geometry and generate capped cut surfaces with hatching</done>
</task>

<task type="auto">
  <name>Task 3: Create Section Plane Tool and Management UI</name>
  <files>src/bim/tools/section_plane_tool.py, src/bim/ui/section_manager.py, src/bim/ui/section_panel.py</files>
  <action>
    Implement interactive tool and management interface:
    
    1. Create src/bim/tools/section_plane_tool.py:
       - SectionPlaneTool class inheriting from BaseTool
       - on_mouse_down: click to set center position
       - on_drag: rotate to set orientation (show preview)
       - on_mouse_up: confirm placement
       - Properties panel for:
         * Name (auto-generated: "Section A", "Section B"...)
         * Type (Plan/Elevation/Section)
         * Width/Height (default 2000mm)
         * Direction flip button
       - Visual feedback during creation:
         * Semi-transparent plane preview
         * Rotation indicator
         * Dimension labels
       
    2. Create src/bim/ui/section_manager.py:
       - SectionManager class (singleton)
       - Maintain list of all sections
       - Methods:
         * create_section(name, type, position, normal) -> SectionPlane
         * delete_section(section_id)
         * activate_section(section_id) - enables clipping
         * deactivate_all() - disable all clipping
         * get_active_section() -> SectionPlane | None
         * list_sections() -> list[SectionPlane]
         * rename_section(id, new_name)
         * update_section(id, **properties)
       - Signal on_section_changed, on_section_activated
       
    3. Create src/bim/ui/section_panel.py:
       - SectionPanel widget for dockable panel
       - List view of all sections with:
         * Checkbox for active/inactive
         * Name (editable inline)
         * Type icon (plan/elevation icon)
         * View direction indicator
       - Buttons:
         * "Create" - activates section tool
         * "Delete" - removes selected
         * "Flip" - reverses direction
         * "Edit" - opens property dialog
       - Double-click to activate section
       - Context menu with all actions
       
    4. Integration:
       - Tool registered in workbench toolbar
       - Panel docked in UI (right side)
       - Keyboard shortcut (S for section tool)
       - Menu items: BIM -> Section -> Create/Manage
  </action>
  <verify>Tool creates sections interactively; Panel lists and manages sections; Activation clips view</verify>
  <done>Complete workflow: create section -> appears in panel -> activate -> view clips to section</done>
</task>

</tasks>

<verification>
1. Section Creation:
   - Use SectionPlaneTool to click and drag to create section
   - Verify section appears with correct position, orientation, and size
   - Check visual elements: rectangle, hatching, direction arrows
   
2. Clipping Functionality:
   - Create section through ceiling model
   - Activate section - verify 3D view clips
   - Check cut surfaces show hatching pattern
   - Deactivate - verify full model visible again
   
3. Multiple Sections:
   - Create plan section (horizontal)
   - Create elevation section (vertical)
   - Create custom angled section
   - Verify all appear in section panel
   
4. Section Management:
   - List shows all sections with correct info
   - Activate/deactivate via checkbox
   - Rename section
   - Delete section (removes from list and scene)
   - Edit properties (position, size, direction)
   
5. Types:
   - PLAN type: normal points down (0, -1, 0)
   - ELEVATION type: normal points horizontally
   - SECTION type: custom normal
   
6. Edge Cases:
   - Section outside model bounds
   - Multiple overlapping sections
   - Section parallel to face
</verification>

<success_criteria>
- SectionPlane class fully implemented with position, normal, size properties
- Visual representation renders rectangle with hatching and direction arrows
- SectionPlaneTool allows interactive creation (click center, drag for orientation)
- SectionClipper clips 3D geometry to show only positive side of plane
- Cut surfaces display hatching pattern
- SectionManager maintains list of all sections with unique names
- SectionPanel UI displays sections with activate/edit/delete controls
- Can create plan, elevation, and custom section types
- Multiple sections can exist; only one active at a time
- Section configuration persists and can be modified
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-15-SUMMARY.md`
</output>
