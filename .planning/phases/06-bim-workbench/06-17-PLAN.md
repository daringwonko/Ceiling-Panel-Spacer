---
phase: 06-bim-workbench
plan: 17
type: execute
wave: 5
depends_on: ["06-13"]
files_modified:
  - src/bim/ifc/ifcManager.ts
  - src/bim/ifc/ifcImporter.ts
  - src/bim/ifc/ifcExporter.ts
  - src/bim/ifc/ifcTypeMapper.ts
  - src/bim/ifc/ifcSpatialStructure.ts
  - src/bim/ifc/ifcPropertyExtractor.ts
  - src/components/BIM/IFC/IFCImportDialog.tsx
  - src/components/BIM/IFC/IFCExportDialog.tsx
  - src/components/BIM/IFC/IFCProgressIndicator.tsx
  - src/hooks/useIFC.ts
  - src/types/ifc.d.ts
  - package.json
autonomous: true
must_haves:
  truths:
    - "User can import IFC files and see 3D geometry"
    - "Imported BIM objects have correct types (Wall, Beam, etc.)"
    - "User can export current model to IFC format"
    - "IFC files maintain proper spatial structure (Site → Building → Storey)"
    - "Import/export shows progress and handles errors gracefully"
  artifacts:
    - path: "src/bim/ifc/ifcManager.ts"
      provides: "web-ifc-three initialization and WASM loading"
      exports: ["IFCManager", "initializeIFC"]
    - path: "src/bim/ifc/ifcImporter.ts"
      provides: "IFC file parsing and object creation"
      exports: ["importIFC", "parseIFCFile"]
    - path: "src/bim/ifc/ifcExporter.ts"
      provides: "BIM to IFC conversion and file generation"
      exports: ["exportIFC", "generateIFCFile"]
    - path: "src/bim/ifc/ifcTypeMapper.ts"
      provides: "IFC type to BIM object mapping"
      exports: ["mapIFCTypeToBIM", "IFC_TYPE_MAP"]
    - path: "src/components/BIM/IFC/IFCImportDialog.tsx"
      provides: "File picker UI for IFC import"
      exports: ["IFCImportDialog"]
    - path: "src/components/BIM/IFC/IFCExportDialog.tsx"
      provides: "Export UI with options"
      exports: ["IFCExportDialog"]
  key_links:
    - from: "src/bim/ifc/ifcManager.ts"
      to: "web-ifc-three"
      via: "npm dependency"
      pattern: "import.*web-ifc-three"
    - from: "src/bim/ifc/ifcImporter.ts"
      to: "src/bim/ifc/ifcTypeMapper.ts"
      via: "type mapping during import"
      pattern: "mapIFCTypeToBIM"
    - from: "src/bim/ifc/ifcExporter.ts"
      to: "src/bim/ifc/ifcSpatialStructure.ts"
      via: "spatial hierarchy generation"
      pattern: "buildSpatialStructure"
    - from: "src/components/BIM/IFC/IFCImportDialog.tsx"
      to: "src/bim/ifc/ifcImporter.ts"
      via: "import trigger"
      pattern: "importIFC"
    - from: "src/components/BIM/IFC/IFCExportDialog.tsx"
      to: "src/bim/ifc/ifcExporter.ts"
      via: "export trigger"
      pattern: "exportIFC"
user_setup: []
---

<objective>
Implement IFC (Industry Foundation Classes) file import and export capability for the BIM Workbench using web-ifc-three library. Enable seamless interoperability with industry-standard BIM software by supporting full IFC file parsing, geometry extraction, property mapping, and proper spatial structure maintenance.

Purpose: IFC is the universal standard for BIM data exchange. This capability allows users to import existing building models from tools like Revit, ArchiCAD, or FreeCAD, and export their work for collaboration with other professionals.

Output: Complete IFC import/export system with UI components, type mapping, spatial structure handling, and progress feedback.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

IFC (Industry Foundation Classes) is the ISO 16739 standard for BIM data exchange. web-ifc-three is a WebAssembly-based IFC parser that enables client-side IFC processing without server dependencies.

Key IFC entity types to support:
- IfcSite - Project site context
- IfcBuilding - Building container
- IfcBuildingStorey - Floor/level
- IfcWall - Wall elements
- IfcBeam - Horizontal structural members
- IfcColumn - Vertical structural members
- IfcSlab - Floor/ceiling plates
- IfcDoor - Door openings
- IfcWindow - Window openings

Spatial structure hierarchy: IfcProject → IfcSite → IfcBuilding → IfcBuildingStorey → Elements
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up web-ifc-three library</name>
  <files>package.json, src/bim/ifc/ifcManager.ts, src/types/ifc.d.ts</files>
  <action>
Install web-ifc-three and its peer dependencies:
```bash
npm install web-ifc-three three
npm install --save-dev @types/three
```

Create src/bim/ifc/ifcManager.ts with IFC initialization:
- Import IFCLoader from web-ifc-three
- Create IFCManager class to handle WASM loading
- Configure WASM path (copy from node_modules/web-ifc to public/)
- Implement initializeIFC() async function
- Add error handling for WASM loading failures
- Create singleton instance for reuse across app

Create src/types/ifc.d.ts for TypeScript definitions:
- Extend Three.js types for IFC objects
- Define IFC property structures
- Add custom type guards for BIM object creation

WASM setup:
- Copy web-ifc.wasm to public/ directory
- Configure loader to use local WASM file
- Handle loading states and errors
  </action>
  <verify>
- Check package.json shows web-ifc-three installed
- Verify WASM file exists in public/ directory
- Run TypeScript check: `npm run type-check` passes
- Test initialization in browser console
  </verify>
  <done>
web-ifc-three installed, WASM file available, IFCLoader initializes without errors, TypeScript types defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement IFC type mapper</name>
  <files>src/bim/ifc/ifcTypeMapper.ts, src/bim/ifc/ifcPropertyExtractor.ts</files>
  <action>
Create src/bim/ifc/ifcTypeMapper.ts with IFC to BIM mapping:
- Define IFC_TYPE_MAP constant mapping IfcWall → 'Wall', etc.
- Implement mapIFCTypeToBIM(ifcType: string): BIMObjectType function
- Handle unknown types with fallback to generic 'Element'
- Support all core IFC types:
  - IfcWall, IfcWallStandardCase → Wall
  - IfcBeam → Beam
  - IfcColumn → Column
  - IfcSlab → Slab
  - IfcDoor → Door
  - IfcWindow → Window
  - IfcSite → Site
  - IfcBuilding → Building
  - IfcBuildingStorey → Level
  - IfcRoof, IfcCovering → Roof
  - IfcStair, IfcStairFlight → Stair
  - IfcRamp, IfcRampFlight → Ramp
  - IfcFurnishingElement → Furniture

Create src/bim/ifc/ifcPropertyExtractor.ts:
- Implement extractProperties(mesh: IFCMesh): BIMProperties
- Parse IFC property sets (Psets)
- Extract common properties: Name, Description, ObjectType
- Extract dimensions from geometry bounds
- Handle quantity sets (Qto_WallBaseQuantities, etc.)
- Convert IFC units to application units
  </action>
  <verify>
- Unit tests pass: `npm test -- ifcTypeMapper`
- All 12+ IFC types map correctly
- Property extraction returns valid BIMProperties
- Unknown types fallback gracefully
  </verify>
  <done>
Type mapper handles all major IFC types, property extractor parses Psets and quantities, unit conversion working
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement IFC importer</name>
  <files>src/bim/ifc/ifcImporter.ts, src/bim/ifc/ifcSpatialStructure.ts</files>
  <action>
Create src/bim/ifc/ifcImporter.ts:
- Implement importIFC(file: File): Promise<IFCImportResult> function
- Use IFCLoader to parse file asynchronously
- Show progress callbacks (0-100%)
- Extract all meshes from IFC model
- Convert Three.js meshes to BIM objects
- Preserve original IFC IDs for reference
- Handle import errors with descriptive messages

Create src/bim/ifc/ifcSpatialStructure.ts:
- Build spatial hierarchy from IFC structure
- Parse IfcProject, IfcSite, IfcBuilding, IfcBuildingStorey
- Create corresponding Level and Building objects
- Associate elements with their parent storey
- Maintain relationships for re-export
- Implement getSpatialStructure(): SpatialTree

Key import steps:
1. Load IFC file with IFCLoader
2. Get spatial structure (site, building, storeys)
3. Iterate through all IFC products
4. Filter supported types (walls, beams, columns, etc.)
5. Extract geometry for each element
6. Extract properties and quantities
7. Create BIMObject with correct type
8. Add to appropriate level
9. Return import result with statistics
  </action>
  <verify>
- Import test IFC file: `npm run test:ifc:import`
- Verify geometry loads correctly
- Check spatial structure matches IFC hierarchy
- Test error handling with malformed files
  </verify>
  <done>
IFC files import successfully, geometry visible, spatial structure preserved, properties extracted
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement IFC exporter</name>
  <files>src/bim/ifc/ifcExporter.ts, src/bim/ifc/ifcSpatialStructure.ts</files>
  <action>
Extend src/bim/ifc/ifcExporter.ts:
- Implement exportIFC(model: BIMModel): Promise<Blob> function
- Create IFC writer using web-ifc-three API
- Generate proper IFC header with:
  - FILE_DESCRIPTION
  - FILE_NAME (timestamp, author, application)
  - FILE_SCHEMA (IFC4 or IFC2X3)
- Build spatial structure:
  - Create IfcProject
  - Create IfcSite with placement
  - Create IfcBuilding
  - Create IfcBuildingStorey for each level
  - Set up aggregation relationships

Convert BIM objects to IFC entities:
- Map BIM type back to IFC type
- Create geometry representations
- Convert to IFC geometry types (IfcExtrudedAreaSolid for walls)
- Add property sets with BIM object properties
- Include quantities (length, area, volume where applicable)
- Write placement coordinates
- Set object names and descriptions

Export process:
1. Initialize IFC model
2. Create spatial hierarchy
3. Iterate through all BIM objects
4. Generate IFC geometry for each
5. Add properties and relationships
6. Serialize to IFC string
7. Create downloadable blob

Support export options:
- IFC version selection (IFC4, IFC2X3_TC1)
- Include/exclude geometry
- Include/exclude properties
  </action>
  <verify>
- Export current model: `npm run test:ifc:export`
- Open exported IFC in FreeCAD or BIM viewer
- Verify geometry matches original
- Check properties are preserved
- Test round-trip (import → export → import)
  </verify>
  <done>
IFC export generates valid files, geometry and properties preserved, spatial hierarchy correct, files open in other BIM tools
  </done>
</task>

<task type="auto">
  <name>Task 5: Create IFC UI components</name>
  <files>src/components/BIM/IFC/IFCImportDialog.tsx, src/components/BIM/IFC/IFCExportDialog.tsx, src/components/BIM/IFC/IFCProgressIndicator.tsx, src/hooks/useIFC.ts</files>
  <action>
Create src/components/BIM/IFC/IFCImportDialog.tsx:
- Modal dialog with file picker
- Drag-and-drop file support
- Accept .ifc files only
- Show file size and name
- Progress bar during import
- Display import statistics (objects found, types imported)
- Error display with retry option
- Success confirmation with option to view imported model

Create src/components/BIM/IFC/IFCExportDialog.tsx:
- Modal dialog with export options
- IFC version selector (IFC4, IFC2X3)
- Checkbox: Include geometry
- Checkbox: Include properties
- Checkbox: Include quantities
- Export progress indicator
- Download button on completion
- Warning for large models

Create src/components/BIM/IFC/IFCProgressIndicator.tsx:
- Reusable progress component
- Shows percentage and status message
- Spinner for indeterminate states
- Error state styling
- Success state with checkmark

Create src/hooks/useIFC.ts:
- React hook for IFC operations
- useIFCImporter() with state management
- useIFCExporter() with options
- Progress tracking
- Error handling
- Integration with BIM store

Add to BIM Workbench toolbar:
- Import IFC button with file icon
- Export IFC button with download icon
- Disable when no model loaded
  </action>
  <verify>
- UI renders without errors: `npm run storybook`
- Import dialog opens file picker
- Export dialog shows options
- Progress indicator displays correctly
- E2E test: `npm run test:e2e:ifc`
  </verify>
  <done>
Import and export dialogs functional, progress indicators working, integrated into BIM Workbench toolbar, user can import/export IFC files
  </done>
</task>

</tasks>

<verification>
1. IFC Import Verification:
   - Import sample IFC file from test fixtures
   - Verify all geometry appears in 3D view
   - Check object types match expected (walls as walls, etc.)
   - Confirm spatial structure (levels, building) created
   - Test with multiple IFC versions (IFC2X3, IFC4)

2. IFC Export Verification:
   - Create simple model with walls and slabs
   - Export to IFC
   - Open in FreeCAD BIM Workbench
   - Verify geometry matches
   - Check properties are present
   - Confirm spatial hierarchy

3. Round-trip Test:
   - Import IFC file
   - Export same model
   - Re-import exported file
   - Compare object counts and types

4. UI Verification:
   - Import button triggers file picker
   - Progress shown during import
   - Export button generates downloadable file
   - Error messages displayed for invalid files
</verification>

<success_criteria>
- User can import .ifc files via file picker dialog
- Imported geometry displays correctly in 3D view
- BIM objects have correct types (Wall, Beam, Column, etc.)
- Spatial structure preserved (Site → Building → Levels → Elements)
- Properties extracted and available on objects
- User can export current model to .ifc format
- Exported IFC files open correctly in FreeCAD/Revit
- Export includes geometry, properties, and spatial hierarchy
- Import/export shows progress feedback
- Error handling for invalid or corrupted files
- WASM loads correctly and IFC parsing works client-side
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-17-SUMMARY.md` with:
- Summary of IFC capabilities implemented
- List of supported IFC entity types
- Sample import/export workflow
- Any limitations or known issues
- Performance notes for large files
</output>
