---
phase: 06-bim-workbench
plan: 12
type: execute
wave: 3
depends_on: ["06-11"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - User can create and manage Site objects with geographic location
    - User can create and manage Building objects within sites
    - User can create and manage Level objects within buildings
    - User can view and navigate the project hierarchy in a tree view
    - Objects can be organized within the hierarchy via drag-drop
  artifacts:
    - path: "bim/hierarchy/site.py"
      provides: "Site object with geographic location and container for buildings"
      exports: ["Site", "SiteProperties"]
    - path: "bim/hierarchy/building.py"
      provides: "Building object with properties and container for levels"
      exports: ["Building", "BuildingProperties"]
    - path: "bim/hierarchy/level.py"
      provides: "Level object with elevation and container for objects"
      exports: ["Level", "LevelProperties"]
    - path: "bim/hierarchy/manager.py"
      provides: "Hierarchy management and relationships"
      exports: ["HierarchyManager"]
    - path: "bim/ui/hierarchy_tree.py"
      provides: "Tree view UI for project hierarchy"
      exports: ["HierarchyTreeView"]
    - path: "bim/ui/level_panel.py"
      provides: "Level management UI panel"
      exports: ["LevelPanel"]
  key_links:
    - from: "HierarchyTreeView"
      to: "HierarchyManager"
      via: "tree updates and drag-drop operations"
    - from: "Level"
      to: "BIMObject"
      via: "level assignment during object creation"
    - from: "Building"
      to: "Level"
      via: "building contains levels relationship"
    - from: "Site"
      to: "Building"
      via: "site contains buildings relationship"
---

<objective>
Implement a complete project hierarchy system for the BIM Workbench enabling users to organize their work using a Site → Building → Level → Objects structure. This provides the foundational organization system that makes BIM projects manageable and mirrors real-world construction project structures.

Purpose: Hierarchical organization is essential for realistic BIM workflows where users need to manage complex projects with multiple buildings and levels. Without this system, all objects exist in a flat space, making navigation and management impractical for real projects.

Output: Fully functional hierarchy system with Site, Building, and Level objects; tree view UI for navigation; drag-drop reorganization; and level-based object filtering/assignment.
</objective>

<execution_context>
@/home/tomas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/tomas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-bim-workbench/BIM_Workbench.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Site Object with Geographic Properties</name>
  <files>
    bim/hierarchy/__init__.py
    bim/hierarchy/site.py
  </files>
  <action>
    Create the Site object as the top-level container in the project hierarchy.

    In bim/hierarchy/site.py:
    - Create Site class with unique ID, name, and description
    - Add SiteProperties dataclass containing:
      - elevation: float (site elevation in meters)
      - address: str (physical address)
      - latitude: float (geographic coordinate)
      - longitude: float (geographic coordinate)
      - terrain_data: Optional[TerrainMesh] (optional terrain representation)
    - Implement buildings list to store Building references
    - Add methods:
      - add_building(building): Add building to site
      - remove_building(building_id): Remove building by ID
      - get_building(building_id): Get building by ID
      - get_all_buildings(): Return list of all buildings
      - get_bounding_box(): Calculate combined bounds of all buildings
    - Implement __repr__ for debugging
    - Add validation for coordinate ranges (lat: -90 to 90, lon: -180 to 180)

    In bim/hierarchy/__init__.py:
    - Export Site and SiteProperties
    - Document module purpose
  </action>
  <verify>
    - Import test: from bim.hierarchy import Site, SiteProperties succeeds
    - Unit test: Create Site("Main Site", lat=40.7128, lon=-74.0060, elevation=10.0)
    - Verify building container operations work (add/remove/get)
  </verify>
  <done>
    Site object exists with geographic properties, can contain buildings, and validates coordinate ranges. All methods functional.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Building Object with Auto-Calculated Bounding Box</name>
  <files>
    bim/hierarchy/building.py
    bim/hierarchy/__init__.py
  </files>
  <action>
    Create the Building object as a container for levels with automatic bounding box calculation.

    In bim/hierarchy/building.py:
    - Create Building class with unique ID, name
    - Add BuildingProperties dataclass containing:
      - building_type: str (residential, commercial, industrial, etc.)
      - total_height: float (calculated from levels)
      - footprint_area: float (m², calculated from levels)
      - construction_year: Optional[int]
      - address: Optional[str] (if different from site)
    - Implement levels list to store Level references
    - Add site_id reference to parent site
    - Add methods:
      - add_level(level): Add level to building
      - remove_level(level_id): Remove level by ID
      - get_level(level_id): Get level by ID
      - get_levels(): Return list of all levels
      - get_level_at_elevation(elevation): Find level at specific elevation
      - calculate_bounding_box(): Auto-calculate from contained levels and objects
      - update_total_height(): Recalculate from level elevations and heights
    - Implement sorted level access (by elevation)
    - Add validation: level elevations must not overlap

    In bim/hierarchy/__init__.py:
    - Export Building and BuildingProperties
  </action>
  <verify>
    - Import test: from bim.hierarchy import Building, BuildingProperties succeeds
    - Unit test: Create Building with levels, verify bounding box calculation
    - Verify level sorting by elevation works correctly
    - Test validation catches overlapping level elevations
  </verify>
  <done>
    Building object exists with properties, can contain levels, auto-calculates bounding box and total height. Level elevation validation works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Level Object with 2D Plan View</name>
  <files>
    bim/hierarchy/level.py
    bim/hierarchy/__init__.py
  </files>
  <action>
    Create the Level object as a container for objects at a specific elevation with plan view capability.

    In bim/hierarchy/level.py:
    - Create Level class with unique ID, name
    - Add LevelProperties dataclass containing:
      - elevation: float (level elevation in meters, relative to site)
      - height: float (floor-to-ceiling height in meters)
      - level_number: int (for ordering, e.g., 0=ground, 1=first floor, -1=basement)
      - usage_type: str (living, office, retail, utility, etc.)
      - is_visible: bool (show/hide toggle)
      - color: Optional[tuple] (RGB for 2D plan view representation)
    - Implement objects list to store BIM object references
    - Add building_id reference to parent building
    - Add methods:
      - add_object(obj): Add BIM object to level
      - remove_object(obj_id): Remove object by ID
      - get_objects(): Return list of all objects in level
      - get_objects_by_type(type): Filter objects by type
      - get_plan_view_2d(): Generate 2D plan representation (object footprints)
      - get_bounding_box_2d(): Get 2D bounds for plan view
      - copy_objects_to(target_level, offset): Copy objects to another level with optional offset
      - set_visibility(visible): Show/hide level
    - Implement elevation validation (must be within reasonable range: -100m to 1000m)

    In bim/hierarchy/__init__.py:
    - Export Level and LevelProperties
  </action>
  <verify>
    - Import test: from bim.hierarchy import Level, LevelProperties succeeds
    - Unit test: Create Level with elevation=3.0, height=2.8, add objects
    - Verify 2D plan view generation works
    - Test object copy between levels with offset
    - Verify visibility toggle works
  </verify>
  <done>
    Level object exists with elevation/height properties, can contain objects, generates 2D plan view, and supports copy operations. All methods functional.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Hierarchy Manager for Relationship Management</name>
  <files>
    bim/hierarchy/manager.py
    bim/hierarchy/__init__.py
  </files>
  <action>
    Create the HierarchyManager to manage relationships and operations across the project hierarchy.

    In bim/hierarchy/manager.py:
    - Create HierarchyManager class as singleton or per-project instance
    - Maintain reference to active project root (Site)
    - Add current level tracking for object creation
    - Add methods:
      - create_site(name, **properties): Create and return new Site
      - create_building(site_id, name, **properties): Create building in site
      - create_level(building_id, name, elevation, **properties): Create level in building
      - delete_site(site_id): Remove site and all children
      - delete_building(building_id): Remove building and all levels
      - delete_level(level_id): Remove level and all objects
      - move_building(building_id, target_site_id): Move building between sites
      - move_level(level_id, target_building_id): Move level between buildings
      - move_object(obj_id, target_level_id): Move object between levels
      - set_current_level(level_id): Set active level for new objects
      - get_current_level(): Get currently active level
      - get_hierarchy_dict(): Export hierarchy as nested dictionary
      - validate_hierarchy(): Check for orphaned objects, invalid references
      - flatten_hierarchy(): Get flat list of all objects by type
    - Implement event system for hierarchy changes (on_add, on_remove, on_move)
    - Add undo/redo support for hierarchy operations

    In bim/hierarchy/__init__.py:
    - Export HierarchyManager
  </action>
  <verify>
    - Import test: from bim.hierarchy import HierarchyManager succeeds
    - Unit test: Create full hierarchy (Site → Building → Level), verify relationships
    - Test move operations (building between sites, level between buildings)
    - Test validation catches orphaned references
    - Verify get_hierarchy_dict returns correct nested structure
  </verify>
  <done>
    HierarchyManager manages all hierarchy operations, supports CRUD for all levels, move operations, and validation. Event system functional.
  </done>
</task>

<task type="auto">
  <name>Task 5: Create Hierarchy Tree View UI Component</name>
  <files>
    bim/ui/hierarchy_tree.py
    bim/ui/__init__.py
  </files>
  <action>
    Create the tree view UI component for visualizing and navigating the project hierarchy.

    In bim/ui/hierarchy_tree.py:
    - Create HierarchyTreeView class (Qt QTreeWidget or similar)
    - Tree structure showing: Site → Building → Level → Objects
    - Features:
      - Expand/collapse all or individual branches
      - Icons for each node type (site, building, level, object types)
      - Current level highlighting
      - Selection synchronization with 3D view
    - Implement drag-drop support:
      - Drag buildings between sites
      - Drag levels between buildings
      - Drag objects between levels
      - Visual feedback during drag (valid/invalid drop targets)
    - Add right-click context menu:
      - Add new (site/building/level/object)
      - Delete (with confirmation)
      - Rename
      - Properties
      - Show/hide toggle for levels
      - Isolate (hide others)
    - Add keyboard shortcuts:
      - Delete key: delete selected
      - F2: rename selected
      - Ctrl+Click: multi-select
    - Implement search/filter box to find nodes by name
    - Add tooltips showing key properties on hover

    In bim/ui/__init__.py:
    - Export HierarchyTreeView
  </action>
  <verify>
    - UI renders with sample hierarchy (Site → Building → Level → Objects)
    - Drag-drop operations update hierarchy correctly
    - Context menu actions functional (add, delete, rename, properties)
    - Selection changes highlight in tree and 3D view
    - Search/filter narrows tree correctly
  </verify>
  <done>
    HierarchyTreeView displays project hierarchy, supports drag-drop reorganization, context menu operations, and search/filter. UI is responsive and intuitive.
  </done>
</task>

<task type="auto">
  <name>Task 6: Create Level Management Panel UI</name>
  <files>
    bim/ui/level_panel.py
    bim/ui/__init__.py
  </files>
  <action>
    Create the LevelPanel UI for dedicated level management operations.

    In bim/ui/level_panel.py:
    - Create LevelPanel class (Qt panel/widget)
    - Display list of levels in current building
    - Show level properties in editable form:
      - Name (text input)
      - Elevation (numeric with unit display)
      - Height (numeric)
      - Level number (integer, auto-calculated or manual)
      - Usage type (dropdown)
      - Color picker for 2D view
      - Visibility toggle (checkbox)
    - Add buttons:
      - Add Level: Create new level (auto-suggest elevation based on existing)
      - Delete Level: Remove with confirmation
      - Copy Level: Duplicate with objects (optional)
      - Move Up/Down: Reorder levels
    - Implement elevation editing with validation:
      - Highlight if overlapping with other levels
      - Auto-adjust other levels option
    - Add level visibility controls:
      - Show All / Hide All buttons
      - Individual visibility checkboxes
      - Isolate selected level
    - Display level statistics:
      - Object count per level
      - Total area per level
      - Elevation range
    - Add quick navigation: Click level to set as current/active

    In bim/ui/__init__.py:
    - Export LevelPanel
  </action>
  <verify>
    - Panel displays levels with all properties editable
    - Add/Delete/Copy level operations work correctly
    - Elevation validation highlights conflicts
    - Visibility toggles affect 3D and 2D views
    - Statistics update correctly when objects change
  </verify>
  <done>
    LevelPanel provides dedicated level management UI with property editing, CRUD operations, visibility controls, and statistics. All interactions functional.
  </done>
</task>

<task type="auto">
  <name>Task 7: Update Object Creation for Level Assignment</name>
  <files>
    bim/core/object_factory.py
    bim/ui/object_creation_dialog.py
  </files>
  <action>
    Modify object creation to assign objects to the current level and show level indicators.

    In bim/core/object_factory.py:
    - Update create_object() to accept optional level_id parameter
    - If level_id not provided, use HierarchyManager.get_current_level()
    - If no current level, raise error or prompt user to create/select level
    - Add object to level's object list via level.add_object()
    - Set object's level_id and elevation properties
    - Add method: get_objects_by_level(level_id) to filter objects

    In bim/ui/object_creation_dialog.py:
    - Add level selector dropdown showing available levels
    - Pre-select current level by default
    - Show level elevation and building name in dropdown
    - Add visual indicator: "Creating in: [Level Name] @ [Elevation]m"
    - If no levels exist, show warning and button to create level first
    - Add checkbox: "Show only current level objects" in preview
    - Update preview to show level-specific context (other objects at same level)

    Additional changes:
    - Update BIMObject base class to include level_id property
    - Add get_level() method to BIMObject to retrieve parent level
    - Ensure objects moved via hierarchy tree update their elevation correctly
  </action>
  <verify>
    - Creating object assigns to current level automatically
    - Object creation dialog shows level selector with current level pre-selected
    - Objects appear in level's object list
    - get_objects_by_level returns correct filtered list
    - Moving object via hierarchy updates its level association
  </verify>
  <done>
    Object creation integrates with level system, assigns to levels automatically, and shows level context in UI. Level filtering and assignment fully functional.
  </done>
</task>

</tasks>

<verification>
## Manual Testing Steps

1. **Hierarchy Creation:**
   - Create Site: "Project Site" with lat/lon coordinates
   - Create Building: "Main Building" in site
   - Create Levels: "Ground" (0m), "Floor 1" (3m), "Floor 2" (6m)
   - Verify tree view shows: Site → Building → [3 Levels]

2. **Object Assignment:**
   - Select "Floor 1" level
   - Create Wall object
   - Verify wall appears under "Floor 1" in tree
   - Verify wall has elevation=3m

3. **Drag-Drop Reorganization:**
   - Drag wall from "Floor 1" to "Floor 2"
   - Verify wall moves in tree view
   - Verify wall elevation updates to 6m
   - Verify wall visible at new elevation in 3D view

4. **Level Visibility:**
   - Hide "Floor 1" via checkbox
   - Verify Floor 1 objects disappear from 3D view
   - Verify Floor 1 grayed out in tree view
   - Show Floor 1, verify objects reappear

5. **Copy Level:**
   - Copy "Floor 1" with objects to new "Floor 3"
   - Verify all Floor 1 objects duplicated at new elevation
   - Verify tree shows new level with copied objects

6. **Context Menu Operations:**
   - Right-click Building → Add Level
   - Right-click Level → Properties (edit name/elevation)
   - Right-click Object → Delete
   - Verify all operations work correctly

7. **Validation:**
   - Try creating level with elevation overlapping existing level
   - Verify warning shown
   - Try deleting level with objects
   - Verify confirmation dialog appears
</verification>

<success_criteria>
- [ ] Site object created with geographic properties (lat/lon, elevation, address)
- [ ] Building object created with auto-calculated bounding box and height
- [ ] Level object created with elevation, height, and 2D plan view support
- [ ] HierarchyManager manages all CRUD and move operations
- [ ] HierarchyTreeView displays tree with drag-drop and context menu
- [ ] LevelPanel provides dedicated level management with property editing
- [ ] Object creation assigns to current level and shows level context
- [ ] Objects can be moved between levels via drag-drop
- [ ] Level visibility toggles work in 3D and 2D views
- [ ] All hierarchy operations support undo/redo
- [ ] Sample project demonstrates full Site → Building → Level → Object hierarchy
</success_criteria>

<output>
After completion, create `.planning/phases/06-bim-workbench/06-12-SUMMARY.md` documenting:
- Hierarchy system architecture and class relationships
- UI components implemented (tree view, level panel)
- Usage examples for creating and managing project hierarchy
- Any design decisions or constraints
- Integration points with object creation system
</output>
